#!/bin/bash
#
# $Id: get-tools 28436 2016-08-03 19:50:05Z edo $
#

unalias -a

export NWCHEM_TOP=${NWCHEM_TOP:-"`pwd`/../"}
if test "x$NWCHEM_TOP" = x
then
    echo You must set NWCHEM_TOP to use this script.
    exit 1
fi

ga_version=0
while [ $# -gt 0 ]
do
   case "$1" in
      --ga-version) ga_version=1;;
      *)
         echo >&2 "usage: $0 [--ga-version]"
         exit 1;;
   esac
   shift 
done

TOOLDIR=`pwd`
TOOLGIT=`which git`
CONFIG=$NWCHEM_TOP/src/config/makefile.h

if test "x$DEV_GA" != x
then
    GA_DIR=ga-dev
    GA_BRANCH=develop
else
  if test "x$GA_BRANCH" != x
  then
    if test "x$GA_DIR" = x
    then
       GA_DIR=ga-"$GA_BRANCH"
    fi
  else
     GA_DIR=ga-5-6
     GA_BRANCH=release/5.6
  fi
fi
GA_GIT="https://github.com/GlobalArrays/ga.git  -b $GA_BRANCH"
echo "Using GA_GIT" $GA_GIT "and GA_DIR" $GA_DIR

if [ $ga_version == 1 ] ; then
  echo $GA_DIR
  exit 0
fi

if [ ${#TOOLGIT} -eq 0 ] ; then
  echo "No Subversion found!"
  echo "Giving up and hoping for the best..."
  exit 0
fi
if test -d $GA_DIR
then
    echo "Updating existing $GA_DIR"
    cd $GA_DIR
#    git cleanup
    if git pull 
    then
        echo "Finished updating existing $GA_DIR"
    else
        echo "Failed updating existing $GA_DIR"
        echo "Attempting to remove $GA_DIR"
        cd $TOOLDIR
        if rm -rf $GA_DIR
        then
            echo "Checking out $GA_GIT" $GA_BRANCH $GA_DIR
            git clone $GA_GIT $GA_DIR
        else
            echo "Failed to remove $GA_DIR"
            echo "get-tools has failed"
        fi
    fi
    cd $TOOLDIR
else
    echo "Checking out $GA_GIT into dir $GA_DIR"
    git clone $GA_GIT $GA_DIR
fi
# check if configure is there
if test -e $GA_DIR/configure
then
        echo "configure present. no autogen.sh required"
else
        echo "configure missing. running autogen.sh"
        pwd
        echo $GA_DIR/configure $GA_DIR/autogen.sh
        cd  $GA_DIR;sh ./autogen.sh
fi
exit 0
