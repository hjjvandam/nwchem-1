!-----------------------------------------------------------------------
!>
!> \brief Evaluate the energy
!>
!> A subroutine to evaluate the energy for a given wave function,
!>
      subroutine noft_eval_energy(noft_parameters,noft_operators,
     &                            noft_wavefunction,noft_energy)
      implicit none
      !> The parameters for the calculation
      type(noft_parameter_tp),    intent(in)    :: noft_parameters
      !> The various operators
      type(noft_operators_tp),    intent(inout) :: noft_operators
      !> The wavefunction
      type(noft_wavefunction_tp), intent(in)    :: noft_wavefunction
      !> The energy terms and total
      type(noft_energy_tp),       intent(out)   :: noft_energy
!
      integer :: g_el_1
      integer :: g_el_2
      integer :: g_out
      integer :: g_occ_a
      integer :: g_occ_aa
      integer :: g_occ_b
      integer :: g_occ_bb
      integer :: g_vec_a
      integer :: g_vec_b
      integer :: g_tilde_a
      integer :: g_tilde_b
      integer :: ne_a
      integer :: ne_b
      type(noft_occupations_tp) :: noft_occupations
!
!     Transform the 1-electron operator to MO basis
!
      g_el_1  = noft_operators%so_el_1
      g_vec_a = noft_wavefunction%mo_a
      call noft_2index(g_el_1,g_vec_a,g_out)
      call noft_replace_data(noft_operators%moa_el_1,g_out)
      g_vec_b = noft_wavefunction%mo_b
      call noft_2index(g_el_1,g_vec_b,g_out)
      call noft_replace_data(noft_operators%mob_el_1,g_out)
!
!     Transform the 2-electron operator to MO basis
!
      g_el_2 = noft_operators%so_el_2
      call noft_4index(g_el_2,g_vec_a,g_vec_a,g_out)
      call noft_replace_data(noft_operators%moaa_el_2,g_out)
      call noft_4index(g_el_2,g_vec_a,g_vec_b,g_out)
      call noft_replace_data(noft_operators%moab_el_2,g_out)
      call noft_4index(g_el_2,g_vec_b,g_vec_b,g_out)
      call noft_replace_data(noft_operators%mobb_el_2,g_out)
!
!     Calculate occupation numbers
!
      call noft_occupations_create(noft_parameters,noft_occupations)
      call noft_occupations_calculate(noft_parameters,noft_wavefunction,
     &                                noft_occupations)
!
      call noft_eval_nuc_energy(noft_parameters,noft_energy)
      call noft_eval_1e_energy(noft_parameters,noft_operators,
     &                         noft_occupations,noft_energy)
      call noft_eval_2e_energy(noft_parameters,noft_operators,
     &                         noft_occupations,noft_energy)
      call noft_eval_tot_energy(noft_energy)
!
!     Clean occupartion number up
!
      call noft_occupations_destroy(noft_occupations)
!
      end subroutine noft_eval_energy
!
!-----------------------------------------------------------------------
