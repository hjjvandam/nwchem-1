#!/bin/bash
function usage ()
{
   cat<<EOF
 autoxc - script to autogenerate Fortran code for Electron Density Functionals
          and their derivatives using Maxima

 Usage:

    $0 [-o <source-file>] <functional>.max

 The Autoxc script takes a file specifying an electron density functional 
 and invokes Maxima [1] to generate expressions for the functional itself
 and its partial derivatives up to 3rd order. Subsequently Maxima transforms
 the expressions into Fortran code. 

 The script is based on the idea published by Strange et al. [2]. However,
 the dfauto script they published requires Maple [3] which is inconvenient
 for free software projects because of the commercial licensing. Hence
 this is a complete re-implementation of the approach.

 As a little extra the file containing the functional may define two 
 special strings:
 - reference : the literature reference of the functional (default
               "unpublished")
 - doi       : the DOI of the paper (default "unpublished")
 These variables are used to add the reference and DOI to the Doxygen
 documentation of the generated source code.

 The file containing the functional may specify three different expression:
 - f : a correlation functional term
 - g : an exchange functional term
 - G : a limiting expression for the limit rho_s -> 0
 These expressions should be specified as
 - f(zeta,rho_a,rho_b,rho,sigma_aa,sigma_ab,sigma_bb,sigma,tau_a,tau_b,tau)
 - g(rho_s,sigma_ss,tau_s)
 - G(rho_s,sigma_ss,tau_s)
 The script will substitute
 - rho   = rho_a + rho_b
 - zeta  = (rho_a - rho_b) / rho
 - sigma = sigma_aa + 2 * sigma_ab + sigma_bb
 - tau   = tau_a + tau_b
 Given this information the total functional is defined as:

   When rho_a and rho_b > 0.0d0

     - K = sum(s=(a,b),g(rho_s,sigma_ss,tau_s))
         + f(zeta,rho_a,rho_b,rho,sigma_aa,sigma_ab,sigma_bb,sigma,
             tau_a,tau_b,tau)

   when rho_a > 0.0d0 and rho_b = 0.0d0 and G defined

     - K = g(rho_a,sigma_aa,tau_a)
         + G(rho_a,sigma_aa,tau_a)
 
   when rho_a = 0.0d0 and rho_b > 0.0d0 and G defined

     - K = g(rho_b,sigma_bb,tau_b)
         + G(rho_b,sigma_bb,tau_b)

 
 [1] "Maxima, a Computer Algebra System", Version 5.27.0,
     http://maxima.sourceforge.net/

 [2] R. Strange, F.R. Manby, P.J. Knowles,
     "Automatic code generation in density functional theory",
     Comp. Phys. Commun. 136 (2001) 310,
     DOI: 10.1016/S0010-4655(01)00148-5

 [3] M.B. Monagan, K.O. Geddes, K.M. Heal, G. Labahn, S.M. Vorkoetter,
     J. McCarron, P. DeMarco,
     "Maple 10 Programming Guide",
     Maplesoft, Waterloo ON, Canada, 2005.

$Id $
EOF
}
#
# Variables in this script
# ------------------------
#
# The input file containing the DFT functional specification as a
# Maxima expression
#
inputfile=""
#
# The output file where the source code is written to
#
outputfile=""
#
# The name of the density functional
#
functional_name=""
#
# The intermediate density functional representation file that tells Maxima to
# be relatively quiet
#
f_quiet=""
#
# In the Maxima definitions we will use:
# - f : the correlation part of the functional
# - g : the exchange part of the functional
# - G : the limit of the correlation functional when one of the alpha or beta
#       densities goes to 0 (this expression has an exchange like form)
#
# From the above definitions we will derive:
# - excess      : Is there a special definition for when there is an excess of
#                 alpha- or beta-electron density, i.e. is there a definition
#                 of G?
# - rho_deriv   : Is the functional density dependent?
# - sigma_deriv : Is the functional density gradient dependent?
# - tau_deriv   : Is the functional kinetic energy density dependent?
#
excess=false
rho_deriv=false
sigma_deriv=false
tau_deriv=false
#
# Check the command line
# ----------------------
#
# Are there a reasonable number of arguments?
#
if [ $# -lt 1 ] ; then
  usage
  exit 1
elif [ $# -gt 3 ] ; then
  usage
  exit 1
fi
#
# Go through argument list and pick up the outputfile (optional)
# and the inputfile (required)
#
while getopts "o:" arg ; do
    case $arg in
    o)  outputfile="$OPTARG" ;;
    esac
done
shift $((OPTIND - 1))
inputfile="$1"
#
# If no outputfile was specified generate the outputfile from the inputfile
# by replacing the .max extension with .F
#
if [ "x$outputfile" == "x" ] ; then
  outputfile=`echo "$inputfile" | sed 's/\.max/.F/'`
fi
#
# Work out a sensible name for the functional:
# - Start with the filename without extension
# - Replace "-" and "+" with "_"
# - Maybe do other things but we will see what creative ideas people come up
#   with
functional_name=${inputfile%.max}
functional_name=`echo "$functional_name" | sed -e 's/-/_/' -e 's/+/_/'`
#
# Normally Maxima will print everything it is doing. This behavior can be 
# suppressed by terminating the lines with $-signs instead of ;-signs.
# Hence create an intermediate Maxima specification of the functional that
# suppresses all the printing.
#
f_quiet=${TMPDIR:-/tmp}/fnc_intermediate.$$
sed -e 's/ *$//' -e 's/;$/$/' $inputfile > $f_quiet
#
# Write Maxima code to analyze the functional given
#
# Analyze the functional definition we have been given. We want to know whether
# f, g, and/or G are present. The presence of G requires additional source
# code to be generated for when one of the alpha or beta density is 0.
#
f_maxima=${TMPDIR:-/tmp}/fnc_maxima.$$
f_dependency=${TMPDIR:-/tmp}/fnc_dependency.$$.out
f_dependency_sh=${TMPDIR:-/tmp}/fnc_dependency.$$.sh
cat <<EOF > $f_maxima
reference: "unpublished"$
doi: "unpublished"$
f(zeta,rho_a,rho_b,rho,sigma_aa,sigma_ab,sigma_bb,sigma,tau_a,tau_b,tau):=0$
g(rho_s,sigma_ss,tau_s):=0$
G(rho_s,sigma_ss,tau_s):=0$
functional(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b):=0$
EOF
cat $f_quiet >> $f_maxima
cat <<EOF >> $f_maxima
functional(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b):=  
    f((rho_a-rho_b)/(rho_a+rho_b),rho_a,rho_b,rho_a+rho_b,        
      sigma_aa,sigma_ab,sigma_bb,sigma_aa+2*sigma_ab+sigma_bb,    
      tau_a,tau_b,tau_a+tau_b)                                    
  + g(rho_a,sigma_aa,tau_a) + g(rho_b,sigma_bb,tau_b)             
  + G(rho_a,sigma_aa,tau_a) + G(rho_b,sigma_bb,tau_b)$
rho_deriv:is (diff(functional(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,
                              tau_a,tau_b),rho_a)#0 or
              diff(functional(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,
                              tau_a,tau_b),rho_b)#0)$
sigma_deriv:is (diff(functional(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,
                                tau_a,tau_b),sigma_aa)#0 or
                diff(functional(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,
                                tau_a,tau_b),sigma_ab)#0 or  
                diff(functional(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,
                                tau_a,tau_b),sigma_bb)#0)$
tau_deriv:is (diff(functional(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,
                              tau_a,tau_b),tau_a)#0 or
              diff(functional(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,
                              tau_a,tau_b),tau_b)#0)$
sums : 0$
if (f((rho_a-rho_b)/(rho_a+rho_b),rho_a,rho_b,rho_a+rho_b,        
      sigma_aa,sigma_ab,sigma_bb,sigma_aa+2*sigma_ab+sigma_bb,    
      tau_a,tau_b,tau_a+tau_b)#0) then
  sums : sums + 1$
if (g(rho_a,sigma_aa,tau_a)#0) then
  sums : sums + 1$
if (G(rho_a,sigma_aa,tau_a)#0) then
  sums : sums + 1$
excess: is (G(rho_a,sigma_aa,tau_a)#0)$

with_stdout("$f_dependency",        
   print("sums=",sums),      
   print("excess=",excess),      
   print("rho_deriv=",rho_deriv),      
   print("sigma_deriv=",sigma_deriv),  
   print("tau_deriv=",tau_deriv),
   print("reference=\"",reference,"\""),
   print("doi=\"",doi,"\""))$
/* printfile("$f_dependency"); */
EOF
maxima -b $f_maxima
sed -e "s/ //" $f_dependency > $f_dependency_sh
source $f_dependency_sh
if [ $sums = 0 ] ; then
    echo "No functional definition in $inputfile"
    echo "Bombing"
    exit 10
fi
#
# Now we know:
#
# - whether the functional depends on the density
# - whether the functional depends on the gradient of the density
# - whether the functional depends on the kinetic energy density
# - whether the functional has a special limiting case for densities tending
#   to zero
#
# So, now we do the real thing:
#
# - Initialize all the expressions f, g, and G
# - Pick up the functional specification
# - Work out the derivative expressions
# - Generate the Fortran (currently compiler support many more continuation
#   lines, hopefully it is enough...)
# 
cat <<EOF > $f_maxima
f(zeta,rho_a,rho_b,rho,sigma_aa,sigma_ab,sigma_bb,sigma,tau_a,tau_b,tau):=0$
g(rho_s,sigma_ss,tau_s):=0$
G(rho_s,sigma_ss,tau_s):=0$
/* Func is the functional for the regular case: f(a,b) + g(a) + g(b).
   I.e. both spin channels have non-zero density. */
func(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b):=0$
/* Funcs is the functional for one spin channel assuming that the density
   in the other spin channel vanishes: g(s) + G(s). */
funcs(rho_s,sigma_ss,tau_s):=0$
EOF
cat $f_quiet >> $f_maxima
cat <<EOF >> $f_maxima
excess:$excess\$
rho_deriv:$rho_deriv\$
sigma_deriv:$sigma_deriv\$
tau_deriv:$tau_deriv\$
EOF
cat <<EOF >> $f_maxima
func(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b):=
   wght*(f((rho_a-rho_b)/(rho_a+rho_b),rho_a,rho_b,rho_a+rho_b,
           sigma_aa,sigma_ab,sigma_bb,sigma_aa+2*sigma_ab+sigma_bb,
           tau_a,tau_b,tau_a+tau_b)
       + g(rho_a,sigma_aa,tau_a) + g(rho_b,sigma_bb,tau_b))$
if excess then
   funcs(rho_s,sigma_ss,tau_s):=
      wght*(g(rho_s,sigma_ss,tau_s) + G(rho_s,sigma_ss,tau_s))
else
   funcs(rho_s,sigma_ss,tau_s):=
      wght*(g(rho_s,sigma_ss,tau_s) + f(1,rho_s,0,rho_s,sigma_ss,0,0,sigma_ss,tau_s,0,tau_s))$

/* 1st order derivatives */
/* Alpha and Beta spin channel */

df1ra(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(func(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),rho_a)$
df1rb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(func(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),rho_b)$
df1gaa(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(func(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_aa)$
df1gab(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(func(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_ab)$
df1gbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(func(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_bb)$
df1ta(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(func(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_a)$
df1tb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(func(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$

/* One spin channel */

dfs1rs(rho_s,sigma_ss,tau_s)
:=diff(funcs(rho_s,sigma_ss,tau_s),rho_s)$
dfs1gss(rho_s,sigma_ss,tau_s)
:=diff(funcs(rho_s,sigma_ss,tau_s),sigma_ss)$
dfs1ts(rho_s,sigma_ss,tau_s)
:=diff(funcs(rho_s,sigma_ss,tau_s),tau_s)$

/* 2nd order derivatives */
/* Alpha and Beta spin channel */
/* Rho Rho */

df2rara(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df1ra(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),rho_a)$
df2rarb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df1ra(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),rho_b)$
df2rbrb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df1rb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),rho_b)$

/* Rho Sigma */
df2ragaa(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df1ra(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_aa)$
df2ragab(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df1ra(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_ab)$
df2ragbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df1ra(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_bb)$
df2rbgaa(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df1rb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_aa)$
df2rbgab(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df1rb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_ab)$
df2rbgbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df1rb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_bb)$

/* Rho Tau */

df2rata(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df1ra(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_a)$
df2ratb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df1ra(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$
df2rbta(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df1rb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_a)$
df2rbtb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df1rb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$

/* Sigma Sigma */

df2gaagaa(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df1gaa(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_aa)$
df2gaagab(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df1gaa(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_ab)$
df2gaagbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df1gaa(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_bb)$
df2gabgab(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df1gab(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_ab)$
df2gabgbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df1gab(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_bb)$
df2gbbgbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df1gbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_bb)$

/* Sigma Tau */

df2gaata(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df1gaa(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_a)$
df2gaatb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df1gaa(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$
df2gabta(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df1gab(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_a)$
df2gabtb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df1gab(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$
df2gbbta(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df1gbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_a)$
df2gbbtb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df1gbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$

/* Tau Tau */

df2tata(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df1ta(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_a)$
df2tatb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df1ta(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$
df2tbtb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df1tb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$

/* 2nd order derivatives */
/* One spin channel */

dfs2rsrs(rho_s,sigma_ss,tau_s)
:=diff(dfs1rs(rho_s,sigma_ss,tau_s),rho_s)$
dfs2rsgss(rho_s,sigma_ss,tau_s)
:=diff(dfs1rs(rho_s,sigma_ss,tau_s),sigma_ss)$
dfs2rsts(rho_s,sigma_ss,tau_s)
:=diff(dfs1rs(rho_s,sigma_ss,tau_s),tau_s)$
dfs2gssgss(rho_s,sigma_ss,tau_s)
:=diff(dfs1gss(rho_s,sigma_ss,tau_s),sigma_ss)$
dfs2gssts(rho_s,sigma_ss,tau_s)
:=diff(dfs1gss(rho_s,sigma_ss,tau_s),tau_s)$
dfs2tsts(rho_s,sigma_ss,tau_s)
:=diff(dfs1ts(rho_s,sigma_ss,tau_s),tau_s)$

/* 3rd order derivatives */
/* Alpha and Beta spin channel */
/* Rho Rho Rho */

df3rarara(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2rara(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),rho_a)$
df3rararb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2rara(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),rho_b)$
df3rarbrb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2rarb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),rho_b)$
df3rbrbrb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2rbrb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),rho_b)$

/* Rho Rho Sigma */

df3raragaa(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2rara(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_aa)$
df3raragab(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2rara(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_ab)$
df3raragbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2rara(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_bb)$
df3rarbgaa(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2rarb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_aa)$
df3rarbgab(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2rarb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_ab)$
df3rarbgbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2rarb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_bb)$
df3rbrbgaa(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2rbrb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_aa)$
df3rbrbgab(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2rbrb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_ab)$
df3rbrbgbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2rbrb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_bb)$

/* Rho Rho Tau */

df3rarata(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2rara(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_a)$
df3raratb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2rara(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$
df3rarbta(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2rarb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_a)$
df3rarbtb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2rarb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$
df3rbrbta(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2rbrb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_a)$
df3rbrbtb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2rbrb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$

/* Rho Sigma Sigma */

df3ragaagaa(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2ragaa(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_aa)$
df3ragaagab(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2ragaa(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_ab)$
df3ragaagbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2ragaa(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_bb)$
df3ragabgab(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2ragab(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_ab)$
df3ragabgbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2ragab(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_bb)$
df3ragbbgbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2ragbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_bb)$

/* Rho Sigma Tau */

df3ragaata(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2ragaa(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_a)$
df3ragaatb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2ragaa(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$
df3ragabta(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2ragab(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_a)$
df3ragabtb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2ragab(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$
df3ragbbta(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2ragbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_a)$
df3ragbbtb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2ragbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$
df3rbgaata(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2rbgaa(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_a)$
df3rbgaatb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2rbgaa(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$
df3rbgabta(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2rbgab(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_a)$
df3rbgabtb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2rbgab(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$
df3rbgbbta(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2rbgbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_a)$
df3rbgbbtb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2rbgbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$

/* Rho Tau Tau */

df3ratata(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2rata(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_a)$
df3ratatb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2rata(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$
df3ratbtb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2ratb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$
df3rbtata(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2rbta(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_a)$
df3rbtatb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2rbta(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$
df3rbtbtb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2rbtb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$

/* Sigma Sigma Sigma */

df3gaagaagaa(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2gaagaa(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_aa)$
df3gaagaagab(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2gaagaa(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_ab)$
df3gaagaagbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2gaagaa(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_bb)$
df3gaagabgab(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2gaagab(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_ab)$
df3gaagabgbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2gaagab(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_bb)$
df3gaagbbgbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2gaagbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_bb)$
df3gabgabgab(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2gabgab(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_ab)$
df3gabgabgbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2gabgab(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_bb)$
df3gabgbbgbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2gabgbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_bb)$
df3gbbgbbgbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2gbbgbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),sigma_bb)$

/* Sigma Sigma Tau */

df3gaagaata(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2gaagaa(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_a)$
df3gaagaatb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2gaagaa(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$
df3gaagabta(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2gaagab(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_a)$
df3gaagabtb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2gaagab(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$
df3gaagbbta(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2gaagbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_a)$
df3gaagbbtb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2gaagbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$
df3gabgabta(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2gabgab(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_a)$
df3gabgabtb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2gabgab(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$
df3gabgbbta(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2gabgbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_a)$
df3gabgbbtb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2gabgbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$
df3gbbgbbta(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2gbbgbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_a)$
df3gbbgbbtb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2gbbgbb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$

/* Sigma Tau Tau */

df3gaatata(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2gaata(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_a)$
df3gaatatb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2gaata(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$
df3gaatbtb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2gaatb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$
df3gabtata(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2gabta(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_a)$
df3gabtatb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2gabta(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$
df3gabtbtb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2gabtb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$
df3gbbtata(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2gbbta(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_a)$
df3gbbtatb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2gbbta(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$
df3gbbtbtb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2gbbtb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$

/* Tau Tau Tau */

df3tatata(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2tata(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_a)$
df3tatatb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2tata(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$
df3tatbtb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2tatb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$
df3tbtbtb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b)
:=diff(df2tbtb(rho_a,rho_b,sigma_aa,sigma_ab,sigma_bb,tau_a,tau_b),tau_b)$

/* 3rd order derivatives */
/* One spin channel */

dfs3rsrsrs(rho_s,sigma_ss,tau_s)
:=diff(dfs2rsrs(rho_s,sigma_ss,tau_s),rho_s)$
dfs3rsrsgss(rho_s,sigma_ss,tau_s)
:=diff(dfs2rsrs(rho_s,sigma_ss,tau_s),sigma_ss)$
dfs3rsrsts(rho_s,sigma_ss,tau_s)
:=diff(dfs2rsrs(rho_s,sigma_ss,tau_s),tau_s)$
dfs3rsgssgss(rho_s,sigma_ss,tau_s)
:=diff(dfs2rsgss(rho_s,sigma_ss,tau_s),sigma_ss)$
dfs3rsgssts(rho_s,sigma_ss,tau_s)
:=diff(dfs2rsgss(rho_s,sigma_ss,tau_s),tau_s)$
dfs3rststs(rho_s,sigma_ss,tau_s)
:=diff(dfs2rsts(rho_s,sigma_ss,tau_s),tau_s)$
dfs3gssgssgss(rho_s,sigma_ss,tau_s)
:=diff(dfs2gssgss(rho_s,sigma_ss,tau_s),sigma_ss)$
dfs3gssgssts(rho_s,sigma_ss,tau_s)
:=diff(dfs2gssgss(rho_s,sigma_ss,tau_s),tau_s)$
dfs3gsststs(rho_s,sigma_ss,tau_s)
:=diff(dfs2gssts(rho_s,sigma_ss,tau_s),tau_s)$
dfs3tststs(rho_s,sigma_ss,tau_s)
:=diff(dfs2tsts(rho_s,sigma_ss,tau_s),tau_s)$

fortindent: 6$
/* if excess then */
  if rho_deriv then
    if sigma_deriv then
      if tau_deriv then
        with_stdout("$outputfile",
          print("#if !defined(SECOND_DERIV) && !defined(THIRD_DERIV)"),
          print("C> \\\\ingroup nwxc"),
          print("C> @{"),
          print("C>"),
          print("C> \\\\file $outputfile"),
          print("C> The $functional_name functional"),
          print("C>"),
          print("C> @}"),
          print("#endif"),
          print("C> \\\\ingroup nwxc_priv"),
          print("C> @{"),
          print("C>"),
          print("C> \\\\brief Evaluate the $functional_name functional [1]"),
          print("C>"),
          print("C> ### References ###"),
          print("C>"),
          print("C> [1] $reference, DOI:"),
          print("C> <a href=\"http://dx.doi.org/$doi\">"),
          print("C> $doi</a>"),
          print("C>"),
          print("#if !defined(SECOND_DERIV) && !defined(THIRD_DERIV)"),
          print("      subroutine nwxc_${functional_name}(param,tol_rho,ipol,nq,wght,"),
          print("     +rho,rgamma,tau,fnc,Amat,Cmat,Mmat)"),
          print("#elif defined(SECOND_DERIV) && !defined(THIRD_DERIV)"),
          print("      subroutine nwxc_${functional_name}_d2(param,tol_rho,ipol,nq,wght,"),
          print("     +rho,rgamma,tau,fnc,Amat,Amat2,Cmat,Cmat2,Mmat,Mmat2)"),
          print("#elif defined(SECOND_DERIV) && defined(THIRD_DERIV)"),
          print("      subroutine nwxc_${functional_name}_d3(param,tol_rho,ipol,nq,wght,"),
          print("     +rho,rgamma,tau,fnc,Amat,Amat2,Amat3,"),
          print("     +Cmat,Cmat2,Cmat3,Mmat,Mmat2,Mmat3)"),
          print("#endif"),
          print("c \$Id \$"),
          print("      implicit double precision (a-h,o-z), integer (i-n)"),
          print("#include \"nwxc_param.fh\""),
          print("      double precision param(*)     !< [Input] Parameters of functional"),
          print("      double precision tol_rho      !< [Input] The lower limit on the density"),
          print("      integer ipol                  !< [Input] The number of spin channels"),
          print("      integer nq                    !< [Input] The number of points"),
          print("      double precision wght         !< [Input] The weight of the functional"),
          print("      double precision rho(nq,*)    !< [Input] The density"),
          print("      double precision rgamma(nq,*) !< [Input] The norm of the density"),
          print("                                    !< gradients"),
          print("      double precision tau(nq,*)    !< [Input] The kinetic energy density"),
          print("      double precision fnc(nq)      !< [Output] The value of the functional"),
          print("c"),
          print("c     Sampling Matrices for the XC Kernel"),
          print("c"),
          print("      double precision Amat(nq,*)   !< [Output] The derivative wrt rho"),
          print("      double precision Cmat(nq,*)   !< [Output] The derivative wrt rgamma"),
          print("      double precision Mmat(nq,*)   !< [Output] The derivative wrt tau"),
          print("#if defined(SECOND_DERIV) || defined(THIRD_DERIV)"),
          print("c"),
          print("c     Sampling Matrices for the XC Kernel"),
          print("c"),
          print("      double precision Amat2(nq,*)  !< [Output] The 2nd derivative wrt rho"),
          print("      double precision Cmat2(nq,*)  !< [Output] The 2nd derivative wrt rgamma"),
          print("                                    !< and possibly rho"),
          print("      double precision Mmat2(nq,*)  !< [Output] The 2nd derivative wrt tau"),
          print("                                    !< and possibly rho"),
          print("#endif"),
          print("#if defined(THIRD_DERIV)"),
          print("c"),
          print("c     Sampling Matrices for the XC Kernel"),
          print("c"),
          print("      double precision Amat3(nq,*)  !< [Output] The 3rd derivative wrt rho"),
          print("      double precision Cmat3(nq,*)  !< [Output] The 3rd derivative wrt rgamma"),
          print("                                    !< and possibly rho"),
          print("      double precision Mmat3(nq,*)  !< [Output] The 3rd derivative wrt tau"),
          print("                                    !< and possibly rho"),
          print("#endif"),
          print("      integer iq"),
          print("      double precision tmp"),
          print("      double precision rhoa,rhob"),
          print("      double precision gammaaa,gammaab,gammabb"),
          print("      double precision taua,taub"),
          print("      do iq = 1, nq"),
          print("        if (ipol.eq.1) then"),
          print("          rhoa    = 0.5d0*rho(iq,R_T)"),
          print("          gammaaa = 0.25d0*rgamma(iq,G_TT)"),
          print("          taua    = 0.5d0*tau(iq,T_T)"),
          print("          if (rhoa.gt.tol_rho) then"),
          fortran(fnc(iq) = fnc(iq) + func(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          fortran(Amat(iq,D1_RA) = Amat(iq,D1_RA) + df1ra(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          fortran(Cmat(iq,D1_GAA) = Cmat(iq,D1_GAA) + df1gaa(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          fortran(Mmat(iq,D1_TA) = Mmat(iq,D1_TA) + df1ta(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          print("#if defined(SECOND_DERIV) || defined(THIRD_DERIV)"),
          fortran(Amat2(iq,D2_RA_RA) = Amat2(iq,D2_RA_RA) + df2rara(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          fortran(Cmat2(iq,D2_RA_GAA) = Cmat2(iq,D2_RA_GAA) + df2ragaa(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          fortran(Cmat2(iq,D2_GAA_GAA) = Cmat2(iq,D2_GAA_GAA) + df2gaagaa(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          fortran(Mmat2(iq,D2_RA_TA) = Mmat2(iq,D2_RA_TA) + df2rata(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          fortran(Mmat2(iq,D2_GAA_TA) = Mmat2(iq,D2_GAA_TA) + df2gaata(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          fortran(Mmat2(iq,D2_TA_TA) = Mmat2(iq,D2_TA_TA) + df2tata(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          print("#endif"),
          print("#if defined(THIRD_DERIV)"),
          fortran(Amat3(iq,D3_RA_RA_RA) = Amat3(iq,D3_RA_RA_RA) + df3rarara(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          fortran(Cmat3(iq,D3_RA_RA_GAA) = Cmat3(iq,D3_RA_RA_GAA) + df3raragaa(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          fortran(Cmat3(iq,D3_RA_GAA_GAA) = Cmat3(iq,D3_RA_GAA_GAA) + df3ragaagaa(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          fortran(Cmat3(iq,D3_GAA_GAA_GAA) = Cmat3(iq,D3_GAA_GAA_GAA) + df3gaagaagaa(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          fortran(Mmat3(iq,D3_RA_RA_TA) = Mmat3(iq,D3_RA_RA_TA) + df3rarata(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          fortran(Mmat3(iq,D3_RA_GAA_TA) = Mmat3(iq,D3_RA_GAA_TA) + df3ragaata(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          fortran(Mmat3(iq,D3_GAA_GAA_TA) = Mmat3(iq,D3_GAA_GAA_TA) + df3gaagaata(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          fortran(Mmat3(iq,D3_RA_TA_TA) = Mmat3(iq,D3_RA_TA_TA) + df3ratata(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          fortran(Mmat3(iq,D3_GAA_TA_TA) = Mmat3(iq,D3_GAA_TA_TA) + df3gaatata(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          fortran(Mmat3(iq,D3_TA_TA_TA) = Mmat3(iq,D3_TA_TA_TA) + df3tatata(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          print("#endif"),
          print("          endif ! rhoa.gt.tol_rho"),
          print("        else  ! ipol.eq.1"),
          print("          rhoa    = rho(iq,R_A)"),
          print("          rhob    = rho(iq,R_B)"),
          print("          gammaaa = rgamma(iq,G_AA)"),
          print("          gammaab = rgamma(iq,G_AB)"),
          print("          gammabb = rgamma(iq,G_BB)"),
          print("          taua    = tau(iq,T_A)"),
          print("          taub    = tau(iq,T_B)"),
          print("          if (rhoa.gt.tol_rho.and.rhob.gt.tol_rho) then"),
          fortran(fnc(iq) = fnc(iq) + func(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Amat(iq,D1_RA) = Amat(iq,D1_RA) + df1ra(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Amat(iq,D1_RB) = Amat(iq,D1_RB) + df1rb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat(iq,D1_GAA) = Cmat(iq,D1_GAA) + df1gaa(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat(iq,D1_GAB) = Cmat(iq,D1_GAB) + df1gab(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat(iq,D1_GBB) = Cmat(iq,D1_GBB) + df1gbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat(iq,D1_TA) = Mmat(iq,D1_TA) + df1ta(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat(iq,D1_TB) = Mmat(iq,D1_TB) + df1tb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          print("#if defined(SECOND_DERIV) || defined(THIRD_DERIV)"),
          fortran(Amat2(iq,D2_RA_RA) = Amat2(iq,D2_RA_RA) + df2rara(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Amat2(iq,D2_RA_RB) = Amat2(iq,D2_RA_RB) + df2rarb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Amat2(iq,D2_RB_RB) = Amat2(iq,D2_RB_RB) + df2rbrb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat2(iq,D2_RA_GAA) = Cmat2(iq,D2_RA_GAA) + df2ragaa(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat2(iq,D2_RA_GAB) = Cmat2(iq,D2_RA_GAB) + df2ragab(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat2(iq,D2_RA_GBB) = Cmat2(iq,D2_RA_GBB) + df2ragbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat2(iq,D2_RB_GAA) = Cmat2(iq,D2_RB_GAA) + df2rbgaa(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat2(iq,D2_RB_GAB) = Cmat2(iq,D2_RB_GAB) + df2rbgab(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat2(iq,D2_RB_GBB) = Cmat2(iq,D2_RB_GBB) + df2rbgbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat2(iq,D2_GAA_GAA) = Cmat2(iq,D2_GAA_GAA) + df2gaagaa(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat2(iq,D2_GAA_GAB) = Cmat2(iq,D2_GAA_GAB) + df2gaagab(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat2(iq,D2_GAA_GBB) = Cmat2(iq,D2_GAA_GBB) + df2gaagbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat2(iq,D2_GAB_GAB) = Cmat2(iq,D2_GAB_GAB) + df2gabgab(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat2(iq,D2_GAB_GBB) = Cmat2(iq,D2_GAB_GBB) + df2gabgbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat2(iq,D2_GBB_GBB) = Cmat2(iq,D2_GBB_GBB) + df2gbbgbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat2(iq,D2_RA_TA) = Mmat2(iq,D2_RA_TA) + df2rata(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat2(iq,D2_RA_TB) = Mmat2(iq,D2_RA_TB) + df2ratb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat2(iq,D2_RB_TA) = Mmat2(iq,D2_RB_TA) + df2rbta(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat2(iq,D2_RB_TB) = Mmat2(iq,D2_RB_TB) + df2rbtb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat2(iq,D2_GAA_TA) = Mmat2(iq,D2_GAA_TA) + df2gaata(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat2(iq,D2_GAA_TB) = Mmat2(iq,D2_GAA_TB) + df2gaatb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat2(iq,D2_GAB_TA) = Mmat2(iq,D2_GAB_TA) + df2gabta(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat2(iq,D2_GAB_TB) = Mmat2(iq,D2_GAB_TB) + df2gabtb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat2(iq,D2_GBB_TA) = Mmat2(iq,D2_GBB_TA) + df2gbbta(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat2(iq,D2_GBB_TB) = Mmat2(iq,D2_GBB_TB) + df2gbbtb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat2(iq,D2_TA_TA) = Mmat2(iq,D2_TA_TA) + df2tata(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat2(iq,D2_TA_TB) = Mmat2(iq,D2_TA_TB) + df2tatb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat2(iq,D2_TB_TB) = Mmat2(iq,D2_TB_TB) + df2tbtb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          print("#endif"),
          print("#if defined(THIRD_DERIV)"),
          fortran(Amat3(iq,D3_RA_RA_RA) = Amat3(iq,D3_RA_RA_RA) + df3rarara(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Amat3(iq,D3_RA_RA_RB) = Amat3(iq,D3_RA_RA_RB) + df3rararb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Amat3(iq,D3_RA_RB_RB) = Amat3(iq,D3_RA_RB_RB) + df3rarbrb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Amat3(iq,D3_RB_RB_RB) = Amat3(iq,D3_RB_RB_RB) + df3rbrbrb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RA_RA_GAA) = Cmat3(iq,D3_RA_RA_GAA) + df3raragaa(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RA_RA_GAB) = Cmat3(iq,D3_RA_RA_GAB) + df3raragab(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RA_RA_GBB) = Cmat3(iq,D3_RA_RA_GBB) + df3raragbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RA_RB_GAA) = Cmat3(iq,D3_RA_RB_GAA) + df3rarbgaa(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RA_RB_GAB) = Cmat3(iq,D3_RA_RB_GAB) + df3rarbgab(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RA_RB_GBB) = Cmat3(iq,D3_RA_RB_GBB) + df3rarbgbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RB_RB_GAA) = Cmat3(iq,D3_RB_RB_GAA) + df3rbrbgaa(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RB_RB_GAB) = Cmat3(iq,D3_RB_RB_GAB) + df3rbrbgab(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RB_RB_GBB) = Cmat3(iq,D3_RB_RB_GBB) + df3rbrbgbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RA_GAA_GAA) = Cmat3(iq,D3_RA_GAA_GAA) + df3ragaagaa(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RA_GAA_GAB) = Cmat3(iq,D3_RA_GAA_GAB) + df3ragaagab(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RA_GAA_GBB) = Cmat3(iq,D3_RA_GAA_GBB) + df3ragaagbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RA_GAB_GAB) = Cmat3(iq,D3_RA_GAB_GAB) + df3ragabgab(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RA_GAB_GBB) = Cmat3(iq,D3_RA_GAB_GBB) + df3ragabgbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RA_GBB_GBB) = Cmat3(iq,D3_RA_GBB_GBB) + df3ragbbgbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RB_GAA_GAA) = Cmat3(iq,D3_RB_GAA_GAA) + df3rbgaagaa(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RB_GAA_GAB) = Cmat3(iq,D3_RB_GAA_GAB) + df3rbgaagab(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RB_GAA_GBB) = Cmat3(iq,D3_RB_GAA_GBB) + df3rbgaagbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RB_GAB_GAB) = Cmat3(iq,D3_RB_GAB_GAB) + df3rbgabgab(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RB_GAB_GBB) = Cmat3(iq,D3_RB_GAB_GBB) + df3rbgabgbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RB_GBB_GBB) = Cmat3(iq,D3_RB_GBB_GBB) + df3rbgbbgbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_GAA_GAA_GAA) = Cmat3(iq,D3_GAA_GAA_GAA) + df3gaagaagaa(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_GAA_GAA_GAB) = Cmat3(iq,D3_GAA_GAA_GAB) + df3gaagaagab(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_GAA_GAA_GBB) = Cmat3(iq,D3_GAA_GAA_GBB) + df3gaagaagbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_GAA_GAB_GAB) = Cmat3(iq,D3_GAA_GAB_GAB) + df3gaagabgab(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_GAA_GAB_GBB) = Cmat3(iq,D3_GAA_GAB_GBB) + df3gaagabgbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_GAA_GBB_GBB) = Cmat3(iq,D3_GAA_GBB_GBB) + df3gaagbbgbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_GAB_GAB_GAB) = Cmat3(iq,D3_GAB_GAB_GAB) + df3gabgabgab(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_GAB_GAB_GBB) = Cmat3(iq,D3_GAB_GAB_GBB) + df3gabgabgbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_GAB_GBB_GBB) = Cmat3(iq,D3_GAB_GBB_GBB) + df3gabgbbgbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_GBB_GBB_GBB) = Cmat3(iq,D3_GBB_GBB_GBB) + df3gbbgbbgbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RA_RA_TA) = Mmat3(iq,D3_RA_RA_TA) + df3rarata(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RA_RA_TB) = Mmat3(iq,D3_RA_RA_TB) + df3raratb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RA_RB_TA) = Mmat3(iq,D3_RA_RB_TA) + df3rarbta(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RA_RB_TB) = Mmat3(iq,D3_RA_RB_TB) + df3rarbtb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RB_RB_TA) = Mmat3(iq,D3_RB_RB_TA) + df3rbrbta(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RB_RB_TB) = Mmat3(iq,D3_RB_RB_TB) + df3rbrbtb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RA_GAA_TA) = Mmat3(iq,D3_RA_GAA_TA) + df3ragaata(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RA_GAA_TB) = Mmat3(iq,D3_RA_GAA_TB) + df3ragaatb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RA_GAB_TA) = Mmat3(iq,D3_RA_GAB_TA) + df3ragabta(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RA_GAB_TB) = Mmat3(iq,D3_RA_GAB_TB) + df3ragabtb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RA_GBB_TA) = Mmat3(iq,D3_RA_GBB_TA) + df3ragbbta(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RA_GBB_TB) = Mmat3(iq,D3_RA_GBB_TB) + df3ragbbtb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RB_GAA_TA) = Mmat3(iq,D3_RB_GAA_TA) + df3rbgaata(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RB_GAA_TB) = Mmat3(iq,D3_RB_GAA_TB) + df3rbgaatb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RB_GAB_TA) = Mmat3(iq,D3_RB_GAB_TA) + df3rbgabta(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RB_GAB_TB) = Mmat3(iq,D3_RB_GAB_TB) + df3rbgabtb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RB_GBB_TA) = Mmat3(iq,D3_RB_GBB_TA) + df3rbgbbta(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RB_GBB_TB) = Mmat3(iq,D3_RB_GBB_TB) + df3rbgbbtb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RA_TA_TA) = Mmat3(iq,D3_RA_TA_TA) + df3ratata(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RA_TA_TB) = Mmat3(iq,D3_RA_TA_TB) + df3ratatb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RA_TB_TB) = Mmat3(iq,D3_RA_TB_TB) + df3ratbtb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RB_TA_TA) = Mmat3(iq,D3_RB_TA_TA) + df3rbtata(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RB_TA_TB) = Mmat3(iq,D3_RB_TA_TB) + df3rbtatb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RB_TB_TB) = Mmat3(iq,D3_RB_TB_TB) + df3rbtbtb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_GAA_GAA_TA) = Mmat3(iq,D3_GAA_GAA_TA) + df3gaagaata(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_GAA_GAA_TB) = Mmat3(iq,D3_GAA_GAA_TB) + df3gaagaatb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_GAA_GAB_TA) = Mmat3(iq,D3_GAA_GAB_TA) + df3gaagabta(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_GAA_GAB_TB) = Mmat3(iq,D3_GAA_GAB_TB) + df3gaagabtb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_GAA_GBB_TA) = Mmat3(iq,D3_GAA_GBB_TA) + df3gaagbbta(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_GAA_GBB_TB) = Mmat3(iq,D3_GAA_GBB_TB) + df3gaagbbtb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_GAB_GAB_TA) = Mmat3(iq,D3_GAB_GAB_TA) + df3gabgabta(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_GAB_GAB_TB) = Mmat3(iq,D3_GAB_GAB_TB) + df3gabgabtb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_GAB_GBB_TA) = Mmat3(iq,D3_GAB_GBB_TA) + df3gabgbbta(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_GAB_GBB_TB) = Mmat3(iq,D3_GAB_GBB_TB) + df3gabgbbtb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_GBB_GBB_TA) = Mmat3(iq,D3_GBB_GBB_TA) + df3gbbgbbta(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_GBB_GBB_TB) = Mmat3(iq,D3_GBB_GBB_TB) + df3gbbgbbtb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_GAA_TA_TA) = Mmat3(iq,D3_GAA_TA_TA) + df3gaatata(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_GAA_TA_TB) = Mmat3(iq,D3_GAA_TA_TB) + df3gaatatb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_GAA_TB_TB) = Mmat3(iq,D3_GAA_TB_TB) + df3gaatbtb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_GAB_TA_TA) = Mmat3(iq,D3_GAB_TA_TA) + df3gabtata(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_GAB_TA_TB) = Mmat3(iq,D3_GAB_TA_TB) + df3gabtatb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_GAB_TB_TB) = Mmat3(iq,D3_GAB_TB_TB) + df3gabtbtb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_GBB_TA_TA) = Mmat3(iq,D3_GBB_TA_TA) + df3gbbtata(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_GBB_TA_TB) = Mmat3(iq,D3_GBB_TA_TB) + df3gbbtatb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_GBB_TB_TB) = Mmat3(iq,D3_GBB_TB_TB) + df3gbbtbtb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_TA_TA_TA) = Mmat3(iq,D3_TA_TA_TA) + df3tatata(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_TA_TA_TB) = Mmat3(iq,D3_TA_TA_TB) + df3tatatb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_TA_TB_TB) = Mmat3(iq,D3_TA_TB_TB) + df3tatbtb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_TB_TB_TB) = Mmat3(iq,D3_TB_TB_TB) + df3tbtbtb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          print("#endif"),
          print("          elseif (rhoa.gt.tol_rho.and.rhob.le.tol_rho) then"),
          fortran(fnc(iq) = fnc(iq) + funcs(rhoa,gammaaa,taua)),
          fortran(Amat(iq,D1_RA) = Amat(iq,D1_RA) + dfs1rs(rhoa,gammaaa,taua)),
          fortran(Cmat(iq,D1_GAA) = Cmat(iq,D1_GAA) + dfs1gss(rhoa,gammaaa,taua)),
          fortran(Mmat(iq,D1_TA) = Mmat(iq,D1_TA) + dfs1ts(rhoa,gammaaa,taua)),
          print("#if defined(SECOND_DERIV) || defined(THIRD_DERIV)"),
          fortran(Amat2(iq,D2_RA_RA) = Amat2(iq,D2_RA_RA) + dfs2rsrs(rhoa,gammaaa,taua)),
          fortran(Cmat2(iq,D2_RA_GAA) = Cmat2(iq,D2_RA_GAA) + dfs2rsgss(rhoa,gammaaa,taua)),
          fortran(Cmat2(iq,D2_GAA_GAA) = Cmat2(iq,D2_GAA_GAA) + dfs2gssgss(rhoa,gammaaa,taua)),
          fortran(Mmat2(iq,D2_RA_TA) = Mmat2(iq,D2_RA_TA) + dfs2rsts(rhoa,gammaaa,taua)),
          fortran(Mmat2(iq,D2_GAA_TA) = Mmat2(iq,D2_GAA_TA) + dfs2gssts(rhoa,gammaaa,taua)),
          fortran(Mmat2(iq,D2_TA_TA) = Mmat2(iq,D2_TA_TA) + dfs2tsts(rhoa,gammaaa,taua)),
          print("#endif"),
          print("#if defined(THIRD_DERIV)"),
          fortran(Amat3(iq,D3_RA_RA_RA) = Amat3(iq,D3_RA_RA_RA) + dfs3rsrsrs(rhoa,gammaaa,taua)),
          fortran(Cmat3(iq,D3_RA_RA_GAA) = Cmat3(iq,D3_RA_RA_GAA) + dfs3rsrsgss(rhoa,gammaaa,taua)),
          fortran(Cmat3(iq,D3_RA_GAA_GAA) = Cmat3(iq,D3_RA_GAA_GAA) + dfs3rsgssgss(rhoa,gammaaa,taua)),
          fortran(Cmat3(iq,D3_GAA_GAA_GAA) = Cmat3(iq,D3_GAA_GAA_GAA) + dfs3gssgssgss(rhoa,gammaaa,taua)),
          fortran(Mmat3(iq,D3_RA_RA_TA) = Mmat3(iq,D3_RA_RA_TA) + dfs3rsrsts(rhoa,gammaaa,taua)),
          fortran(Mmat3(iq,D3_RA_GAA_TA) = Mmat3(iq,D3_RA_GAA_TA) + dfs3rsgssts(rhoa,gammaaa,taua)),
          fortran(Mmat3(iq,D3_RA_TA_TA) = Mmat3(iq,D3_RA_TA_TA) + dfs3rststs(rhoa,gammaaa,taua)),
          fortran(Mmat3(iq,D3_GAA_GAA_TA) = Mmat3(iq,D3_GAA_GAA_TA) + dfs3gssgssts(rhoa,gammaaa,taua)),
          fortran(Mmat3(iq,D3_GAA_TA_TA) = Mmat3(iq,D3_GAA_TA_TA) + dfs3gsststs(rhoa,gammaaa,taua)),
          fortran(Mmat3(iq,D3_TA_TA_TA) = Mmat3(iq,D3_TA_TA_TA) + dfs3tststs(rhoa,gammaaa,taua)),
          print("#endif"),
          print("          elseif (rhoa.le.tol_rho.and.rhob.gt.tol_rho) then"),
          fortran(fnc(iq) = fnc(iq) + funcs(rhob,gammabb,taub)),
          fortran(Amat(iq,D1_RB) = Amat(iq,D1_RB) + dfs1rs(rhob,gammabb,taub)),
          fortran(Cmat(iq,D1_GBB) = Cmat(iq,D1_GBB) + dfs1gss(rhob,gammabb,taub)),
          fortran(Mmat(iq,D1_TB) = Mmat(iq,D1_TB) + dfs1ts(rhob,gammabb,taub)),
          print("#if defined(SECOND_DERIV) || defined(THIRD_DERIV)"),
          fortran(Amat2(iq,D2_RB_RB) = Amat2(iq,D2_RB_RB) + dfs2rsrs(rhob,gammabb,taub)),
          fortran(Cmat2(iq,D2_RB_GBB) = Cmat2(iq,D2_RB_GBB) + dfs2rsgss(rhob,gammabb,taub)),
          fortran(Cmat2(iq,D2_GBB_GBB) = Cmat2(iq,D2_GBB_GBB) + dfs2gssgss(rhob,gammabb,taub)),
          fortran(Mmat2(iq,D2_RB_TB) = Mmat2(iq,D2_RB_TB) + dfs2rsts(rhob,gammabb,taub)),
          fortran(Mmat2(iq,D2_GBB_TB) = Mmat2(iq,D2_GBB_TB) + dfs2gssts(rhob,gammabb,taub)),
          fortran(Mmat2(iq,D2_TB_TB) = Mmat2(iq,D2_TB_TB) + dfs2tsts(rhob,gammabb,taub)),
          print("#endif"),
          print("#if defined(THIRD_DERIV)"),
          fortran(Amat3(iq,D3_RB_RB_RB) = Amat3(iq,D3_RB_RB_RB) + dfs3rsrsrs(rhob,gammabb,taub)),
          fortran(Cmat3(iq,D3_RB_RB_GBB) = Cmat3(iq,D3_RB_RB_GBB) + dfs3rsrsgss(rhob,gammabb,taub)),
          fortran(Cmat3(iq,D3_RB_GBB_GBB) = Cmat3(iq,D3_RB_GBB_GBB) + dfs3rsgssgss(rhob,gammabb,taub)),
          fortran(Cmat3(iq,D3_GBB_GBB_GBB) = Cmat3(iq,D3_GBB_GBB_GBB) + dfs3gssgssgss(rhob,gammabb,taub)),
          fortran(Mmat3(iq,D3_RB_RB_TB) = Mmat3(iq,D3_RB_RB_TB) + dfs3rsrsts(rhob,gammabb,taub)),
          fortran(Mmat3(iq,D3_RB_GBB_TB) = Mmat3(iq,D3_RB_GBB_TB) + dfs3rsgssts(rhob,gammabb,taub)),
          fortran(Mmat3(iq,D3_RB_TB_TB) = Mmat3(iq,D3_RB_TB_TB) + dfs3rststs(rhob,gammabb,taub)),
          fortran(Mmat3(iq,D3_GBB_GBB_TB) = Mmat3(iq,D3_GBB_GBB_TB) + dfs3gssgssts(rhob,gammabb,taub)),
          fortran(Mmat3(iq,D3_GBB_TB_TB) = Mmat3(iq,D3_GBB_TB_TB) + dfs3gsststs(rhob,gammabb,taub)),
          fortran(Mmat3(iq,D3_TB_TB_TB) = Mmat3(iq,D3_TB_TB_TB) + dfs3tststs(rhob,gammabb,taub)),
          print("#endif"),
          print("          endif ! rhoa.gt.tol_rho.and.rhob.gt.tol_rho"),
          print("        endif ! ipol.eq.1"),
          print("      enddo ! iq"),
          print("      end"),
          print("#if !defined(SECOND_DERIV)"),
          print("#define SECOND_DERIV"),
          print("c"),
          print("c     Compile source again for the 2nd derivative case"),
          print("c"),
          print("#include \"$outputfile\""),
          print("#endif"),
          print("#if !defined(THIRD_DERIV) "),
          print("#define THIRD_DERIV"),
          print("c"),
          print("c     Compile source again for the 3rd derivative case"),
          print("c"),
          print("#include \"$outputfile\""),
          print("#endif"),
          print("C> @}")
          )
      else /* rho sigma tau */
        with_stdout("$outputfile",
          print("#if !defined(SECOND_DERIV) && !defined(THIRD_DERIV)"),
          print("C> \\\\ingroup nwxc"),
          print("C> @{"),
          print("C>"),
          print("C> \\\\file $outputfile"),
          print("C> The $functional_name functional"),
          print("C>"),
          print("C> @}"),
          print("#endif"),
          print("C> \\\\ingroup nwxc_priv"),
          print("C> @{"),
          print("C>"),
          print("C> \\\\brief Evaluate the $functional_name functional [1]"),
          print("C>"),
          print("C> ### References ###"),
          print("C>"),
          print("C> [1] $reference, DOI:"),
          print("C> <a href=\"http://dx.doi.org/$doi\">"),
          print("C> $doi</a>"),
          print("C>"),
          print("#if !defined(SECOND_DERIV) && !defined(THIRD_DERIV)"),
          print("      subroutine nwxc_${functional_name}(param,tol_rho,ipol,nq,wght,"),
          print("     +rho,rgamma,fnc,Amat,Cmat)"),
          print("#elif defined(SECOND_DERIV) && !defined(THIRD_DERIV)"),
          print("      subroutine nwxc_${functional_name}_d2(param,tol_rho,ipol,nq,wght,"),
          print("     +rho,rgamma,fnc,Amat,Amat2,Cmat,Cmat2)"),
          print("#elif defined(SECOND_DERIV) && defined(THIRD_DERIV)"),
          print("      subroutine nwxc_${functional_name}_d3(param,tol_rho,ipol,nq,wght,"),
          print("     +rho,rgamma,fnc,Amat,Amat2,Amat3,"),
          print("     +Cmat,Cmat2,Cmat3)"),
          print("#endif"),
          print("c \$Id \$"),
          print("      implicit double precision (a-h,o-z), integer (i-n)"),
          print("#include \"nwxc_param.fh\""),
          print("      double precision param(*)     !< [Input] Parameters of functional"),
          print("      double precision tol_rho      !< [Input] The lower limit on the density"),
          print("      integer ipol                  !< [Input] The number of spin channels"),
          print("      integer nq                    !< [Input] The number of points"),
          print("      double precision wght         !< [Input] The weight of the functional"),
          print("      double precision rho(nq,*)    !< [Input] The density"),
          print("      double precision rgamma(nq,*) !< [Input] The norm of the density"),
          print("                                    !< gradients"),
          print("      double precision fnc(nq)      !< [Output] The value of the functional"),
          print("c"),
          print("c     Sampling Matrices for the XC Kernel"),
          print("c"),
          print("      double precision Amat(nq,*)   !< [Output] The derivative wrt rho"),
          print("      double precision Cmat(nq,*)   !< [Output] The derivative wrt rgamma"),
          print("#if defined(SECOND_DERIV) || defined(THIRD_DERIV)"),
          print("c"),
          print("c     Sampling Matrices for the XC Kernel"),
          print("c"),
          print("      double precision Amat2(nq,*)  !< [Output] The 2nd derivative wrt rho"),
          print("      double precision Cmat2(nq,*)  !< [Output] The 2nd derivative wrt rgamma"),
          print("                                    !< and possibly rho"),
          print("#endif"),
          print("#if defined(THIRD_DERIV)"),
          print("c"),
          print("c     Sampling Matrices for the XC Kernel"),
          print("c"),
          print("      double precision Amat3(nq,*)  !< [Output] The 3rd derivative wrt rho"),
          print("      double precision Cmat3(nq,*)  !< [Output] The 3rd derivative wrt rgamma"),
          print("                                    !< and possibly rho"),
          print("#endif"),
          print("      integer iq"),
          print("      double precision tmp"),
          print("      double precision rhoa,rhob"),
          print("      double precision gammaaa,gammaab,gammabb"),
          print("      double precision taua,taub"),
          print("      do iq = 1, nq"),
          print("        if (ipol.eq.1) then"),
          print("          rhoa    = 0.5d0*rho(iq,R_T)"),
          print("          gammaaa = 0.25d0*rgamma(iq,G_TT)"),
          print("          if (rhoa.gt.tol_rho) then"),
          fortran(fnc(iq) = fnc(iq) + func(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          fortran(Amat(iq,D1_RA) = Amat(iq,D1_RA) + df1ra(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          fortran(Cmat(iq,D1_GAA) = Cmat(iq,D1_GAA) + df1gaa(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          print("#if defined(SECOND_DERIV) || defined(THIRD_DERIV)"),
          fortran(Amat2(iq,D2_RA_RA) = Amat2(iq,D2_RA_RA) + df2rara(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          fortran(Cmat2(iq,D2_RA_GAA) = Cmat2(iq,D2_RA_GAA) + df2ragaa(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          fortran(Cmat2(iq,D2_GAA_GAA) = Cmat2(iq,D2_GAA_GAA) + df2gaagaa(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          print("#endif"),
          print("#if defined(THIRD_DERIV)"),
          fortran(Amat3(iq,D3_RA_RA_RA) = Amat3(iq,D3_RA_RA_RA) + df3rarara(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          fortran(Cmat3(iq,D3_RA_RA_GAA) = Cmat3(iq,D3_RA_RA_GAA) + df3raragaa(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          fortran(Cmat3(iq,D3_RA_GAA_GAA) = Cmat3(iq,D3_RA_GAA_GAA) + df3ragaagaa(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          fortran(Cmat3(iq,D3_GAA_GAA_GAA) = Cmat3(iq,D3_GAA_GAA_GAA) + df3gaagaagaa(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          print("#endif"),
          print("          endif ! rhoa.gt.tol_rho"),
          print("        else  ! ipol.eq.1"),
          print("          rhoa    = rho(iq,R_A)"),
          print("          rhob    = rho(iq,R_B)"),
          print("          gammaaa = rgamma(iq,G_AA)"),
          print("          gammaab = rgamma(iq,G_AB)"),
          print("          gammabb = rgamma(iq,G_BB)"),
          print("          if (rhoa.gt.tol_rho.and.rhob.gt.tol_rho) then"),
          fortran(fnc(iq) = fnc(iq) + func(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Amat(iq,D1_RA) = Amat(iq,D1_RA) + df1ra(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Amat(iq,D1_RB) = Amat(iq,D1_RB) + df1rb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat(iq,D1_GAA) = Cmat(iq,D1_GAA) + df1gaa(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat(iq,D1_GAB) = Cmat(iq,D1_GAB) + df1gab(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat(iq,D1_GBB) = Cmat(iq,D1_GBB) + df1gbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          print("#if defined(SECOND_DERIV) || defined(THIRD_DERIV)"),
          fortran(Amat2(iq,D2_RA_RA) = Amat2(iq,D2_RA_RA) + df2rara(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Amat2(iq,D2_RA_RB) = Amat2(iq,D2_RA_RB) + df2rarb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Amat2(iq,D2_RB_RB) = Amat2(iq,D2_RB_RB) + df2rbrb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat2(iq,D2_RA_GAA) = Cmat2(iq,D2_RA_GAA) + df2ragaa(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat2(iq,D2_RA_GAB) = Cmat2(iq,D2_RA_GAB) + df2ragab(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat2(iq,D2_RA_GBB) = Cmat2(iq,D2_RA_GBB) + df2ragbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat2(iq,D2_RB_GAA) = Cmat2(iq,D2_RB_GAA) + df2rbgaa(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat2(iq,D2_RB_GAB) = Cmat2(iq,D2_RB_GAB) + df2rbgab(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat2(iq,D2_RB_GBB) = Cmat2(iq,D2_RB_GBB) + df2rbgbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat2(iq,D2_GAA_GAA) = Cmat2(iq,D2_GAA_GAA) + df2gaagaa(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat2(iq,D2_GAA_GAB) = Cmat2(iq,D2_GAA_GAB) + df2gaagab(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat2(iq,D2_GAA_GBB) = Cmat2(iq,D2_GAA_GBB) + df2gaagbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat2(iq,D2_GAB_GAB) = Cmat2(iq,D2_GAB_GAB) + df2gabgab(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat2(iq,D2_GAB_GBB) = Cmat2(iq,D2_GAB_GBB) + df2gabgbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat2(iq,D2_GBB_GBB) = Cmat2(iq,D2_GBB_GBB) + df2gbbgbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          print("#endif"),
          print("#if defined(THIRD_DERIV)"),
          fortran(Amat3(iq,D3_RA_RA_RA) = Amat3(iq,D3_RA_RA_RA) + df3rarara(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Amat3(iq,D3_RA_RA_RB) = Amat3(iq,D3_RA_RA_RB) + df3rararb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Amat3(iq,D3_RA_RB_RB) = Amat3(iq,D3_RA_RB_RB) + df3rarbrb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Amat3(iq,D3_RB_RB_RB) = Amat3(iq,D3_RB_RB_RB) + df3rbrbrb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RA_RA_GAA) = Cmat3(iq,D3_RA_RA_GAA) + df3raragaa(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RA_RA_GAB) = Cmat3(iq,D3_RA_RA_GAB) + df3raragab(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RA_RA_GBB) = Cmat3(iq,D3_RA_RA_GBB) + df3raragbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RA_RB_GAA) = Cmat3(iq,D3_RA_RB_GAA) + df3rarbgaa(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RA_RB_GAB) = Cmat3(iq,D3_RA_RB_GAB) + df3rarbgab(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RA_RB_GBB) = Cmat3(iq,D3_RA_RB_GBB) + df3rarbgbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RB_RB_GAA) = Cmat3(iq,D3_RB_RB_GAA) + df3rbrbgaa(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RB_RB_GAB) = Cmat3(iq,D3_RB_RB_GAB) + df3rbrbgab(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RB_RB_GBB) = Cmat3(iq,D3_RB_RB_GBB) + df3rbrbgbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RA_GAA_GAA) = Cmat3(iq,D3_RA_GAA_GAA) + df3ragaagaa(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RA_GAA_GAB) = Cmat3(iq,D3_RA_GAA_GAB) + df3ragaagab(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RA_GAA_GBB) = Cmat3(iq,D3_RA_GAA_GBB) + df3ragaagbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RA_GAB_GAB) = Cmat3(iq,D3_RA_GAB_GAB) + df3ragabgab(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RA_GAB_GBB) = Cmat3(iq,D3_RA_GAB_GBB) + df3ragabgbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RA_GBB_GBB) = Cmat3(iq,D3_RA_GBB_GBB) + df3ragbbgbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RB_GAA_GAA) = Cmat3(iq,D3_RB_GAA_GAA) + df3rbgaagaa(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RB_GAA_GAB) = Cmat3(iq,D3_RB_GAA_GAB) + df3rbgaagab(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RB_GAA_GBB) = Cmat3(iq,D3_RB_GAA_GBB) + df3rbgaagbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RB_GAB_GAB) = Cmat3(iq,D3_RB_GAB_GAB) + df3rbgabgab(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RB_GAB_GBB) = Cmat3(iq,D3_RB_GAB_GBB) + df3rbgabgbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_RB_GBB_GBB) = Cmat3(iq,D3_RB_GBB_GBB) + df3rbgbbgbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_GAA_GAA_GAA) = Cmat3(iq,D3_GAA_GAA_GAA) + df3gaagaagaa(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_GAA_GAA_GAB) = Cmat3(iq,D3_GAA_GAA_GAB) + df3gaagaagab(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_GAA_GAA_GBB) = Cmat3(iq,D3_GAA_GAA_GBB) + df3gaagaagbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_GAA_GAB_GAB) = Cmat3(iq,D3_GAA_GAB_GAB) + df3gaagabgab(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_GAA_GAB_GBB) = Cmat3(iq,D3_GAA_GAB_GBB) + df3gaagabgbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_GAA_GBB_GBB) = Cmat3(iq,D3_GAA_GBB_GBB) + df3gaagbbgbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_GAB_GAB_GAB) = Cmat3(iq,D3_GAB_GAB_GAB) + df3gabgabgab(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_GAB_GAB_GBB) = Cmat3(iq,D3_GAB_GAB_GBB) + df3gabgabgbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_GAB_GBB_GBB) = Cmat3(iq,D3_GAB_GBB_GBB) + df3gabgbbgbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Cmat3(iq,D3_GBB_GBB_GBB) = Cmat3(iq,D3_GBB_GBB_GBB) + df3gbbgbbgbb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          print("#endif"),
          print("          elseif (rhoa.gt.tol_rho.and.rhob.le.tol_rho) then"),
          fortran(fnc(iq) = fnc(iq) + funcs(rhoa,gammaaa,taua)),
          fortran(Amat(iq,D1_RA) = Amat(iq,D1_RA) + dfs1rs(rhoa,gammaaa,taua)),
          fortran(Cmat(iq,D1_GAA) = Cmat(iq,D1_GAA) + dfs1gss(rhoa,gammaaa,taua)),
          print("#if defined(SECOND_DERIV) || defined(THIRD_DERIV)"),
          fortran(Amat2(iq,D2_RA_RA) = Amat2(iq,D2_RA_RA) + dfs2rsrs(rhoa,gammaaa,taua)),
          fortran(Cmat2(iq,D2_RA_GAA) = Cmat2(iq,D2_RA_GAA) + dfs2rsgss(rhoa,gammaaa,taua)),
          fortran(Cmat2(iq,D2_GAA_GAA) = Cmat2(iq,D2_GAA_GAA) + dfs2gssgss(rhoa,gammaaa,taua)),
          print("#endif"),
          print("#if defined(THIRD_DERIV)"),
          fortran(Amat3(iq,D3_RA_RA_RA) = Amat3(iq,D3_RA_RA_RA) + dfs3rsrsrs(rhoa,gammaaa,taua)),
          fortran(Cmat3(iq,D3_RA_RA_GAA) = Cmat3(iq,D3_RA_RA_GAA) + dfs3rsrsgss(rhoa,gammaaa,taua)),
          fortran(Cmat3(iq,D3_RA_GAA_GAA) = Cmat3(iq,D3_RA_GAA_GAA) + dfs3rsgssgss(rhoa,gammaaa,taua)),
          fortran(Cmat3(iq,D3_GAA_GAA_GAA) = Cmat3(iq,D3_GAA_GAA_GAA) + dfs3gssgssgss(rhoa,gammaaa,taua)),
          print("#endif"),
          print("          elseif (rhoa.le.tol_rho.and.rhob.gt.tol_rho) then"),
          fortran(fnc(iq) = fnc(iq) + funcs(rhob,gammabb,taub)),
          fortran(Amat(iq,D1_RB) = Amat(iq,D1_RB) + dfs1rs(rhob,gammabb,taub)),
          fortran(Cmat(iq,D1_GBB) = Cmat(iq,D1_GBB) + dfs1gss(rhob,gammabb,taub)),
          print("#if defined(SECOND_DERIV) || defined(THIRD_DERIV)"),
          fortran(Amat2(iq,D2_RB_RB) = Amat2(iq,D2_RB_RB) + dfs2rsrs(rhob,gammabb,taub)),
          fortran(Cmat2(iq,D2_RB_GBB) = Cmat2(iq,D2_RB_GBB) + dfs2rsgss(rhob,gammabb,taub)),
          fortran(Cmat2(iq,D2_GBB_GBB) = Cmat2(iq,D2_GBB_GBB) + dfs2gssgss(rhob,gammabb,taub)),
          print("#endif"),
          print("#if defined(THIRD_DERIV)"),
          fortran(Amat3(iq,D3_RB_RB_RB) = Amat3(iq,D3_RB_RB_RB) + dfs3rsrsrs(rhob,gammabb,taub)),
          fortran(Cmat3(iq,D3_RB_RB_GBB) = Cmat3(iq,D3_RB_RB_GBB) + dfs3rsrsgss(rhob,gammabb,taub)),
          fortran(Cmat3(iq,D3_RB_GBB_GBB) = Cmat3(iq,D3_RB_GBB_GBB) + dfs3rsgssgss(rhob,gammabb,taub)),
          fortran(Cmat3(iq,D3_GBB_GBB_GBB) = Cmat3(iq,D3_GBB_GBB_GBB) + dfs3gssgssgss(rhob,gammabb,taub)),
          print("#endif"),
          print("          endif ! rhoa.gt.tol_rho.and.rhob.gt.tol_rho"),
          print("        endif ! ipol.eq.1"),
          print("      enddo ! iq"),
          print("      end"),
          print("#if !defined(SECOND_DERIV)"),
          print("#define SECOND_DERIV"),
          print("c"),
          print("c     Compile source again for the 2nd derivative case"),
          print("c"),
          print("#include \"$outputfile\""),
          print("#endif"),
          print("#if !defined(THIRD_DERIV) "),
          print("#define THIRD_DERIV"),
          print("c"),
          print("c     Compile source again for the 3rd derivative case"),
          print("c"),
          print("#include \"$outputfile\""),
          print("#endif"),
          print("C> @}")
          )
    else /* rho sigma */
      if tau_deriv then
        with_stdout("$outputfile",
          print("#if !defined(SECOND_DERIV) && !defined(THIRD_DERIV)"),
          print("C> \\\\ingroup nwxc"),
          print("C> @{"),
          print("C>"),
          print("C> \\\\file $outputfile"),
          print("C> The $functional_name functional"),
          print("C>"),
          print("C> @}"),
          print("#endif"),
          print("C> \\\\ingroup nwxc_priv"),
          print("C> @{"),
          print("C>"),
          print("C> \\\\brief Evaluate the $functional_name functional [1]"),
          print("C>"),
          print("C> ### References ###"),
          print("C>"),
          print("C> [1] $reference, DOI:"),
          print("C> <a href=\"http://dx.doi.org/$doi\">"),
          print("C> $doi</a>"),
          print("C>"),
          print("#if !defined(SECOND_DERIV) && !defined(THIRD_DERIV)"),
          print("      subroutine nwxc_${functional_name}(param,tol_rho,ipol,nq,wght,"),
          print("     +rho,tau,fnc,Amat,Mmat)"),
          print("#elif defined(SECOND_DERIV) && !defined(THIRD_DERIV)"),
          print("      subroutine nwxc_${functional_name}_d2(param,tol_rho,ipol,nq,wght,"),
          print("     +rho,tau,fnc,Amat,Amat2,Mmat,Mmat2)"),
          print("#elif defined(SECOND_DERIV) && defined(THIRD_DERIV)"),
          print("      subroutine nwxc_${functional_name}_d3(param,tol_rho,ipol,nq,wght,"),
          print("     +rho,tau,fnc,Amat,Amat2,Amat3,"),
          print("     +Mmat,Mmat2,Mmat3)"),
          print("#endif"),
          print("c \$Id \$"),
          print("      implicit double precision (a-h,o-z), integer (i-n)"),
          print("#include \"nwxc_param.fh\""),
          print("      double precision param(*)     !< [Input] Parameters of functional"),
          print("      double precision tol_rho      !< [Input] The lower limit on the density"),
          print("      integer ipol                  !< [Input] The number of spin channels"),
          print("      integer nq                    !< [Input] The number of points"),
          print("      double precision wght         !< [Input] The weight of the functional"),
          print("      double precision rho(nq,*)    !< [Input] The density"),
          print("      double precision tau(nq,*)    !< [Input] The kinetic energy density"),
          print("      double precision fnc(nq)      !< [Output] The value of the functional"),
          print("c"),
          print("c     Sampling Matrices for the XC Kernel"),
          print("c"),
          print("      double precision Amat(nq,*)   !< [Output] The derivative wrt rho"),
          print("      double precision Mmat(nq,*)   !< [Output] The derivative wrt tau"),
          print("#if defined(SECOND_DERIV) || defined(THIRD_DERIV)"),
          print("c"),
          print("c     Sampling Matrices for the XC Kernel"),
          print("c"),
          print("      double precision Amat2(nq,*)  !< [Output] The 2nd derivative wrt rho"),
          print("      double precision Mmat2(nq,*)  !< [Output] The 2nd derivative wrt tau"),
          print("                                    !< and possibly rho"),
          print("#endif"),
          print("#if defined(THIRD_DERIV)"),
          print("c"),
          print("c     Sampling Matrices for the XC Kernel"),
          print("c"),
          print("      double precision Amat3(nq,*)  !< [Output] The 3rd derivative wrt rho"),
          print("      double precision Mmat3(nq,*)  !< [Output] The 3rd derivative wrt tau"),
          print("                                    !< and possibly rho"),
          print("#endif"),
          print("      integer iq"),
          print("      double precision tmp"),
          print("      double precision rhoa,rhob"),
          print("      double precision gammaaa,gammaab,gammabb"),
          print("      double precision taua,taub"),
          print("      do iq = 1, nq"),
          print("        if (ipol.eq.1) then"),
          print("          rhoa    = 0.5d0*rho(iq,R_T)"),
          print("          taua    = 0.5d0*tau(iq,T_T)"),
          print("          if (rhoa.gt.tol_rho) then"),
          fortran(fnc(iq) = fnc(iq) + func(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          fortran(Amat(iq,D1_RA) = Amat(iq,D1_RA) + df1ra(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          fortran(Mmat(iq,D1_TA) = Mmat(iq,D1_TA) + df1ta(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          print("#if defined(SECOND_DERIV) || defined(THIRD_DERIV)"),
          fortran(Amat2(iq,D2_RA_RA) = Amat2(iq,D2_RA_RA) + df2rara(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          fortran(Mmat2(iq,D2_RA_TA) = Mmat2(iq,D2_RA_TA) + df2rata(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          fortran(Mmat2(iq,D2_TA_TA) = Mmat2(iq,D2_TA_TA) + df2tata(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          print("#endif"),
          print("#if defined(THIRD_DERIV)"),
          fortran(Amat3(iq,D3_RA_RA_RA) = Amat3(iq,D3_RA_RA_RA) + df3rarara(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          fortran(Mmat3(iq,D3_RA_RA_TA) = Mmat3(iq,D3_RA_RA_TA) + df3rarata(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          fortran(Mmat3(iq,D3_RA_TA_TA) = Mmat3(iq,D3_RA_TA_TA) + df3ratata(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          fortran(Mmat3(iq,D3_TA_TA_TA) = Mmat3(iq,D3_TA_TA_TA) + df3tatata(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          print("#endif"),
          print("          endif ! rhoa.gt.tol_rho"),
          print("        else  ! ipol.eq.1"),
          print("          rhoa    = rho(iq,R_A)"),
          print("          rhob    = rho(iq,R_B)"),
          print("          gammaaa = rgamma(iq,G_AA)"),
          print("          gammaab = rgamma(iq,G_AB)"),
          print("          gammabb = rgamma(iq,G_BB)"),
          print("          taua    = tau(iq,T_A)"),
          print("          taub    = tau(iq,T_B)"),
          print("          if (rhoa.gt.tol_rho.and.rhob.gt.tol_rho) then"),
          fortran(fnc(iq) = fnc(iq) + func(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Amat(iq,D1_RA) = Amat(iq,D1_RA) + df1ra(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Amat(iq,D1_RB) = Amat(iq,D1_RB) + df1rb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat(iq,D1_TA) = Mmat(iq,D1_TA) + df1ta(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat(iq,D1_TB) = Mmat(iq,D1_TB) + df1tb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          print("#if defined(SECOND_DERIV) || defined(THIRD_DERIV)"),
          fortran(Amat2(iq,D2_RA_RA) = Amat2(iq,D2_RA_RA) + df2rara(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Amat2(iq,D2_RA_RB) = Amat2(iq,D2_RA_RB) + df2rarb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Amat2(iq,D2_RB_RB) = Amat2(iq,D2_RB_RB) + df2rbrb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat2(iq,D2_RA_TA) = Mmat2(iq,D2_RA_TA) + df2rata(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat2(iq,D2_RA_TB) = Mmat2(iq,D2_RA_TB) + df2ratb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat2(iq,D2_RB_TA) = Mmat2(iq,D2_RB_TA) + df2rbta(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat2(iq,D2_RB_TB) = Mmat2(iq,D2_RB_TB) + df2rbtb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat2(iq,D2_TA_TA) = Mmat2(iq,D2_TA_TA) + df2tata(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat2(iq,D2_TA_TB) = Mmat2(iq,D2_TA_TB) + df2tatb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat2(iq,D2_TB_TB) = Mmat2(iq,D2_TB_TB) + df2tbtb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          print("#endif"),
          print("#if defined(THIRD_DERIV)"),
          fortran(Amat3(iq,D3_RA_RA_RA) = Amat3(iq,D3_RA_RA_RA) + df3rarara(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Amat3(iq,D3_RA_RA_RB) = Amat3(iq,D3_RA_RA_RB) + df3rararb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Amat3(iq,D3_RA_RB_RB) = Amat3(iq,D3_RA_RB_RB) + df3rarbrb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Amat3(iq,D3_RB_RB_RB) = Amat3(iq,D3_RB_RB_RB) + df3rbrbrb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RA_RA_TA) = Mmat3(iq,D3_RA_RA_TA) + df3rarata(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RA_RA_TB) = Mmat3(iq,D3_RA_RA_TB) + df3raratb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RA_RB_TA) = Mmat3(iq,D3_RA_RB_TA) + df3rarbta(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RA_RB_TB) = Mmat3(iq,D3_RA_RB_TB) + df3rarbtb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RB_RB_TA) = Mmat3(iq,D3_RB_RB_TA) + df3rbrbta(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RB_RB_TB) = Mmat3(iq,D3_RB_RB_TB) + df3rbrbtb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RA_TA_TA) = Mmat3(iq,D3_RA_TA_TA) + df3ratata(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RA_TA_TB) = Mmat3(iq,D3_RA_TA_TB) + df3ratatb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RA_TB_TB) = Mmat3(iq,D3_RA_TB_TB) + df3ratbtb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RB_TA_TA) = Mmat3(iq,D3_RB_TA_TA) + df3rbtata(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RB_TA_TB) = Mmat3(iq,D3_RB_TA_TB) + df3rbtatb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_RB_TB_TB) = Mmat3(iq,D3_RB_TB_TB) + df3rbtbtb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_TA_TA_TA) = Mmat3(iq,D3_TA_TA_TA) + df3tatata(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_TA_TA_TB) = Mmat3(iq,D3_TA_TA_TB) + df3tatatb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_TA_TB_TB) = Mmat3(iq,D3_TA_TB_TB) + df3tatbtb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Mmat3(iq,D3_TB_TB_TB) = Mmat3(iq,D3_TB_TB_TB) + df3tbtbtb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          print("#endif"),
          print("          elseif (rhoa.gt.tol_rho.and.rhob.le.tol_rho) then"),
          fortran(fnc(iq) = fnc(iq) + funcs(rhoa,gammaaa,taua)),
          fortran(Amat(iq,D1_RA) = Amat(iq,D1_RA) + dfs1rs(rhoa,gammaaa,taua)),
          fortran(Mmat(iq,D1_TA) = Mmat(iq,D1_TA) + dfs1ts(rhoa,gammaaa,taua)),
          print("#if defined(SECOND_DERIV) || defined(THIRD_DERIV)"),
          fortran(Amat2(iq,D2_RA_RA) = Amat2(iq,D2_RA_RA) + dfs2rsrs(rhoa,gammaaa,taua)),
          fortran(Mmat2(iq,D2_RA_TA) = Mmat2(iq,D2_RA_TA) + dfs2rsts(rhoa,gammaaa,taua)),
          fortran(Mmat2(iq,D2_TA_TA) = Mmat2(iq,D2_TA_TA) + dfs2tsts(rhoa,gammaaa,taua)),
          print("#endif"),
          print("#if defined(THIRD_DERIV)"),
          fortran(Amat3(iq,D3_RA_RA_RA) = Amat3(iq,D3_RA_RA_RA) + dfs3rsrsrs(rhoa,gammaaa,taua)),
          fortran(Mmat3(iq,D3_RA_RA_TA) = Mmat3(iq,D3_RA_RA_TA) + dfs3rsrsts(rhoa,gammaaa,taua)),
          fortran(Mmat3(iq,D3_RA_TA_TA) = Mmat3(iq,D3_RA_TA_TA) + dfs3rststs(rhoa,gammaaa,taua)),
          fortran(Mmat3(iq,D3_TA_TA_TA) = Mmat3(iq,D3_TA_TA_TA) + dfs3tststs(rhoa,gammaaa,taua)),
          print("#endif"),
          print("          elseif (rhoa.le.tol_rho.and.rhob.gt.tol_rho) then"),
          fortran(fnc(iq) = fnc(iq) + funcs(rhob,gammabb,taub)),
          fortran(Amat(iq,D1_RB) = Amat(iq,D1_RB) + dfs1rs(rhob,gammabb,taub)),
          fortran(Mmat(iq,D1_TB) = Mmat(iq,D1_TB) + dfs1ts(rhob,gammabb,taub)),
          print("#if defined(SECOND_DERIV) || defined(THIRD_DERIV)"),
          fortran(Amat2(iq,D2_RB_RB) = Amat2(iq,D2_RB_RB) + dfs2rsrs(rhob,gammabb,taub)),
          fortran(Mmat2(iq,D2_RB_TB) = Mmat2(iq,D2_RB_TB) + dfs2rsts(rhob,gammabb,taub)),
          fortran(Mmat2(iq,D2_TB_TB) = Mmat2(iq,D2_TB_TB) + dfs2tsts(rhob,gammabb,taub)),
          print("#endif"),
          print("#if defined(THIRD_DERIV)"),
          fortran(Amat3(iq,D3_RB_RB_RB) = Amat3(iq,D3_RB_RB_RB) + dfs3rsrsrs(rhob,gammabb,taub)),
          fortran(Mmat3(iq,D3_RB_RB_TB) = Mmat3(iq,D3_RB_RB_TB) + dfs3rsrsts(rhob,gammabb,taub)),
          fortran(Mmat3(iq,D3_RB_TB_TB) = Mmat3(iq,D3_RB_TB_TB) + dfs3rststs(rhob,gammabb,taub)),
          fortran(Mmat3(iq,D3_TB_TB_TB) = Mmat3(iq,D3_TB_TB_TB) + dfs3tststs(rhob,gammabb,taub)),
          print("#endif"),
          print("          endif ! rhoa.gt.tol_rho.and.rhob.gt.tol_rho"),
          print("        endif ! ipol.eq.1"),
          print("      enddo ! iq"),
          print("      end"),
          print("#if !defined(SECOND_DERIV)"),
          print("#define SECOND_DERIV"),
          print("c"),
          print("c     Compile source again for the 2nd derivative case"),
          print("c"),
          print("#include \"$outputfile\""),
          print("#endif"),
          print("#if !defined(THIRD_DERIV) "),
          print("#define THIRD_DERIV"),
          print("c"),
          print("c     Compile source again for the 3rd derivative case"),
          print("c"),
          print("#include \"$outputfile\""),
          print("#endif"),
          print("C> @}")
          )
      else /* rho !sigma tau */
        with_stdout("$outputfile",
          print("#if !defined(SECOND_DERIV) && !defined(THIRD_DERIV)"),
          print("C> \\\\ingroup nwxc"),
          print("C> @{"),
          print("C>"),
          print("C> \\\\file $outputfile"),
          print("C> The $functional_name functional"),
          print("C>"),
          print("C> @}"),
          print("#endif"),
          print("C> \\\\ingroup nwxc_priv"),
          print("C> @{"),
          print("C>"),
          print("C> \\\\brief Evaluate the $functional_name functional [1]"),
          print("C>"),
          print("C> ### References ###"),
          print("C>"),
          print("C> [1] $reference, DOI:"),
          print("C> <a href=\"http://dx.doi.org/$doi\">"),
          print("C> $doi</a>"),
          print("C>"),
          print("#if !defined(SECOND_DERIV) && !defined(THIRD_DERIV)"),
          print("      subroutine nwxc_${functional_name}(param,tol_rho,ipol,nq,wght,"),
          print("     +rho,fnc,Amat)"),
          print("#elif defined(SECOND_DERIV) && !defined(THIRD_DERIV)"),
          print("      subroutine nwxc_${functional_name}_d2(param,tol_rho,ipol,nq,wght,"),
          print("     +rho,fnc,Amat,Amat2)"),
          print("#elif defined(SECOND_DERIV) && defined(THIRD_DERIV)"),
          print("      subroutine nwxc_${functional_name}_d3(param,tol_rho,ipol,nq,wght,"),
          print("     +rho,fnc,Amat,Amat2,Amat3)"),
          print("#endif"),
          print("c \$Id \$"),
          print("      implicit double precision (a-h,o-z), integer (i-n)"),
          print("#include \"nwxc_param.fh\""),
          print("      double precision param(*)     !< [Input] Parameters of functional"),
          print("      double precision tol_rho      !< [Input] The lower limit on the density"),
          print("      integer ipol                  !< [Input] The number of spin channels"),
          print("      integer nq                    !< [Input] The number of points"),
          print("      double precision wght         !< [Input] The weight of the functional"),
          print("      double precision rho(nq,*)    !< [Input] The density"),
          print("      double precision fnc(nq)      !< [Output] The value of the functional"),
          print("c"),
          print("c     Sampling Matrices for the XC Kernel"),
          print("c"),
          print("      double precision Amat(nq,*)   !< [Output] The derivative wrt rho"),
          print("#if defined(SECOND_DERIV) || defined(THIRD_DERIV)"),
          print("c"),
          print("c     Sampling Matrices for the XC Kernel"),
          print("c"),
          print("      double precision Amat2(nq,*)  !< [Output] The 2nd derivative wrt rho"),
          print("#endif"),
          print("#if defined(THIRD_DERIV)"),
          print("c"),
          print("c     Sampling Matrices for the XC Kernel"),
          print("c"),
          print("      double precision Amat3(nq,*)  !< [Output] The 3rd derivative wrt rho"),
          print("#endif"),
          print("      integer iq"),
          print("      double precision tmp"),
          print("      double precision rhoa,rhob"),
          print("      double precision gammaaa,gammaab,gammabb"),
          print("      double precision taua,taub"),
          print("      do iq = 1, nq"),
          print("        if (ipol.eq.1) then"),
          print("          rhoa    = 0.5d0*rho(iq,R_T)"),
          print("          if (rhoa.gt.tol_rho) then"),
          fortran(fnc(iq) = fnc(iq) + func(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          fortran(Amat(iq,D1_RA) = Amat(iq,D1_RA) + df1ra(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          print("#if defined(SECOND_DERIV) || defined(THIRD_DERIV)"),
          fortran(Amat2(iq,D2_RA_RA) = Amat2(iq,D2_RA_RA) + df2rara(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          print("#endif"),
          print("#if defined(THIRD_DERIV)"),
          fortran(Amat3(iq,D3_RA_RA_RA) = Amat3(iq,D3_RA_RA_RA) + df3rarara(rhoa,rhoa,gammaaa,gammaaa,gammaaa,taua,taua)),
          print("#endif"),
          print("          endif ! rhoa.gt.tol_rho"),
          print("        else  ! ipol.eq.1"),
          print("          rhoa    = rho(iq,R_A)"),
          print("          rhob    = rho(iq,R_B)"),
          print("          if (rhoa.gt.tol_rho.and.rhob.gt.tol_rho) then"),
          fortran(fnc(iq) = fnc(iq) + func(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Amat(iq,D1_RA) = Amat(iq,D1_RA) + df1ra(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Amat(iq,D1_RB) = Amat(iq,D1_RB) + df1rb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          print("#if defined(SECOND_DERIV) || defined(THIRD_DERIV)"),
          fortran(Amat2(iq,D2_RA_RA) = Amat2(iq,D2_RA_RA) + df2rara(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Amat2(iq,D2_RA_RB) = Amat2(iq,D2_RA_RB) + df2rarb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Amat2(iq,D2_RB_RB) = Amat2(iq,D2_RB_RB) + df2rbrb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          print("#endif"),
          print("#if defined(THIRD_DERIV)"),
          fortran(Amat3(iq,D3_RA_RA_RA) = Amat3(iq,D3_RA_RA_RA) + df3rarara(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Amat3(iq,D3_RA_RA_RB) = Amat3(iq,D3_RA_RA_RB) + df3rararb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Amat3(iq,D3_RA_RB_RB) = Amat3(iq,D3_RA_RB_RB) + df3rarbrb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          fortran(Amat3(iq,D3_RB_RB_RB) = Amat3(iq,D3_RB_RB_RB) + df3rbrbrb(rhoa,rhob,gammaaa,gammaab,gammabb,taua,taub)),
          print("#endif"),
          print("          elseif (rhoa.gt.tol_rho.and.rhob.le.tol_rho) then"),
          fortran(fnc(iq) = fnc(iq) + funcs(rhoa,gammaaa,taua)),
          fortran(Amat(iq,D1_RA) = Amat(iq,D1_RA) + dfs1rs(rhoa,gammaaa,taua)),
          print("#if defined(SECOND_DERIV) || defined(THIRD_DERIV)"),
          fortran(Amat2(iq,D2_RA_RA) = Amat2(iq,D2_RA_RA) + dfs2rsrs(rhoa,gammaaa,taua)),
          print("#endif"),
          print("#if defined(THIRD_DERIV)"),
          fortran(Amat3(iq,D3_RA_RA_RA) = Amat3(iq,D3_RA_RA_RA) + dfs3rsrsrs(rhoa,gammaaa,taua)),
          print("#endif"),
          print("          elseif (rhoa.le.tol_rho.and.rhob.gt.tol_rho) then"),
          fortran(fnc(iq) = fnc(iq) + funcs(rhob,gammabb,taub)),
          fortran(Amat(iq,D1_RB) = Amat(iq,D1_RB) + dfs1rs(rhob,gammabb,taub)),
          print("#if defined(SECOND_DERIV) || defined(THIRD_DERIV)"),
          fortran(Amat2(iq,D2_RB_RB) = Amat2(iq,D2_RB_RB) + dfs2rsrs(rhob,gammabb,taub)),
          print("#endif"),
          print("#if defined(THIRD_DERIV)"),
          fortran(Amat3(iq,D3_RB_RB_RB) = Amat3(iq,D3_RB_RB_RB) + dfs3rsrsrs(rhob,gammabb,taub)),
          print("#endif"),
          print("          endif ! rhoa.gt.tol_rho.and.rhob.gt.tol_rho"),
          print("        endif ! ipol.eq.1"),
          print("      enddo ! iq"),
          print("      end"),
          print("#if !defined(SECOND_DERIV)"),
          print("#define SECOND_DERIV"),
          print("c"),
          print("c     Compile source again for the 2nd derivative case"),
          print("c"),
          print("#include \"$outputfile\""),
          print("#endif"),
          print("#if !defined(THIRD_DERIV) "),
          print("#define THIRD_DERIV"),
          print("c"),
          print("c     Compile source again for the 3rd derivative case"),
          print("c"),
          print("#include \"$outputfile\""),
          print("#endif"),
          print("C> @}")
          )
  else ( /* rho */
    print("The DENSITY FUNCTIONAL does not depend on the electron density???"),
    exit,
    if sigma_deriv then
      if tau_deriv then
        with_stdout("fortran.F",print("excess,!rho_deriv,sigma_deriv,tau_deriv"))
      else /* !rho sigma tau */
        with_stdout("fortran.F",print("excess,!rho_deriv,sigma_deriv,!tau_deriv"))
    else /* !rho sigma */
      if tau_deriv then
        with_stdout("fortran.F",print("excess,!rho_deriv,!sigma_deriv,tau_deriv"))
      else /* !rho !sigma tau */
        with_stdout("fortran.F",print("excess,!rho_deriv,!sigma_deriv,!tau_deriv"))
  )
/* else
  if rho_deriv then
    if sigma_deriv then
      if tau_deriv then
        with_stdout("fortran.F",print("!excess,rho_deriv,sigma_deriv,tau_deriv"))
      else
        with_stdout("fortran.F",print("!excess,rho_deriv,sigma_deriv,!tau_deriv"))
    else
      if tau_deriv then
        with_stdout("fortran.F",print("!excess,rho_deriv,!sigma_deriv,tau_deriv"))
      else
        with_stdout("fortran.F",print("!excess,rho_deriv,!sigma_deriv,!tau_deriv"))
  else
    if sigma_deriv then
      if tau_deriv then
        with_stdout("fortran.F",print("!excess,!rho_deriv,sigma_deriv,tau_deriv"))
      else
        with_stdout("fortran.F",print("!excess,!rho_deriv,sigma_deriv,!tau_deriv"))
    else
      if tau_deriv then
        with_stdout("fortran.F",print("!excess,!rho_deriv,!sigma_deriv,tau_deriv"))
      else
        with_stdout("fortran.F",print("!excess,!rho_deriv,!sigma_deriv,!tau_deriv")) */ 
$
EOF
maxima -b $f_maxima

#
# Cleaning up (i.e. deleting all the temporary files)
#
rm $f_quiet
rm $f_maxima
rm $f_dependency
rm $f_dependency_sh
