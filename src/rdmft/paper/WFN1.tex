\documentclass[pra]{revtex4-1}

\usepackage{hyperref}
\usepackage[version=3]{mhchem}
\usepackage{xcolor}

\DeclareMathOperator{\tr}{Tr}
\newcommand{\eria}[4]{\left\langle #1^\alpha #2^\beta \right.\left| #3^\alpha #4^\beta \right\rangle}
\newcommand{\eris}[4]{\left\langle #1^\sigma #2^{\sigma'} \right.\left| #3^\sigma #4^{\sigma'} \right\rangle}
\newcommand{\reria}[4]{\left( #1^\alpha #3^\alpha \right.\left| #2^\beta #4^\beta \right)}

\begin{document}

\title{Electron correlation in thermo field dynamics based effective one-electron models}
\author{Hubertus J. J. van Dam}
\affiliation{Brookhaven National Laboratory, Upton, NY 11973-5000}
\date{October 27, 2019}

\begin{abstract}
\end{abstract}

\maketitle

\section{Introduction}

In a recent paper it was shown that it is possible to formulate a 
single-configuration wave function that can generate arbitrary one-electron
density matrices~\cite{van_Dam_2016}. Since the publication of that paper
three developments have taken place:
\begin{itemize}
\item The paper has been heavily criticized by Piris and Pernal~\cite{Piris_2017}.
\item The author has learned that the approach of~\cite{van_Dam_2016} is
      essentially a form of Thermo Field
      Dynamics~\cite{TAKAHASHI_1996, Umezawa:1982, das2000topics}
      but applied only to the 
      one-electron density matrix. Thermo Field Dynamics, however, 
      is a wave function method and therefore generates an N-representable
      energy expression consisting of 1- and 2-electron density matrix terms.
\item Combining elements from Thermo Field Dynamics and adding a natural
      orbital functional a correlated electronic structure method has been
      constructed.
\end{itemize}
As the paper by van Dam~\cite{van_Dam_2016} as well as the criticism thereof by
Piris and Pernal~\cite{Piris_2017} demonstrated a clear unfamiliarity with the
field theory of Thermo Field Dynamics it would seem reasonable to provide some
context. 

That paper sought to deploy this wave function
in the context of density functional theory (DFT) or reduced density matrix
functional theory (RDMFT). In particular for RDMFT an energy functional in
terms of the one-electron density matrix is required. A number of such 
functionals have been proposed~\cite{M_ller_1984,Goedecker_1998,Cs_nyi_2000,
BUIJSE_2002,Mazziotti_2001,Gritsenko_2005,Marques_2008,Piris_2012} but thus far
there does not seem to be a clear favorite. In addition in a recent publication
Wang et al.~\cite{Wang_2015} argued that there are multiple two-electron density
matrices that produce different energies but project to the same one-electron
density matrix. This raises questions about the feasibility of formulating
practical one-electron density matrix functionals. It would seem that in any
case some information about the two-electron density matrix is required as was
also noted by Wang et al.~\cite{Wang_2015}. This situation suggested taking a
closer look at the density matrices generated by the wave function proposed in
our previous paper. 

\section{Proof that the exact energy is an orbital functional}

Given that we can proof that the exact energy is a functional of the electron density,
and also that it is an functional of the one-electron density matrix, it should be
possible to also prove that it is a functional of the orbitals. This results from the
fact that the orbitals feed into the construction of the density matrix which in turn
feeds into the construction of the density. 

The idea behind presenting such a proof is that although the theorems at all three
levels are valid the requirement imposed on the associated functional is different.
For the density functional we have found that the exact energy is practice very 
difficult to attain. In fact going from the Thomas-Fermi approach to Kohn-Sham the 
density matrix was inserted and later with hybrid functionals (think also about Hubbard
U) the functionals that are most successful today are already in fact orbital
functionals. For reduced density matrix functional theory we have a similar problem in
that the reconstruction approaches to two-electron density matrices do not really work.
The hope is that by taking one step further back we can use orbitals which have even
more information about the system and maybe it is possible to formulate accurate 
functionals starting from the level.

\section{Arbitrary one-electron and N-representable two-electron density
         matrices from a single-configuration wave function}

In a recent paper~\cite{van_Dam_2016} we proposed a new form of single-configuration
wave function. We showed that this wave function can generate any arbitrary
N-representable one-electron density matrix even non-idem-potent ones. Here
it is shown that the two-electron density matrix generated from this wave
function is also N-representable, as should be expected. 

The wave function proposed in the previous paper is~\cite{van_Dam_2016}
\begin{equation}
   \Psi(r_1,\ldots,r_{n_e})
   = \left|G_1(r_1)G_2(r_2)\ldots G_{n_e}(r_{n_e})\right|
   \label{Eq:wavefunction}
\end{equation}
Here the functions $G$ are generalized orbitals expressed in terms of natural
orbitals $N$ and correlation functions $C$ as
\begin{eqnarray}
   \left|G_s(r)\right\rangle
   &=& \sum_{a,i=1}^{n_b} N_{ai}C_{is}\left|\chi_a(r)\right\rangle
   \label{Eq:genorb}
\end{eqnarray}
The natural orbitals form an orthonormal set as do the correlation functions.
As the correlation functions are expressed in terms of the natural orbitals
they are expressed in an orthonormal basis. Hence the matric $C$ is a
unitary matrix.

Furthermore we postulated that the one-electron density matrix be given by
\begin{eqnarray}
  \sum_{a,b=1}^{n_b}\left|\chi_a(r_1)\right\rangle D_{ab}
                    \left\langle\chi_b(r'_1)\right|
  &=& n_e \int \Psi(r_1,r_2,\ldots,r_{n_e})\Psi^*(r'_1,r_2,\ldots,r_{n_e})
      \mathrm{d}r_2 \ldots \mathrm{d}r_{n_e} \\
  D_{ab}
  &=& \sum_{i=1}^{n_b}\sum_{s=1}^{n_e} N_{ai}C_{is}C^*_{is}N^*_{bi}
      \label{Eq:1densmat}
\end{eqnarray}

From this wave function the two-electron density matrix can be obtained as
\begin{eqnarray}
  \sum_{a,b,c,d=1}^{n_b}\left|\chi_a(r_1)\chi_b(r_2)\right\rangle
                    \Gamma_{abcd}
                    \left\langle\chi_c(r'_1)\chi_d(r'_2)\right|
  &=& \frac{n_e(n_e-1)}{2}
      \int \Psi(r_1,r_2,\ldots,r_{n_e})\Psi^*(r'_1,r'_2,\ldots,r_{n_e})
      \mathrm{d}r_3 \ldots \mathrm{d}r_{n_e} \\
  \Gamma_{abcd}
  &=& \frac{1}{2}\left[
      \sum_{s,t=1}^{n_e}
      \left(\sum_{i=1}^{n_b} N_{ai}C_{is}C^*_{is}N^*_{ci}\right)
      \left(\sum_{j=1}^{n_b} N_{bj}C_{jt}C^*_{jt}N^*_{dj}\right)
      \right.
      \nonumber \\
  &&- \left.
      \sum_{s,t=1}^{n_e}
      \left(\sum_{i=1}^{n_b} N_{ai}C_{is}C^*_{it}N^*_{ci}\right)
      \left(\sum_{j=1}^{n_b} N_{bj}C_{jt}C^*_{js}N^*_{dj}\right)
      \right]
      \label{Eq:2densmat}
\end{eqnarray}
\begin{eqnarray}
  & \sum_{a,b,c,d=1}^{n_b}&\left|\chi_a(r_1)\chi_b(r_2)\right\rangle
                    \Gamma_{abcd}
                    \left\langle\chi_c(r'_1)\chi_d(r'_2)\right| \nonumber\\
  &=& \frac{n_e(n_e-1)}{2}
      \int \Psi(r_1,r_2,\ldots,r_{n_e})\Psi^*(r'_1,r'_2,\ldots,r_{n_e})
      \mathrm{d}r_3 \ldots \mathrm{d}r_{n_e} \\
  &=& \frac{n_e(n_e-1)}{2}
      \sum_{a,b,c,d=1}^{n_b}
      \left|\chi_a(r'_1)\chi_b(r'_2)\right\rangle
      \left\langle\chi_c(r"_1)\chi_d(r"_2)\right| \nonumber\\
  &&  \int 
      \left\langle\chi_a(r_1)\chi_b(r_2)\right|
      \Psi(r_1,r_2,\ldots,r_{n_e})\Psi^*(r_1,r_2,\ldots,r_{n_e})
      \left|\chi_c(r_1)\chi_d(r_2)\right\rangle
      \mathrm{d}r_1 \ldots \mathrm{d}r_{n_e} \\
  \Gamma_{abcd}
  &=& \frac{1}{4}\left\{
      \left[
      \sum_{s,t=1}^{n_e}
      \left(\sum_{i=1}^{n_b} N_{ai}C_{is}C^*_{is}N^*_{ci}\right)
      \left(\sum_{j=1}^{n_b} N_{bj}C_{jt}C^*_{jt}N^*_{dj}\right)
      \right.\right.
      \nonumber \\
  &&- \left.
      \sum_{s,t=1}^{n_e}
      \left(\sum_{i=1}^{n_b} N_{ai}C_{is}C^*_{it}N^*_{ci}\right)
      \left(\sum_{j=1}^{n_b} N_{bj}C_{jt}C^*_{js}N^*_{dj}\right)
      \right] \nonumber \\
  &+& \left[ 
      \sum_{s,t=1}^{n_e}
      \left(\sum_{i=1}^{n_b} N_{bi}C_{is}C^*_{is}N^*_{di}\right)
      \left(\sum_{j=1}^{n_b} N_{aj}C_{jt}C^*_{jt}N^*_{cj}\right)
      \right.
      \nonumber \\
  &&- \left.
      \sum_{s,t=1}^{n_e}
      \left(\sum_{i=1}^{n_b} N_{bi}C_{is}C^*_{it}N^*_{di}\right)
      \left(\sum_{j=1}^{n_b} N_{aj}C_{jt}C^*_{js}N^*_{cj}\right)
      \right] \nonumber \\
  &-& \left[
      \sum_{s,t=1}^{n_e}
      \left(\sum_{i=1}^{n_b} N_{ai}C_{is}C^*_{is}N^*_{di}\right)
      \left(\sum_{j=1}^{n_b} N_{bj}C_{jt}C^*_{jt}N^*_{cj}\right)
      \right.
      \nonumber \\
  &&- \left.
      \sum_{s,t=1}^{n_e}
      \left(\sum_{i=1}^{n_b} N_{ai}C_{is}C^*_{it}N^*_{di}\right)
      \left(\sum_{j=1}^{n_b} N_{bj}C_{jt}C^*_{js}N^*_{cj}\right)
      \right] \nonumber \\
  &-& \left[
      \sum_{s,t=1}^{n_e}
      \left(\sum_{i=1}^{n_b} N_{bi}C_{is}C^*_{is}N^*_{ci}\right)
      \left(\sum_{j=1}^{n_b} N_{aj}C_{jt}C^*_{jt}N^*_{dj}\right)
      \right.
      \nonumber \\
  &&- \left.\left.
      \sum_{s,t=1}^{n_e}
      \left(\sum_{i=1}^{n_b} N_{bi}C_{is}C^*_{it}N^*_{ci}\right)
      \left(\sum_{j=1}^{n_b} N_{aj}C_{jt}C^*_{js}N^*_{dj}\right)
      \right]\right\} \nonumber \\
      \label{Eq:2densmat_2}
\end{eqnarray}
In Eq.~\ref{Eq:2densmat_2} we have used that both
$\left|\chi_a(r_1)\chi_b(r_2)\right\rangle$ and 
$\left\langle\chi_c(r_1)\chi_d(r_2)\right|$ are anti-symmetric functions.
Note that Eq.~\ref{Eq:2densmat} can be used for all different blocks of the
two-electron density matrix. The case where generalized orbitals $s$ and $t$ 
are both $\alpha$ orbitals or both are $\beta$ orbitals is directly represented
in the equation. The case where $s$ and $t$ are different spin orbitals the
spin integration eliminates the exchange term and only the first term survives.

The expression of Eq.~\ref{Eq:2densmat_2} can be simplified by collapsing the 
2-electron density matrix occupation numbers as
\begin{eqnarray}
  d_{ij}
  &=& 
      \sum_{s,t=1}^{n_e}
      C_{is}C^*_{is}
      C_{jt}C^*_{jt}
    - C_{is}C^*_{it}
      C_{jt}C^*_{js}
      \label{Eq:2occupation_3} \\
  \Gamma_{abcd}
  &=& \frac{1}{4}
      \left[
      \left(\sum_{i,j=1}^{n_b} N_{ai}N^*_{ci}N_{bj}N^*_{dj}d_{ij}\right)
      \right.
      \nonumber \\
  &&+ \left(\sum_{i,j=1}^{n_b} N_{bi}N^*_{di}N_{aj}N^*_{cj}d_{ij}\right)
      \nonumber \\
  &&- \left(\sum_{i,j=1}^{n_b} N_{ai}N^*_{di}N_{bj}N^*_{cj}d_{ij}\right)
      \nonumber \\
  &&- \left.
      \left(\sum_{i,j=1}^{n_b} N_{bi}N^*_{ci}N_{aj}N^*_{dj}d_{ij}\right)
      \right]
      \label{Eq:2densmat_3}
\end{eqnarray}


Note that in Eq.~\ref{Eq:2densmat} the expression for the probability density
had to be generalized somewhat. Here we use a transition density matrix
for a pair of generalized orbitals defined as
\begin{eqnarray}
  D^{st}_{ab} &=& \sum_{i=1}^{n_b}N_{ai}C_{is}C^*_{it}N^*_{bi}
  \label{Eq:1orbmat}
\end{eqnarray}
The case where $s$ equals $t$ then is a special case which generates a regular
single-orbital one-electron density matrix that generates the corresponding
probability density.

In order for this two-electron density matrix to be N-representable 
three requirements have to be met: 1) it should be anti-symmetric under
permutations of two orbitals in either the wave function or its complex 
conjugate; 2) it should be an non-negative matrix; 3) the trace of the matrix
should equal the number of electron pairs.

The anti-symmetry requirement translates into the condition that
\begin{eqnarray}
   \Gamma_{abcd} &=& - \Gamma_{bacd} \\
                 &=& - \Gamma_{abdc}
\end{eqnarray}
In order for this to hold it is necessary to define the permutation such that
it involves the complete generalized orbital. I.e. it is not permisible to just
interchange $N_{ai}$ and $N_{bj}$ in Eq.~\ref{Eq:2densmat}. Instead we have to
postulate that the permutation involves $N_{ai}C_{is}$ and $N_{bj}C_{jt}$ as
together they form the coefficients of the generalized orbitals. Also for this
permutation to safisfy Eq.~\ref{Eq:1orbmat} the indeces $i$ and $j$ need to be
relabeled on the quantities being interchanged. It is trivial to verify that
if we postulate that permutation of indeces of $\Gamma$ be performed this way
that then $\Gamma$ is indeed anti-symmetric.

The fact that the matrix is non-negative can be proven by making use of the
Gauchy-Schwarz inequality which states that
\begin{eqnarray}
  \left|\sum_{i=1}^n x_i y_i^*\right| 
  &\leq& \left(\sum_{j=1}^n|x_j|^2\right)\left(\sum_{k=1}^n|y_k|^2\right)
  \label{Eq:GauchySchwarz}
\end{eqnarray}
For simplicity we prove that the first term in Eq.~\ref{Eq:2densmat} is larger
than the second term for every combination of $i$ and $j$. In this argument we
discard the natural orbital factors as they are the same in both terms for a
given pair of $i$ and $j$ and focus just on the correlation functions.
I.e. we have to show that 
\begin{eqnarray}
  \sum_{s,t=1}^{n_e} C_{is}C^*_{it}C_{jt}C^*_{js} &\leq&
  \sum_{s,t=1}^{n_e} C_{is}C^*_{is}C_{jt}C^*_{jt} 
\end{eqnarray}
By trivially rearranging the factors and the summations this expression can be
rewritten as
\begin{eqnarray}
  \left(\sum_{s=1}^{n_e} C_{is}C^*_{js}\right)
  \left(\sum_{t=1}^{n_e}C_{jt}C^*_{it}\right) &\leq&
  \left(\sum_{s=1}^{n_e} C_{is}C^*_{is}\right)
  \left(\sum_{t=1}^{n_e}C_{jt}C^*_{jt}\right) 
\end{eqnarray}
which is the same as Eq.~\ref{Eq:GauchySchwarz} if the vector $y$ is equated to
the $j$-th row of $C$ and vector $x$ is equated to the $i$-th row of $C$.
Furthermore as the first term in Eq.~\ref{Eq:2densmat} is obviously 
non-negative it immediately follows that $\Gamma_{abcd}$ is a non-negative
density matrix.

Finally we need to show that $\Gamma_{abcd}$ is the correct trace. Once again
we focus on the factors related to the correlation functions. Furthermore
we exploit the orthonormality of the correlation functions. Starting from
\begin{eqnarray}
  &&\frac{1}{2}\left[\sum_{s,t=1}^{n_e}
  \left(\sum_{i=1}^{n_b}C_{is}C^*_{is}\right)
  \left(\sum_{j=1}^{n_b}C_{jt}C^*_{jt}\right)
  -\sum_{s,t=1}^{n_e}
  \left(\sum_{i=1}^{n_b}C_{is}C^*_{it}\right)
  \left(\sum_{j=1}^{n_b}C_{jt}C^*_{js}\right)\right] \nonumber \\
  &&=
  \left[\sum_{\begin{array}{c}s,t=1\\s > t\end{array}}^{n_e}
  \left(\sum_{i=1}^{n_b}C_{is}C^*_{is}\right)
  \left(\sum_{j=1}^{n_b}C_{jt}C^*_{jt}\right)
  -\sum_{\begin{array}{c}s,t=1\\s > t\end{array}}^{n_e}
  \left(\sum_{i=1}^{n_b}C_{is}C^*_{it}\right)
  \left(\sum_{j=1}^{n_b}C_{jt}C^*_{js}\right)\right] \\
  &&= 
  \left[\sum_{\begin{array}{c}s,t=1\\s > t\end{array}}^{n_e}
  1\cdot 1
  -\sum_{\begin{array}{c}s,t=1\\s > t\end{array}}^{n_e}
  0 \cdot 0
  \right] \\
  &&= n_e(n_e-1)
\end{eqnarray}
Therefore we have that the trace equals the number of electron pairs.

Thus we have shown that it is possible to formulate a single-determinant
wave function
in terms of generalized orbitals and a suitably chosen formalism such that it
can generate the exact one-electron density matrix and an N-representable
two-electron density matrix. In particular the two-electron density matrix
is N-representable even if the one-electron density matrix for the same state
is not idem-potent. Of course the two-electron density matrix is not exact as
it corresponds to a single-determinant wave function and therefore no 
correlation effects are accounted for. 

Furthermore the two-electron density matrix is orbital dependent due to the
exchange terms. This raises questions about the extent to which it is possible
to reconstruct the two-electron density matrix from the one-electron density
matrix. It seems that this is highly non-trivial especially if the 
resulting two-electron density matrix is to meet the N-representability 
conditions. So if two-electron density matrix reconstruction approaches might
not be the right path to proceed to find a way to represent electron correlation
effects then what alternatives can we pursue?

One alternative approach is to consider an effective one-electron model as 
a reduced dimensionality model obtained by coarse graining the full many-body 
problem. Consider that an effective one-electron models is essentially a 
mean-field approximation. The full many-body problem in addition contains
dynamical correlation, effects that result from the interaction between 
fluctuations around the mean-field electron distribution. Against this notion
there there are many ideas that suggest a coarse graining approach. 
The separation between slow modes (mean-field) and fast modes (dynamic
correlation) referred to by Gorban~\cite{Gorban_2006}. The {\bf more stuff}...

\section{Coarse graining}

In coarse graining approaches the aim is to reduce the number of degrees of 
freedom while maintaining the statistical properties of the full system. 
Typically this requires adding terms such that the free energy of the 
reduced dimensionality system is as close as possible to the free energy
of the full system. As in this work we are interested in representing electron
correlation in molecules in vacuum the Helmholtz free energy is the appropriate
quantity to preserve~\cite{Warren_1996,Weinert_1992,Gillan_1989,Mermin_1965}
\begin{equation}
  F = U - TS
  \label{Eq:Helmholtz}
\end{equation}
where $U$ is the internal energy which equates the expectation value of the
Hamiltonian in the Schr{\"o}dinger equation, $T$ is the temperature and $S$ the
entropy. 

In the following two subsections we consider how to formulate the temperature
and the entropy in the context where we want to describe electron correlation
as a coarse graining consequence. Important in this discussion will be three
levels of theory: effective one-electron approaches, electron-pair
models, and the Full-CI approach. From the outset it should be clear that the
Full-CI energy and the two-electron density matrix energy are both exact
without the $TS$ term. Only in the effective one-electron approach is the 
$TS$ non-zero. The theory proposed will bear this out.

\subsection{The temperature}

In this section the temperature is considered in detail. Typically discussions
about temperature involve a system coupled to a bath. In this context 
Eq.~\ref{Eq:Helmholtz} has already been deployed in electronic structure
theory~\cite{Warren_1996,Weinert_1992,Gillan_1989,Mermin_1965}. The fractional
occupation numbers resulting in this case are not representative of electron
correlation resulting from electron-electron interactions. Although we are
interested in the latter it is still illustrative to start with the traditional
view of a system coupled to a bath as a reference point for the discussion.

When a system, a collection of particles, is coupled to a heat bath and the
system is in equilibrium with the bath the temperature of the particles
is the same as that of the bath. In this case if the bath has zero temperature
this means that the particles in the system are in their lowest accessible
energy states. Raising the temperature of the bath causes energy to be deposited
in the various degrees of freedom of the particles until equilibrium is once
again obtained. For system of, for example, noble gas atoms the temperature
is closely related to the average kinetic energy per degree of freedom. The
reason for that is that the kinetic energy is most easily changed, excitations
of electronic states typically require substantially more energy to access.
The important point is that the temperature is proportional to the raise in
energy of a particle due to the interaction with the bath.

With the idea of the previous paragraph in mind we turn to the temperature
of electrons in effective one-electron models $T_1$, effective electron-pair
models $T_2$, and true many-body models $T_{n_e}$. In effective one-electron
models the electron would occupy the lowest one-electron energy states if it
wasn't for the electron-electron interaction. This interaction drives the
electrons out of the lowest possible states and raises their energy to that
of the orbital eigenvalues of the effective one-electron model. Hence $T_1$ is
proportional to the electron-electron repulsion per electron.

By a similar consideration the electron-pairs of an effective electron-pair
model cannot occupy the lower pair states due to the pair-pair interactions. In
this case of course in the intra-pair electron-electron interaction is not
contributing to the temperature as this property is integral to the properties
of the electron pair. The inter-pair interaction on the contrary is contributing
to the temperature. In fact the pair temperature $T_2$ is directly propertional
to the total pair-pair interaction energy per electron pair.  

Finally considering the many-body, i.e. Full-CI $n_e$-electron, temperature
we realize that for a system of $n_e$ electrons there are no other $n_e$
electron states to interact with. Hence the lowest $n_e$ electron state is
accessible without constraint and the corresponding temperature $T_{n_e}$ is
zero.

Note that as the temperature for higher order states is concerned increasingly
more interactions are considered internal to the states of that order and
fewer interactions are inter-state interactions it is
reasonable that $T_1 \ge T_2 \ge \ldots \ge T_{n_e} = 0$. In remainder of the
paper it is important to note in particular that in general $T_2 > 0$. The 
latter fact is important in the discussion of the entropy.

\subsection{The entropy}

Having settled on an interpretation for the temperature the entropy is the
remaining quantity needed to define the free energy. Already in 1926 the
entropy of an electron distribution over available one-electron states was
worked out independently by Fermi and Dirac~\cite{Fermi_1926,Dirac_1926}.
The expression they found
\begin{eqnarray}
   S = \sum_{i=1}^{n_b} \left(d_i\ln(d_i) + (1-d_i)\ln(1-d_i)\right)
   \label{Eq:Entropy}
\end{eqnarray}
follows directly from the expression for the number of ways a given number
of electrons can be distributed over a set of orbitals of infinite degeneracy, 
and applying the Sterling approximation to the logarithm of the factorials.
Hence it would seem that the one-electron picture is obvious.

The $n_e$-electron picture is also obvious. The density matrix of the many-body
ground state wave function has one eigenvalue of value $1$ corresponding to that
state. All other eigenvalues are $0$. As a result the entropy of the 
$n_e$-electron wave function is $0$. 

The entropies for the intermediate density matrices can in principle be worked
out on the basis of information theoretical ideas. In information theory an 
increase in entropy is equated to a loss of information about the system in 
question. Hence when we start from the $n_e$ electron density matrix and one
electron coordinate is integrated out to produce a $(n_e-1)$-electron density
matrix some information about the system is lost and hence the entropy 
increases. This suggests that the entropy for all density matrices from the
one-electron density matrix to the $(n_e-1)$-electron density matrix is
non-zero.
This causes a problem because in the previous subsection it was already found
that the electron-pair temperature $T_2$ is non-zero. Combined with a non-zero
two-electron density matrix entropy there would be a non-zero entropic term to
the free energy, but it is clear that the internal energy already gives the
exact free energy. Hence we face a paradox.

When considering the paradox found it is clear that either the temperature
or the entropy is not correct. The electron-pair temperature as defined in the
previous subsection as given by the pair-pair interactions per pair clearly is
non-zero. Hence in order for the entropic term to vanish the two-electron 
density matrix entropy should be zero. The way this can be explained is by
considering the order of the interactions and the associated physics. Electrons
interact by potentials that involve at most two-electrons. Hence a
three-electron density matrix has no physical relevance as there are no 
physical phenomena that are directly related to it. Therefore when an 
electron coordinate is integrated out of a three-electron density matrix to 
obtain a two-electron density matrix mathematically information about the system
is lost. However, physically that information is of no consequence. The same
argument holds for all density matrices of orders higher than two. Only when
the two-electron density matrix is projected to generate the one-electron
density matrix is actually physically relevant information lost. Hence the
zero point of physically relevant information is shifted with respect to the
mathematical zero point. Based on this argument we postulate that the entropy
be chosen such that the entropy of the two-electron density matrix is zero
by definition. This means, however, that the one-electron density matrix 
entropy must be corrected by the shift of the zero-point of the two-electron
density matrix entropy. As a result the correct one-electron entropy is smaller
than expected on the basis of the conventional entropy expression.

Instead of the entropy of Eq.~\ref{Eq:Entropy} we propose the expression
\begin{eqnarray}
   S &=& S^{(1)} - S^{(2)}
   \label{Eq:Entropy12} \\
   S^{(1)} &=& 
     -\sum_{i=1}^{n_b}
         \left(d_i\ln(d_i) + (1-d_i)\ln(1-d_i) \right)
   \label{Eq:Entropy1} \\
   S^{(2)} &=& 
     -   \frac{1}{n_e-1}\sum_{i,j=1}^{n_b}
         \left(d_{ij}\ln(d_{ij}) + (1-d_{ij})\ln(1-d_{ij}) \right)
   \label{Eq:Entropy2}
\end{eqnarray}
where $d_i$ are the occupation numbers of the one-electron density matrix and
$d_{ij}$ are the occupation numbers of the two-electron density matrix.
The scale factor for the two-electron density matrix term stems from the fact
that the corresponding entropy grows with the number of electron pairs. Clearly
such an electron-pair entropy cannot be compared directly against an 
one-electron entropy. Hence the scale factor is needed to obtain an 
electron-pair entropy that is comparable to an one-electron entropy.
Note that the term for the two-electron density matrix can be used in the
present context. In the general case the occupation numbers of the two matrix
can exceed $1$ unlike in the case of the one-electron density matrix. However,
this can occur only in the case of multi-determinantal wave functions. In the
case of a single-determinant wave function the occupation numbers of the 
two-electron density matrix satisfy the same constraints as those of the
one-electron density as is clear from Eq.~\ref{Eq:2densmat}.

{\bf Possibly $TS$ can be broken up into $T_iS_i$, i.e. a free energy term 
per natural orbital. Although there does not seem to be any justification for
doing that, it would certainly ensure that the free energy of a system 
consisting of non-interacting subsystems is the sum of free energies of all 
subsystems. It is definetely non-obvious that Eq.~\ref{Eq:Entropy12} would
do that. 

Even when we write the free energy contribution as $T_iS_i$ there is yet 
another problem. If there are two interacting electrons 1 and 2 then there
is no reason for the entropy associated with both electrons to be the same.
As a result we arrive at another paradox, namely that the strength of the
interaction of electron 1 with 2 could be different from the strength
of the interaction of electron 2 with 1. This clearly violates a rather
fundamental principle in physics.}

\subsection{Formulating the energy expression}

Based on the arguments above the overall expression for the free energy can
be formulated as
\begin{eqnarray}
   F &=& U-TS \\
     &=& H+W-TS
   \label{Eq:TS}
\end{eqnarray}
where $H$ is the one-electron internal energy, i.e. the kinetic energy and the
nuclear attraction energies, $W$ is the two-electron repulsion energy, 
$T=W/n_e$ is the temperature and $S$ is the entropy. Obviously if the division
by the number of electrons is moved out of the temperature and into the 
entropy this equation can be simplified a bit to
\begin{eqnarray}
   F &=& H+W(1-S/n_e)
   \label{Eq:Coulombquenching}
\end{eqnarray}
Hence, electron correlation in this view arises as an entropy driven quenching
of the electron-electron repulsion. Unfortunately the picture of 
Eq.~\ref{Eq:Coulombquenching} cannot be right as it relies on the average entropy
of a system. This fact causes a problem when studing systems that consist of 
sub-systems without interaction. For example consider a \ce{Be} atom and a 
\ce{H2O} molecule separated by a large distance. Clearly the overall free energy
of this system should be the same as the sum of the free energy of a \ce{Be} atom in
isolation and the free energy of a \ce{H2O} molecule in isolation. However, because 
an average entropy is used the entropy for the \ce{Be} electrons is modified by the
sheer existence of a \ce{H2O} molecule, irrespective how remote that molecule is.
Solving this problem requires replacing the entropic term in Eq.~\ref{Eq:TS} by 
something else that associates an entropic term with each electron, i.e. something
of the form
\begin{eqnarray}
   F &=& H+W-\sum_{r=1}^{n_e}T_rS_r
   \label{Eq:TrSr}
\end{eqnarray}
is needed.

To complete the definition of the free energy expression in Eq.~\ref{Eq:TrSr} a 
re-interpretation of the temperature and the entropy is needed. The interpretation
of the temperature of a single electron follows from the temperature definition 
chosen earlier. If the total electron-electron repulsion per electron is the 
temperature of the system then the temperature of an electron in generalized 
orbital $r$ is given by
\begin{eqnarray}
   \Gamma_{abcd}^{(r)} &=& \sum_{s=1}^{n_e}\Gamma_{abcd}^{(rs)} 
   \label{Eq:Gr} \\
   T_{r} &=& \sum_{a,b,c,d=1}^{n_b}(ab|cd)\Gamma_{abcd}^{(r)}
   \label{Eq:Tr}
\end{eqnarray}.
I.e. the repulsion energy that an electron in orbital $r$ experiences due to the
interaction with all other electrons.

To deal with the entropy it is first of all important to recognize that the entropy
depends on the behavior of all electrons. I.e. if the entropy of the one-electron
density matrix is given by
\begin{eqnarray}
   S^{(1)} &=& \sum_{i=1}^{n_b}\left\{d_i\ln(d_i)+(1-d_i)\ln(1-d_i)\right\}
\end{eqnarray}
then it makes no sense to define the entropy of an electron in orbital $r$ as
\begin{eqnarray}
   S^{(1)}_r &=& \sum_{i=1}^{n_b}
           \left\{d_i^{(r)}\ln(d_i^{(r)})+(1-d_i^{(r)})\ln(1-d_i^{(r)})\right\}
   \label{Eq:nonsense}
\end{eqnarray}
where $d_i^{(r)}$ is the occupation number of natural orbital $i$ generated by
generalized orbital $r$. The reason this makes no sense is that if we consider two
natural orbitals which are fully occupied then their contribution to the entropy is
zero. However if we choose to distribute each electron half-and-half over both natural
orbitals then the total density matrix would remain the same but Eq.~\ref{Eq:nonsense}
would assign a non-zero entropy to both electrons.

Therefore it is clear that the entropy itself must be evaluated on the density matrix
of all electrons but the resulting entropy must be divided over all the electrons.
Hence we chose to partition the entropy prorata with respect to the fraction of the
occupation number that a given orbital contributes. I.e. for the entropy of the 
one-electron density matrix
\begin{eqnarray}
   S^{(1)}_r &=& -\sum_{i=1}^{n_b}\frac{d_i^{(r)}}{d_i}
   \left\{d_i\ln(d_i)+(1-d_i)\ln(1-d_i)\right\}
   \label{Eq:entropy1part}
\end{eqnarray}
For the entropy of the two-electron density matrix we have
\begin{eqnarray}
   S^{(2)}_r &=& -\sum_{i,j=1}^{n_b}
           \left\{\frac{\sum_{s=1}^{n_e}d_{ij}^{(rs)}}{d_{ij}(n_e-1)}\right\}
           \left\{d_{ij}\ln(d_{ij})+(1-d_{ij})\ln(1-d_{ij})\right\}
   \label{Eq:entropy2part}
\end{eqnarray}
where $d_{ij}^{(rs)}$ is occupation number for the $i, j$ natural orbital pair
generated by the $r, s$ generalized orbital pair. Clearly these definitions have
the property that 
\begin{equation}
    S = \sum_{r=1}^{n_e}\left(S^{(1)}_r-S^{(2)}_r\right)
\end{equation}
which seems a reasonably property for dividing an entropy over $n_e$ electrons.

Even after splitting the entropy up over different electrons there is still
another problem. In Eq.~\ref{Eq:TrSr} for a given pair of electrons the fact
that the entropy of electron 1 may be different from the entropy of electron 2
leads to an unphysical result. Namely the result that the interaction of 
electron 1 with electron 2 is of a different strength than the interaction
of electron 2 with electron 1. This clearly violates the third law of Newton's
laws of motion. This serious problem can be addressed by rewriting Eq.~\ref{Eq:TrSr}
as 
\begin{eqnarray}
   F &=& H+W-\sum_{r,s=1}^{n_e}T_{rs}S_{rs}
   \label{Eq:TrsSrs}
\end{eqnarray}
whereby it is used that the temperature is a linear function that sums just 
the electron pair interactions. Hence an effective temperature contribution
can be assigned to every electron pair. Based on Eq.~\ref{Eq:TrsSrs} 
we need to evaluate an entropy for every electron pair. The corresponding pair
entropy has to include the entropies of both individual electrons as well
as the entropy of the 2-electron density matrix for the pair of electrons.
In part this expression exploits the fact that the temperature is a linear
expression in terms of the electron pair interations.
In the above expression the pair entropy $S_{rs}$ is given by
\begin{eqnarray}
  S_{rs} &=& S^{(1)}_r + S^{(1)}_s - S^{(2)}_{rs}
\end{eqnarray}
Alternatively we may write Eq.~\ref{Eq:TrsSrs} as 
\begin{eqnarray}
   F &=& H+\frac{1}{2}\sum_{r,s=1}^{n_e}W_{rs}(1-S_{rs})
   \label{Eq:CoulombQuench_rs}
\end{eqnarray}
Note that the 2-electron entropy may involve different expressions for different
blocks of the 2-electron density matrix. In the light of these changes the entropy
definitions need to be modified a bit to give
\begin{eqnarray}
   S^{(1)}_r &=& -\sum_{i=1}^{n_b}\frac{d_i^{(r)}}{d_i}S^{(1)}(d_i)
   \label{Eq:entropy1partfin} \\
   S^{(1)}(d_i) &=&
   \left\{d_i\ln(d_i)+(1-d_i)\ln(1-d_i)\right\} \\
   S^{(2)}_{r\bar{s}} &=& -\sum_{i,\bar{j}=1}^{n_b}
           \left\{\frac{d_{i}^{(r)}d_{\bar{j}}^{(\bar{s})}}{d_{i}d_{\bar{j}}}\right\}
           S^{(2)}(d_{i},d_{\bar{j}})
   \label{Eq:entropy2partfinab} \\
   S^{(2)}(d_{i},d_{\bar{j}}) &=&
           \left\{d_{i}d_{\bar{j}}\ln(d_{i}d_{\bar{j}})
           +(1-d_{i})(1-d_{\bar{j}})\ln((1-d_{i})(1-d_{\bar{j}}))\right\} \\
   S^{(2)}_{rs} &=& -\sum_{i,\bar{j}=1}^{n_b}
           \left\{\frac{d_{ij}^{(rs)}}{d_{ij}}\right\}
           S^{(2)}(d_{ij})
   \label{Eq:entropy2partfinaa} \\
   S^{(2)}(d_{ij}) &=&
           \left\{\sqrt{d_{ij}}\sqrt{d_{ij}}\ln(\sqrt{d_{ij}}\sqrt{d_{ij}})
           +(1-\sqrt{d_{ij}})(1-\sqrt{d_{ij}})
            \ln((1-\sqrt{d_{ij}})(1-\sqrt{d_{ij}}))\right\}
\end{eqnarray}
In these equations the bar is used to indicate labels of opposite spin. Note that in 
the 2-electron entropies the division by the number of electrons has been removed. 
This is a consequence of handling both the 1-electron entropy and the 2-electron 
entropy on a per electron pair basis.

In practice we need to deal with a few more problems. 
\begin{itemize}
\item The factors used to attribute fractions of the entropy to individual electrons
      will cause numerical issues when differentiated. Hence it would be better
      to get rid of them.
\item The entropy for a pair of states is supposed to describe correlation. That
      means the entropy should vanish if one of the two states is not correlated.
      I.e. $S_{rs}$ should be 0 if $d_i$ or $d_j$ equals 0 or 1.
\item The Stirling approximation used to get terms as $d_i\ln(d_i)$ has serious
      artifacts. Hence it would be better to use $\ln(d_i!)$ instead.
\end{itemize}
To deal with the first two points we may replace $S_{rs}$ with $S_{ij}$ where we 
define
\begin{eqnarray}
  S_{ij} &=& S_{i}^{(1)}+S_{j}^{(1)}-S_{ij}^{(2)} \\
  S_{i}^{(1)} &=& \ln(d_i!) + \ln([1-d_i]!) \label{Eq:S1}
\end{eqnarray}
The third point requires to reformulate the $S^{(2)}$ term. The expression
\begin{eqnarray}
  S_{ij}^{(2)} &=& \ln([d_id_j]!)+\ln([(1-d_i)d_j]!)
                +  \ln([d_i(1-d_j)]!)+\ln([(1-d_i)(1-d_j)]!) \label{Eq:S2}
\end{eqnarray}
For example if $d_i=0$ then
\begin{eqnarray}
  S_{ij}^{(2)} &=& 0+\ln(d_j!)+0+\ln([1-d_j]!)
\end{eqnarray}
which exactly cancels $S_{j}^{(1)}$. The resulting function is shown in~\ref{Fig1}.
Clearly this function has the characteristics needed. If any of the natural orbital
are uncorrelated the entropy is 0. If both natural orbitals are half occupied the
correlation is maximal.

\begin{figure}
\include{Sij}
\caption{The 2D entropy function}
\label{Fig1}
\end{figure}

Note that in practice $\ln(d!)$ is typically implemented as $\ln(\Gamma(1+d))$. The
first order derivative of $\ln(\Gamma(x))$ is called the digamma function denoted as
$\psi_0(x)$. This means that Eqs.~\ref{Eq:S1} and \ref{Eq:S2} can be rephrased as
\begin{eqnarray}
  S_{i}^{(1)}  &=& \ln\left(\Gamma\left(1+d_i\right)\right)
                +  \ln\left(\Gamma\left(2-d_i\right)\right) \\
  S_{ij}^{(2)} &=& \ln\left(\Gamma\left(1+d_i d_j\right)\right)
                +  \ln\left(\Gamma\left(1+\left[1-d_i\right]d_j\right)\right)
                +  \ln\left(\Gamma\left(1+d_i\left[1-d_j\right]\right)\right)
                +  \ln\left(\Gamma\left(1+\left[1-d_i\right]\left[1-d_j\right]\right)\right)
\end{eqnarray}

In order to optimize the energy with the expressions above we need to differentiate
them. 

\begin{eqnarray}
  \frac{\partial S_{i}^{(1)}}{\partial C_{it}}
  &=& \psi_0(1+d_i)\frac{\partial d_i}{\partial C_{it}}
   -  \psi_0(2-d_i)\frac{\partial d_i}{\partial C_{it}} \\
  \frac{\partial S_{ij}^{(2)}}{\partial C_{it}}
  &=& \psi_0(1+d_id_j)d_j\frac{\partial d_i}{\partial C_{it}}
   -  \psi_0(1+[1-d_i]d_j)d_j\frac{\partial d_i}{\partial C_{it}} \nonumber \\
  &+& \psi_0(1+d_i[1-d_j])[1-d_j]\frac{\partial d_i}{\partial C_{it}}
   -  \psi_0(1+[1-d_i][1-d_j])[1-d_j]\frac{\partial d_i}{\partial C_{it}}
\end{eqnarray}

\section{Optimizing the wave function}

The wave function may be optimized by starting from an energy expression with appropriate
Lagrangians and minimizing it. An approach similar to that of our previous
paper~\cite{van_Dam_2016} is used. There is a difference because the energy expression in
this work cannot be represented entirely in terms of one-electron density matrices as
the two-electron term is orbital dependent. This means that the trick of multiplying
the Lagrangian for the natural orbitals with the occupation numbers to enable arriving
at the Kohn-Sham equations for those orbitals cannot be used here. Like in our previous
work we will derive the derivatives with respect to the $\alpha$-spin channel variables
only as the $\beta$-spin channel derivatives are the same. Thus we consider the
problem
\begin{eqnarray}
  L &=&
  E(N^\alpha,C^\alpha;N^\beta,C^\beta)
  + \sum_{\sigma=\{\alpha,\beta\}}\sum_{i,j=1}^{n_b}\lambda^{N^\sigma}_{ij}
    \left(I_{ij}-\sum_{a,b=1}^{n_b}N^{\sigma*}_{ai}S_{ab}N^\sigma_{bj}\right) 
    \nonumber \\
  &&+ \sum_{\sigma=\{\alpha,\beta\}}\sum_{r,s=1}^{n_b}\lambda^{C^\sigma}_{rs}
      \left(I_{rs}-\sum_{i,j=1}^{n_b}C^{\sigma*}_{ir}I_{ij}C^\sigma_{js}\right) \\
  && \min_{N^\alpha,C^\alpha,\lambda^{N^\alpha}_{ij},\lambda^{C^\alpha}_{rs}} L
\end{eqnarray}
Before continuing the energy expression $E(N^\alpha,C^\alpha;N^\beta,C^\beta)$
must be clarified. In general the energy expression may be written as
\begin{eqnarray}
  E(N^\alpha,C^\alpha;N^\beta,C^\beta)
  &=& \sum_{\sigma,\sigma'=\{\alpha,\beta\}}
      \left(\sum_{a,b=1}^{n_b}\frac{1}{2}h_{ab}D^\sigma_{ab}
   +  \sum_{r,s=1}^{n_b}W^{\sigma\sigma'}_{rs}
      \left(\frac{1}{2}-S^{\sigma\sigma'}_{rs}\right)\right)
  \label{Eq:ENC}
\end{eqnarray}

In the subsequent derivations the derivatives w.r.t. the $\alpha$-spin channel will be
given. The equations for the $\beta$-spin channel can be obtained by interchanging the
the $\alpha$ and $\beta$ spin labels.

For the orthogonality of the natural orbitals we obtain from
$\partial L/\partial\lambda^{C\alpha}_{rs} = 0$
\begin{eqnarray}
  \sum_{i,j=1}^{n_b}C^{\alpha*}_{ir}I_{ij}C^\alpha_{js} &=& I_{rs}
\end{eqnarray}
Likewise for the natural orbitals
$\partial L/\partial\lambda^{N\alpha}_{ij} = 0$ gives
\begin{eqnarray}
  \sum_{a,b=1}^{n_b}N^{\alpha*}_{ai}S_{ab}N^\alpha_{bj} &=& I_{ij}
\end{eqnarray}

Considering derivatives w.r.t. the natural orbitals there are only two relevant
quantities. Those are the one-electron energy terms of Eq.~\ref{Eq:ENC} and the 
electron temperatures. The entropy depends only on the correlation functions
and hence has no non-zero derivatives w.r.t. the natural orbitals.

Differentiating the one-electron energy terms we obtain
\begin{eqnarray}
  \frac{\partial}{\partial N^{*}_{ek}}\sum_{a,b=1}^{n_b}h_{ab}D_{ab}
  &=& \frac{\partial}{\partial N^{*}_{ek}}
      \sum_{a,b,i=1}^{n_b}h_{ab}N_{ai}d_iN^*_{bi} \\
  &=& \sum_{a,b,i=1}^{n_b}h_{ab}N_{ai}d_i\delta_{eb}\delta_{ki} \\
  &=& \sum_{a,i=1}^{n_b}h_{ae}N_{ai}d_i\delta_{ki} \\
  &=& \sum_{a=1}^{n_b}h_{ae}N_{ak}d_k 
\end{eqnarray}
This derivative may be transformed into the natural orbital basis to give
\begin{eqnarray}
  \sum_{a,e=1}^{n_b}h_{ae}N_{ak}d_k N^*_{el}
  &=& d_k h_{kl}
\end{eqnarray}
The result is a matrix where the rows are scaled by the occupation numbers
of the natural orbitals.

Next we consider the derivative of the temperature of an electron pair
occupying generalized orbitals $r$ and $s$. Here Eq.~\ref{Eq:Tr} is replaced by
the $W$ from Eq.~\ref{Eq:ENC} slightly as
\begin{eqnarray}
   W_{rs} &=& \sum_{a,b,c,d=1}^{n_b}(ab|cd)\Gamma_{abcd}^{(rs)}
\end{eqnarray}
The derivative of the temperature depends on the derivatives of $\Gamma$ given by
\begin{eqnarray}
  \frac{\partial}{\partial N^{*}_{ek}}W_{rs}
  &=& \sum_{a,b,c,d=1}^{n_b}(ab|cd)
      \frac{\partial}{\partial N^{*}_{ek}}\Gamma_{abcd}^{(rs)} \\
  \frac{\partial}{\partial N^{*}_{ek}}\Gamma_{abcd}^{(rs)}
  &=& \left(\sum_{i=1}^{n_b}N_{ai}C_{ir}C^*_{ir}\delta_{ce}\delta_{ik}\right)
      \left(\sum_{j=1}^{n_b}N_{bj}C_{js}C^*_{js}N^*_{dj}\right) \nonumber \\
  &&+ \left(\sum_{i=1}^{n_b}N_{ai}C_{ir}C^*_{ir}N^*_{ci}\right)
      \left(\sum_{j=1}^{n_b}N_{bj}C_{js}C^*_{js}\delta_{de}\delta_{jk}\right) 
      \nonumber \\
  &&- \left(\sum_{i=1}^{n_b}N_{ai}C_{ir}C^*_{is}\delta_{ce}\delta_{ik}\right)
      \left(\sum_{j=1}^{n_b}N_{bj}C_{js}C^*_{jr}N^*_{dj}\right) \nonumber \\
  &&- \left(\sum_{i=1}^{n_b}N_{ai}C_{ir}C^*_{is}N^*_{ci}\right)
      \left(\sum_{j=1}^{n_b}N_{bj}C_{js}C^*_{jr}\delta_{de}\delta_{jk}\right) \\
  &=& \left(N_{ak}C_{kr}C^*_{kr}\delta_{ce}\right)
      \left(\sum_{j=1}^{n_b}N_{bj}C_{js}C^*_{js}N^*_{dj}\right) \nonumber \\
  &&+ \left(\sum_{i=1}^{n_b}N_{ai}C_{ir}C^*_{ir}N^*_{ci}\right)
      \left(N_{bk}C_{ks}C^*_{ks}\delta_{de}\right) 
      \nonumber \\
  &&- \left(N_{ak}C_{kr}C^*_{ks}\delta_{ce}\right)
      \left(\sum_{j=1}^{n_b}N_{bj}C_{js}C^*_{jr}N^*_{dj}\right) \nonumber \\
  &&- \left(\sum_{i=1}^{n_b}N_{ai}C_{ir}C^*_{is}N^*_{ci}\right)
      \left(N_{bk}C_{ks}C^*_{kr}\delta_{de}\right) \\
  \frac{\partial}{\partial N^{*}_{ek}}\Gamma_{abcd}^{(rs')}
  &=& \left(N_{ak}C_{kr}C^*_{kr}\delta_{ce}\right)
      \left(\sum_{j'=1}^{n_b}N'_{bj'}C'_{j's'}C'^*_{j's'}N'^*_{dj'}\right)
\end{eqnarray}
Considering the contraction of these derivatives with the two-electron integrals
equations similar to those for the Fock matrix are obtained. The difference, like for 
the one-electron terms, comes from the fact that the rows are scaled with the
occupation numbers. Unlike in the previous paper~\cite{van_Dam_2016} where the energy
expression was given entirely in terms of the total one-electron density matrix, here
the exchange contributions are scaled products of correlation function coefficients 
corresponding to different generalized orbitals. This means that we cannot separate
the occupation numbers out like was done in~\cite{van_Dam_2016}.

Next considering the derivatives w.r.t. to the correlation functions there are three 
terms or factors to consider. They are the one-electron energy terms, the two-electron
terms, and the entropy. Considering the one-electron energy terms we have
\begin{eqnarray}
  \frac{\partial}{\partial C^{*}_{kt}}\sum_{a,b=1}^{n_b}h_{ab}D_{ab}
  &=& \frac{\partial}{\partial C^{*}_{kt}}\sum_{a,b,i=1}^{n_b}\sum_{r=1}^{n_e}
      h_{ab}N_{ai}C_{ir}C^*_{ir}N^*_{bi} \\
  &=& \sum_{a,b,i=1}^{n_b}\sum_{r=1}^{n_e}
      h_{ab}N_{ai}C_{ir}N^*_{bi}\delta_{ik}\delta_{rt} \\
  &=& \sum_{a,b=1}^{n_b}
      h_{ab}N_{ak}C_{kt}N^*_{bk}
\end{eqnarray}
Regarding the temperature we get
\begin{eqnarray}
  \frac{\partial}{\partial C^{*}_{kt}}W_{rs}
  &=& \sum_{a,b,c,d=1}^{n_b}(ab|cd)
      \frac{\partial}{\partial C^{*}_{kt}}\Gamma_{abcd}^{(rs)} \\
  \frac{\partial}{\partial C^{*}_{kt}}\Gamma_{abcd}^{(rs)}
  &=& \frac{1}{2}\left[
      \sum_{r,s=1}^{n_e}
      \left(\sum_{i=1}^{n_b} N_{ai}C_{ir}N^*_{ci}\delta_{ik}\delta_{rt}\right)
      \left(\sum_{j=1}^{n_b} N_{bj}C_{js}C^*_{js}N^*_{dj}\right)
      \right.
      \nonumber \\
  &&+ \sum_{r,s=1}^{n_e}
      \left(\sum_{i=1}^{n_b} N_{ai}C_{ir}C^*_{ir}N^*_{ci}\right)
      \left(\sum_{j=1}^{n_b} N_{bj}C_{js}N^*_{dj}\delta_{jk}\delta_{st}\right)
      \nonumber \\
  &&- \sum_{r,s=1}^{n_e}
      \left(\sum_{i=1}^{n_b} N_{ai}C_{ir}N^*_{ci}\delta_{ik}\delta_{st}\right)
      \left(\sum_{j=1}^{n_b} N_{bj}C_{js}C^*_{jr}N^*_{dj}\right)
      \nonumber \\
  &&- \left.
      \sum_{r,s=1}^{n_e}
      \left(\sum_{i=1}^{n_b} N_{ai}C_{ir}C^*_{is}N^*_{ci}\right)
      \left(\sum_{j=1}^{n_b} N_{bj}C_{js}N^*_{dj}\delta_{jk}\delta_{rt}\right)
      \right] \\
  &=& \frac{1}{2}\left[
      \sum_{s=1}^{n_e}
      \left(                 N_{ak}C_{kt}N^*_{ck}\right)
      \left(\sum_{j=1}^{n_b} N_{bj}C_{js}C^*_{js}N^*_{dj}\right)
      \right.
      \nonumber \\
  &&+ \sum_{r=1}^{n_e}
      \left(\sum_{i=1}^{n_b} N_{ai}C_{ir}C^*_{ir}N^*_{ci}\right)
      \left(                 N_{bk}C_{kt}N^*_{dk}\right)
      \nonumber \\
  &&- \sum_{r=1}^{n_e}
      \left(                 N_{ak}C_{kr}N^*_{ck}\right)
      \left(\sum_{j=1}^{n_b} N_{bj}C_{jt}C^*_{jr}N^*_{dj}\right)
      \nonumber \\
  &&- \left.
      \sum_{s=1}^{n_e}
      \left(\sum_{i=1}^{n_b} N_{ai}C_{it}C^*_{is}N^*_{ci}\right)
      \left(                 N_{bk}C_{ks}N^*_{dk}\right)
      \right]
      \label{Eq:2densmat_aa_dC}
  \\
  \frac{\partial}{\partial C^{*}_{kt}}\Gamma_{abcd}^{(rs')}
  &=& \sum_{s'=1}^{n_e}\frac{1}{2}
      \left(                  N_{ak}C_{kt}N^*_{ck}\right)
      \left(\sum_{j'=1}^{n_b} N_{b'j'}C_{j's'}C^*_{j's'}N^*_{d'j'}\right)
      \label{Eq:2densmat_ab_dC}
\end{eqnarray}

The next aspect to consider is the entropy. Here two factors play an important
role: 1. The entropy expressions themselves; 2. The factors that partition the
entropy into contributions of individual electrons.
As the entropy is expressed in terms of the occupation numbers it would seem
sensible to start with differentiating those. Also note that the occupation
numbers depend only on the correlation coefficients and not on the natural
orbital coefficient. Hence a smaller set of equations will be needed.
\begin{eqnarray}
   \frac{\partial}{\partial C^*_{kt}}d^{(r)}_i
   &=& \frac{\partial}{\partial C^*_{kt}}C_{ir}C^*_{ir} \\
   &=& C_{ir}\delta_{ik}\delta_{rt} \\
   &=& C_{kt}\delta_{ik}\delta_{rt} \\
   \frac{\partial}{\partial C^*_{kt}}d_i
   &=& \frac{\partial}{\partial C^*_{kt}}\sum_{r=1}^{n_e}C_{ir}C^*_{ir} \\
   &=& \sum_{r=1}^{n_e}C_{ir}\delta_{ik}\delta_{rt} \\
   &=& \left\{\begin{array}{cc}
              C_{kt}\delta_{ik}, & t \le n_e \\
              0, & t > n_e \\
              \end{array}\right.\\
   \frac{\partial}{\partial C^*_{kt}}\frac{d^{(r)}_i}{d_i}
   &=& \frac{C_{kt}\delta_{ik}\delta_{rt}}{d_i}
      -\frac{d^{(r)}_iC_{kt}\delta_{ik}}{d_i^2} \\
   \frac{\partial}{\partial C^*_{kt}}S^{(1)}(d_i)
   &=& \frac{\partial S^{(1)}(d_i)}{\partial d_i}\frac{\partial d_i}{C^*_{kt}} \\
   \frac{\partial}{\partial d_i}S^{(1)}(d_i)
   &=& \ln(d_i) + 1 - \ln(1-d_i) - 1\\
   &=& \ln(d_i) - \ln(1-d_i)
\end{eqnarray}
A likewise scenario arises for the entropy related to the two electron 
density matrix.

For the two-electron density matrix occupation numbers we get
\begin{eqnarray}
   \frac{\partial}{\partial C^*_{kt}}d^{(rs)}_{ij}
   &=& \frac{\partial}{\partial C^*_{kt}}\left(
         C_{ir}C^*_{ir}C_{js}C^*_{js}
       - C_{ir}C^*_{is}C_{js}C^*_{jr}
       \right) \\
   &=& C_{ir}\delta_{ik}\delta_{rt}C_{js}C^*_{js}
    +  C_{ir}C^*_{ir}C_{js}\delta_{jk}\delta_{st} \nonumber \\
   &&- C_{ir}\delta_{ik}\delta_{st}C_{js}C^*_{jr}
    -  C_{ir}C^*_{is}C_{js}\delta_{jk}\delta_{rt} \\
   \frac{\partial}{\partial C^*_{kt}}d_{ij}
   &=  \frac{\partial}{\partial C^*_{kt}}&\sum_{r,s=1}^{n_e}\left(
         C_{ir}C^*_{ir}C_{js}C^*_{js}
       - C_{ir}C^*_{is}C_{js}C^*_{jr}
       \right) \\
   &=  \sum_{r,s=1}^{n_e}&\left(C_{ir}\delta_{ik}\delta_{rt}C_{js}C^*_{js}
    +  C_{ir}C^*_{ir}C_{js}\delta_{jk}\delta_{st}\right. \nonumber \\
   &&- \left.C_{ir}\delta_{ik}\delta_{st}C_{js}C^*_{jr}
    -  C_{ir}C^*_{is}C_{js}\delta_{jk}\delta_{rt}\right) \\
   &=  \sum_{r=1}^{n_e}&\left(C_{it}\delta_{ik}C_{jr}C^*_{jr}
    +  C_{ir}C^*_{ir}C_{jt}\delta_{jk}\right. \nonumber \\
   &&- \left.C_{ir}\delta_{ik}C_{jt}C^*_{jr}
    -  C_{it}C^*_{ir}C_{jr}\delta_{jk}\right) \\
   \frac{\partial}{\partial C^*_{kt}}S^{(2)}(d_{ij})
   &=& \frac{\partial S^{(2)}(d_{ij})}{\partial d_{ij}}\frac{\partial d_{ij}}{C^*_{kt}} \\
\end{eqnarray}

We need to differentiate the 2-electron density matrix wrt. the natural orbitals and the
correlation functions. We start from Eq.(\ref{Eq:2densmat_3}) and we differentiate wrt.
$N^*_{ek}$
\begin{eqnarray}
  \frac{\partial\Gamma_{abcd}}{\partial N^*_{ek}}
  &=& \frac{1}{4}
      \left[
      \left(\sum_{i,j=1}^{n_b} N_{ai}\delta_{ec}\delta_{ki}N_{bj}N^*_{dj}d_{ij}\right)
     +\left(\sum_{i,j=1}^{n_b} N_{ai}N^*_{ci}N_{bj}\delta_{ed}\delta_{kj}d_{ij}\right)
      \right.
      \nonumber \\
  &&+ \left(\sum_{i,j=1}^{n_b} N_{bi}\delta_{ed}\delta_{ki}N_{aj}N^*_{cj}d_{ij}\right)
    + \left(\sum_{i,j=1}^{n_b} N_{bi}N^*_{di}N_{aj}\delta_{ec}\delta_{kj}d_{ij}\right)
      \nonumber \\
  &&- \left(\sum_{i,j=1}^{n_b} N_{ai}\delta_{ed}\delta_{ki}N_{bj}N^*_{cj}d_{ij}\right)
    - \left(\sum_{i,j=1}^{n_b} N_{ai}N^*_{di}N_{bj}\delta_{ec}\delta_{kj}d_{ij}\right)
      \nonumber \\
  &&- \left.
      \left(\sum_{i,j=1}^{n_b} N_{bi}\delta_{ec}\delta_{ki}N_{aj}N^*_{dj}d_{ij}\right)
    - \left(\sum_{i,j=1}^{n_b} N_{bi}N^*_{ci}N_{aj}\delta_{ed}\delta_{kj}d_{ij}\right)
      \right] \\
  &= \frac{1}{4} &
      \left[
      \left(\sum_{j=1}^{n_b} N_{ak}\delta_{ec}N_{bj}N^*_{dj}d_{kj}\right)
     +\left(\sum_{i=1}^{n_b} N_{ai}N^*_{ci}N_{bk}\delta_{ed}d_{ik}\right)
      \right.
      \nonumber \\
  &&+ \left(\sum_{j=1}^{n_b} N_{bk}\delta_{ed}N_{aj}N^*_{cj}d_{kj}\right)
    + \left(\sum_{i=1}^{n_b} N_{bi}N^*_{di}N_{ak}\delta_{ec}d_{ik}\right)
      \nonumber \\
  &&- \left(\sum_{j=1}^{n_b} N_{ak}\delta_{ed}N_{bj}N^*_{cj}d_{kj}\right)
    - \left(\sum_{i=1}^{n_b} N_{ai}N^*_{di}N_{bk}\delta_{ec}d_{ik}\right)
      \nonumber \\
  &&- \left.
      \left(\sum_{j=1}^{n_b} N_{bk}\delta_{ec}N_{aj}N^*_{dj}d_{kj}\right)
    - \left(\sum_{i=1}^{n_b} N_{bi}N^*_{ci}N_{ak}\delta_{ed}d_{ik}\right)
      \right]
      \label{Eq:2densmat_dN}
\end{eqnarray}
Next we differentiate Eq.(\ref{Eq:2densmat_3}) wrt. $C^*_{kr}$. As the equation does not
depend on the correlation function coefficients explicitly the correlation function 
Fock matrix is generated mainly through the derivative of Eq.(\ref{Eq:2occupation_3}).
Hence we first consider the derivatives of the occupation numbers:
\begin{eqnarray}
  \frac{\partial d_{ij}}{\partial C^*_{kr}}
  &=& \sum_{s,t=1}^{n_e}
      C_{is}\delta_{ik}\delta_{sr}C_{jt}C^*_{jt}
     +C_{is}C^*_{is}C_{jt}\delta_{jk}\delta_{tr}
     -C_{is}\delta_{ik}\delta_{tr}C_{jt}C^*_{js}
     -C_{is}C^*_{it}C_{jt}\delta_{jk}\delta_{sr} \\
  &=& \sum_{s=1}^{n_e}
      C_{ir}\delta_{ik}C_{js}C^*_{js}
     +C_{is}C^*_{is}C_{jr}\delta_{jk}
     -C_{is}\delta_{ik}C_{jr}C^*_{js}
     -C_{ir}C^*_{is}C_{js}\delta_{jk}
     \label{Eq:deriv_2occupation}
\end{eqnarray}
Substituting Eq.(\ref{Eq:deriv_2occupation}) into Eq.(\ref{Eq:2densmat_3}) gives
\begin{eqnarray}
  \frac{\partial\Gamma_{abcd}}{\partial C^*_{kr}}
  &=& \frac{1}{4}\left[\sum_{i,j=1}^{n_b}\sum_{s=1}^{n_e}\left(
      N_{ai}N^*_{ci}N_{bj}N^*_{dj}+N_{bi}N^*_{di}N_{aj}N^*_{cj}
      -N_{ai}N^*_{di}N_{bj}N^*_{cj}-N_{bi}N^*_{ci}N_{aj}N^*_{dj}\right)\right.
      \nonumber \\
  &&  \left.\left(C_{ir}\delta_{ik}C_{js}C^*_{js}+C_{is}C^*_{is}C_{jr}\delta_{jk}
      -C_{is}\delta_{ik}C_{jr}C^*_{js}-C_{ir}C^*_{is}C_{js}\delta_{jk}\right)\right]
%     \\
% &=& \frac{1}{4}\left[\sum_{i,j=1}^{n_b}\sum_{s=1}^{n_e}\left(
%     N_{ai}N^*_{ci}N_{bj}N^*_{dj}+N_{bi}N^*_{di}N_{aj}N^*_{cj}
%     -N_{ai}N^*_{di}N_{bj}N^*_{cj}-N_{bi}N^*_{ci}N_{aj}N^*_{dj}\right)\right.
%     \nonumber \\
% &&  \left.\left(C_{ir}\delta_{ik}C_{js}C^*_{js}+C_{js}C^*_{js}C_{ir}\delta_{ik}
%     -C_{is}\delta_{ik}C_{jr}C^*_{js}-C_{jr}C^*_{js}C_{is}\delta_{ik}\right)\right] \\
% &=& \frac{1}{4}\left[\sum_{j=1}^{n_b}\sum_{s=1}^{n_e}\left(
%     N_{ak}N^*_{ck}N_{bj}N^*_{dj}+N_{bk}N^*_{dk}N_{aj}N^*_{cj}
%     -N_{ak}N^*_{dk}N_{bj}N^*_{cj}-N_{bk}N^*_{ck}N_{aj}N^*_{dj}\right)\right.
%     \nonumber \\
% &&  \left.\left(C_{kr}C_{js}C^*_{js}+C_{js}C^*_{js}C_{kr}
%     -C_{ks}C_{jr}C^*_{js}-C_{jr}C^*_{js}C_{ks}\right)\right] \\
% &=& \frac{1}{2}\left[\sum_{j=1}^{n_b}\sum_{s=1}^{n_e}\left(
%     N_{ak}N^*_{ck}N_{bj}N^*_{dj}+N_{bk}N^*_{dk}N_{aj}N^*_{cj}
%     -N_{ak}N^*_{dk}N_{bj}N^*_{cj}-N_{bk}N^*_{ck}N_{aj}N^*_{dj}\right)\right.
%     \nonumber \\
% &&  \left.\left(C_{kr}C_{js}C^*_{js}-C_{ks}C_{jr}C^*_{js}\right)\right] \\
\end{eqnarray}
Of course we want a sensible total derivative hence we need to sum over all $k$. 
\begin{eqnarray}
  \sum_{k=1}^{n_b}\frac{\partial\Gamma_{abcd}}{\partial C^*_{kr}}
  &=& \frac{1}{4}\left[\sum_{i,j,k=1}^{n_b}\sum_{s=1}^{n_e}\left(
      N_{ai}N^*_{ci}N_{bj}N^*_{dj}+N_{bi}N^*_{di}N_{aj}N^*_{cj}
      -N_{ai}N^*_{di}N_{bj}N^*_{cj}-N_{bi}N^*_{ci}N_{aj}N^*_{dj}\right)\right.
      \nonumber \\
  &&  \left.\left(C_{ir}\delta_{ik}C_{js}C^*_{js}+C_{is}C^*_{is}C_{jr}\delta_{jk}
      -C_{is}\delta_{ik}C_{jr}C^*_{js}-C_{ir}C^*_{is}C_{js}\delta_{jk}\right)\right] \\
  &=& \frac{1}{4}\left[\sum_{i,j,k=1}^{n_b}\sum_{s=1}^{n_e}
      \left(
      N_{ai}N^*_{ci}N_{bj}N^*_{dj}+N_{bi}N^*_{di}N_{aj}N^*_{cj}
      -N_{ai}N^*_{di}N_{bj}N^*_{cj}-N_{bi}N^*_{ci}N_{aj}N^*_{dj}\right)\right.
      \nonumber \\
  &&  \left(C_{ir}\delta_{ik}C_{js}C^*_{js}-C_{is}\delta_{ik}C_{jr}C^*_{js}\right)
      \nonumber \\
  &&  +\left(
      N_{ai}N^*_{ci}N_{bj}N^*_{dj}+N_{bi}N^*_{di}N_{aj}N^*_{cj}
      -N_{ai}N^*_{di}N_{bj}N^*_{cj}-N_{bi}N^*_{ci}N_{aj}N^*_{dj}\right)
      \nonumber \\
  &&  \left.\left(C_{is}C^*_{is}C_{jr}\delta_{jk}-C_{ir}C^*_{is}C_{js}\delta_{jk}\right)\right] \\
  &=& \frac{1}{4}\left[\sum_{i,j,k=1}^{n_b}\sum_{s=1}^{n_e}
      \left(
      N_{ai}N^*_{ci}N_{bj}N^*_{dj}+N_{bi}N^*_{di}N_{aj}N^*_{cj}
      -N_{ai}N^*_{di}N_{bj}N^*_{cj}-N_{bi}N^*_{ci}N_{aj}N^*_{dj}\right)\right.
      \nonumber \\
  &&  \left(C_{ir}\delta_{ik}C_{js}C^*_{js}-C_{is}\delta_{ik}C_{jr}C^*_{js}\right)
      \nonumber \\
  &&  +\left(
      N_{aj}N^*_{cj}N_{bi}N^*_{di}+N_{bj}N^*_{dj}N_{ai}N^*_{ci}
      -N_{aj}N^*_{dj}N_{bi}N^*_{ci}-N_{bj}N^*_{cj}N_{ai}N^*_{di}\right)
      \nonumber \\
  &&  \left.\left(C_{js}C^*_{js}C_{ir}\delta_{ik}-C_{jr}C^*_{js}C_{is}\delta_{ik}\right)\right] \\
  &=& \frac{1}{2}\left[\sum_{i,j,k=1}^{n_b}\sum_{s=1}^{n_e}
      \left(
      N_{ai}N^*_{ci}N_{bj}N^*_{dj}+N_{bi}N^*_{di}N_{aj}N^*_{cj}
      -N_{ai}N^*_{di}N_{bj}N^*_{cj}-N_{bi}N^*_{ci}N_{aj}N^*_{dj}\right)\right.
      \nonumber \\
  &&  \left.\left(C_{ir}\delta_{ik}C_{js}C^*_{js}-C_{is}\delta_{ik}C_{jr}C^*_{js}\right)\right] \\
  &=& \frac{1}{2}\left[\sum_{j,k=1}^{n_b}\sum_{s=1}^{n_e}
      \left(
      N_{ak}N^*_{ck}N_{bj}N^*_{dj}+N_{bk}N^*_{dk}N_{aj}N^*_{cj}
      -N_{ak}N^*_{dk}N_{bj}N^*_{cj}-N_{bk}N^*_{ck}N_{aj}N^*_{dj}\right)\right.
      \nonumber \\
  &&  \left.\left(C_{kr}C_{js}C^*_{js}-C_{ks}C_{jr}C^*_{js}\right)\right] \\
  &=& \frac{1}{2}\left[\sum_{j,k=1}^{n_b}\sum_{s=1}^{n_e}
      \left(
      N_{ak}N^*_{ck}N_{bj}N^*_{dj}+N_{bk}N^*_{dk}N_{aj}N^*_{cj}
      -N_{ak}N^*_{dk}N_{bj}N^*_{cj}-N_{bk}N^*_{ck}N_{aj}N^*_{dj}\right)
      C_{kr}C_{js}C^*_{js}\right.
      \nonumber \\
  && -\left.\left(
      N_{aj}N^*_{cj}N_{bk}N^*_{dk}+N_{bj}N^*_{dj}N_{ak}N^*_{ck}
      -N_{aj}N^*_{dj}N_{bk}N^*_{ck}-N_{bj}N^*_{cj}N_{ak}N^*_{dk}\right)
      C_{js}C_{kr}C^*_{ks}\right] \\
\end{eqnarray}



\section{Notes}

\subsection{Orbital updates}

In the implementation we developed previously we used a special expression that can be
expressed as follows. Let $U$ and $V$ be unitary matrices. Let $C$ be a matrix of 
correlation functions and $N$ be a matrix of natural orbitals. After an update new 
natural orbitals $N'$ are obtained as well as new correlation functions $C'$. 
Now we formulated the new matrices in terms of the old matrices as follows:
\begin{eqnarray}
   N' &=& NU \\
   C' &=& U^T C \\
   C' &=& CV
\end{eqnarray}
formulated more explicitly
\begin{eqnarray}
   N'_{aj} &=& \sum_i N_{ai}U_{ij} \\
   C'_{js} &=& \sum_i U_{ij}C_{is} \\
   C'_{js} &=& \sum_i C_{jt}V_{ts}
\end{eqnarray}
A bit of analysis shows that the coupled update of the natural orbitals and the
correlation functions is very confusing at best. Because $U$ is a unitary matrix
the two transformations essentially cancel eachother in the density matrix update.
This coupling might be different depending on the structure of a particular matrix
but even in that case it would be hard to say something about the transformation
in general. Hence let's drop the coupled natural orbital and correlation function
updates.

The one advantage of the coupled update is that it preserve the relationship
between the natural orbitals and the correlation functions. Remember that the
correlation functions are expressed in terms of the natural orbitals which are
in turn expressed in terms of the atomic orbitals. If the natural orbitals are
updated without an update to the correlation functions then the correlation
functions end up being expressed in terms of natural orbitals that no longer
exist. Clearly that situation is problematic.

It turns out that the this coupled update is a Bogoliubov transformation which is
what common implementations of Thermo Field Dynamics depend on. Given that attempts
to solve the equations without using this coupled update converge extremely 
slowly (if at all) it would seem that we need to investigate this type of
transformation. Investigating the solution for $V$ is straightforward as that is
the problem we have already solved but in a slightly different form. Solving 
for $U$ is different because we now need to differentiate an energy expression
given in terms of a matrix that simultaneously transforms both the natural orbitals
and the correlation functions. 

Given that $U$ is a unitary matrix we have that it must satisfy the following
conditions
\begin{eqnarray}
   UU^T-I &=& 0 \\
   U^TU-I &=& 0
\end{eqnarray}
differentiating these conditions we get
\begin{eqnarray}
  0 &=& \sum_{mn}\frac{\partial\sum_{j}U_{ij}U^T_{jk}-\delta_{ik}}{\partial U_{mn}} \\
  0 &=& \sum_{mn}\frac{\partial\sum_{j}U_{ij}U_{kj}-\delta_{ik}}{\partial U_{mn}} \\
  0 &=& \sum_{mn}\left(\sum_{j}\delta_{im}\delta_{jn}U_{kj}
                      +\sum_{j}U_{ij}\delta_{km}\delta_{jn}\right) \\
  0 &=& \sum_{mn}\left(\delta_{im}U_{kn}+U_{in}\delta_{km}\right) \\
  0 &=& \left(\sum_n U_{kn}+\sum_n U_{in}\right)_{ik} 
\end{eqnarray}

\subsection{Electron entropy}

In the model we have described above there is a term that depends on the entropy
of the 2-electron density matrix. Some basic experiments show that the usual from
of the entropy expression leads to some unexpected unsymmetric results. Hence we
may need different entropy expressions. In fact, as the $\alpha$-$\alpha$ and the 
$\beta$-$\beta$ blocks of the 2-electron density matrix cannot be expressed in
terms of the $\alpha$ or $\beta$ occupation numbers, we may actually find that 
the entropy expression for the $\alpha$-$\alpha$ and the $\beta$-$\beta$ blocks
has to be different from the $\alpha$-$\beta$ and $\beta$-$\alpha$ blocks.
Either a more detailed study of how entropies can be derived or some experiments
of which entropy expressions work best will be needed to come to something 
sensible. In the meantime we will have to derive equations that are general
enough that we can easily substitute alternative entropy expressions.

Instead of the entropy used above another entropy that is used is the entanglement
entropy:
\begin{eqnarray}
   S_1(\rho_i)    &=& \rho_i\ln(\rho_i) \\
   S_2(\rho_{ij}) &=& \rho_{ij}\ln(\rho_{ij}) \\
   S              &=& S_1(\rho_i)+S_1(\rho_j)-S_2(\rho_{ij})
\end{eqnarray}
In this expression $\rho_i$ and $\rho_j$ are the 1-electron orbital occupations
associated with orbitals $i$ and $j$, whereas $\rho_{ij}$ is the 2-electron
occupation number of orbital pair $ij$.

In the case of the $\alpha$-$\beta$ 2-electron density matrix block the
entanglement entropy can be simplified as:
\begin{eqnarray}
   S_1(\rho^\sigma_i)            &=& \rho^\sigma_i\ln(\rho^\sigma_i) \\
   S_2(\rho^{\alpha\beta}_{ij})  &=& \rho^\alpha_i\rho^\beta_j\ln(\rho^\alpha_i\rho^\beta_j) \\
   S(\rho^\alpha_i,\rho^\beta_j) &=& S_1(\rho^\alpha_i)+S_1(\rho^\beta_j)-S_2(\rho^\alpha_i\rho^\beta_j)
\end{eqnarray}
The derivatives of these expressions are:
\begin{eqnarray}
   \frac{\partial S_1(\rho^\sigma_i)}{\partial X}
   &=& \left[\ln(\rho^\sigma_i)+1\right]\frac{\partial\rho^\sigma_i}{\partial X} \\
   \frac{\partial S_2(\rho^\alpha_i,\rho^\beta_j)}{\partial X}
   &=& \left[\rho^\beta_j\ln(\rho^\alpha_i\rho^\beta_j)+\rho^\beta_j\right]
       \frac{\partial\rho^\alpha_i}{\partial X} \nonumber \\
   &+& \left[\rho^\alpha_j\ln(\rho^\alpha_i\rho^\beta_j)+\rho^\alpha_j\right]
       \frac{\partial\rho^\beta_i}{\partial X}
\end{eqnarray}

\subsection{Correlation model}

Overall the model for electron correlation for the $\alpha$-$\beta$ interactions
used here takes the form
\begin{eqnarray}
  E_2 &=& \sum_{ij} \langle ij | ij \rangle 
          \left(1-S(\rho^\alpha_i\rho^\beta_j)\right) \rho^\alpha_i\rho^\beta_j
\end{eqnarray}
where the factor $(1-S(\rho^\alpha,\rho^\beta))$ models the reduction in electron-electron repulsion
due to correlation, the last factor, $\rho^\alpha\rho^\beta$, is the 2-electron density matrix.

Differentiating the 2-electron energy with respect to the correlation coefficients we get
\begin{eqnarray}
  \frac{\partial E_2}{\partial C^{*\alpha}_{kr}}
  &=& \sum_{ij}\langle ij | ij \rangle \left[
          \left(1-S(\rho^\alpha_i\rho^\beta_j)\right)
          \left(\frac{\partial\rho^\alpha_i}{\partial C^{*\alpha}_{kr}}\right)\rho^\beta_j
        - \left(\frac{\partial S(\rho^\alpha_i\rho^\beta_j)}{\partial\rho^\alpha_i}\right)
          \left(\frac{\partial \rho^\alpha_i}{\partial C^{*\alpha}_{kr}}\right)
          \rho^\alpha_i\rho^\beta_j
      \right]
\end{eqnarray}

\subsection{Hydrogen molecule: comparison Full-CI and WFN1S}

\subsubsection{Scaling the 2-electron interaction}

If we take a hydrogen molecule and describe this system in a two orbital basis set then
we can the total energies. From such an comparison we should be able to work out what we need
to do to recover the correct energy. 

First of all in this simple representation there are only two orbitals which are fixed by
symmetry. These orbitals are the bonding and the anti-bonding orbitals, and assuming we 
have hydrogen atoms $A$ and $B$ these orbitals are
\begin{eqnarray}
   \phi_1(r) &=& (\chi_A(r)+\chi_B(r))/\sqrt{2} \\
   \phi_2(r) &=& (\chi_A(r)-\chi_B(r))/\sqrt{2} 
\end{eqnarray}
In terms of these orbitals we can write down the Full-CI wave function as a sum of
Slater determinants. Although, because we have only 1 $\alpha$-electron and 1 $\beta$-electron
it is actually sufficient to just list Hartree products.
\begin{eqnarray}
   \Psi &=& C_{11}\phi^\alpha_1(r_1)\phi^\beta_1(r_2)
         +  C_{12}\phi^\alpha_1(r_1)\phi^\beta_2(r_2)
         +  C_{21}\phi^\alpha_2(r_1)\phi^\beta_1(r_2)
         +  C_{22}\phi^\alpha_2(r_1)\phi^\beta_2(r_2)
\end{eqnarray}
By symmetry we have that $C_{12} = C_{21} = 0$. Furthermore because the wave function must be
normalized we have
\begin{eqnarray}
   1 &=& C_{11}^2+C_{22}^2
\end{eqnarray}
Hence $C_{22} = \pm \sqrt{1-C_{11}^2}$. Ultimately the 2-electron contribution to the total
energy can be written as $\tr(R,D)$ where $R$ is the matrix of 2-electron repulsion integrals,
$D$ is the 2-electron density matrix.
The electron repulsion matrix is
\begin{eqnarray}
   R &=& 
   \begin{pmatrix}
   \eria{1}{1}{1}{1} & \eria{1}{1}{1}{2} & \eria{1}{1}{2}{1} & \eria{1}{1}{2}{2} \\
   \eria{1}{2}{1}{1} & \eria{1}{2}{1}{2} & \eria{1}{2}{2}{1} & \eria{1}{2}{2}{2} \\
   \eria{2}{1}{1}{1} & \eria{2}{1}{1}{2} & \eria{2}{1}{2}{1} & \eria{2}{1}{2}{2} \\
   \eria{2}{2}{1}{1} & \eria{2}{2}{1}{2} & \eria{2}{2}{2}{1} & \eria{2}{2}{2}{2}
   \end{pmatrix} 
\end{eqnarray}
where $\eria{i}{j}{k}{l} = \reria{i}{j}{k}{l} = \int \phi_i^\alpha(r_1)\phi_j^\beta(r_2)\frac{1}{r_{12}}{\phi_k^\alpha}^*(r_1){\phi_l^\beta}^*(r_2)\mathrm{d}r_1\mathrm{d}r_2$.
Of course, because we are dealing with a 2-electron closed shell system electron 1 has $\alpha$-spin and
electron 2 has $\beta$-spin. I.e. $\langle i^\alpha j^\beta|k^\alpha l^\beta \rangle = 
(i^\alpha k^\alpha |j^\beta l^\beta)$.
The corresponding Full-CI 2-electron density matrix
\begin{eqnarray}
   D &=& 
   \begin{pmatrix}
   C_{11}^2     & 0 & 0 & C_{11}C_{22} \\
   0            & 0 & 0 & 0            \\
   0            & 0 & 0 & 0            \\
   C_{22}C_{11} & 0 & 0 & C_{22}^2
   \end{pmatrix}
   \label{eq:fci_h2}
\end{eqnarray}
By contrast, within the WFN1 approach the 2-electron density matrix in this case is constructed from the
1-electron density matrices. The 1-electron density matrix is constructed from the correlation functions.
The correlation functions are given by
\begin{eqnarray}
   \psi^\sigma(r_1)
        &=& c^\sigma_{1}\phi^\sigma_1(r_1)
         +  c^\sigma_{2}\phi^\sigma_2(r_1)
\end{eqnarray}
The corresponding 1-electron density matrix is
\begin{eqnarray}
   d &=& 
   \begin{pmatrix}
   \left.c_{1}^\sigma\right.^2 & 0                           \\
   0                           & \left.c_{2}^\sigma\right.^2
   \end{pmatrix} \\
   &=& 
   \begin{pmatrix}
   p_{1}^\sigma & 0            \\
   0            & p_{2}^\sigma
   \end{pmatrix}
\end{eqnarray}
and the 2-electron density matrix \textcolor{red}{This analysis is only true for closed shell systems where
the $\alpha$ and $\beta$ 1-electron density matrices are the same.}
\begin{eqnarray}
   D &=& 
   \begin{pmatrix}
   p_1^\alpha p_1^\beta  & 0                    & 0                    & 0                    \\
   0                     & p_1^\alpha p_2^\beta & 0                    & 0                    \\
   0                     & 0                    & p_2^\alpha p_1^\beta & 0                    \\
   0                     & 0                    & 0                    & p_2^\alpha p_2^\beta
   \end{pmatrix}
   \label{eq:wfn1_h2}
\end{eqnarray}
Clearly Eqs.~\ref{eq:fci_h2} and~\ref{eq:wfn1_h2} are very different except when 
$c_1^\alpha = c_1^\beta = 1$ and $C_{11} = 1$
(which implies that both $c_2^\alpha = c_2^\beta = 0$ and $C_{22} = 0$). To address this problem we 
will modify the 2-electron interaction in the WFN1 model to $\tr(R,SD)$ where the matrix $S$ is given by
\begin{eqnarray}
   S &=& 
   \begin{pmatrix}
   1            & 0                & 0                & 0            \\
   0            & 1-T(p_1^\alpha,p_2^\alpha,p_1^\beta,p_2^\beta) & 0                & 0            \\
   0            & 0                & 1-T(p_1^\alpha,p_2^\alpha,p_1^\beta,p_2^\beta) & 0            \\
   0            & 0                & 0                & 1          
   \end{pmatrix}
   \label{eq:wfn1_t}
\end{eqnarray}
and then we want to solve $\tr(R,D_{FCI})=\tr(R,SD_{WFN1})$ for $T$.
\begin{eqnarray}
  &&\langle 11|11 \rangle C_{11}^2 + 2 \langle 11|22 \rangle C_{11}C_{22} + \langle 22|22 \rangle C_{22}^2
    \nonumber \\
  &&= \langle 11|11 \rangle p_1^\alpha p_1^\beta + (1-T)\langle 12|12 \rangle p_1^\alpha p_2^\beta
    +  (1-T)\langle 21|21 \rangle p_2^\alpha p_1^\beta + \langle 22|22 \rangle p_2^\alpha p_2^\beta 
\end{eqnarray}
\begin{eqnarray}
  &&T\left(\langle 12|12 \rangle p_1^\alpha p_2^\beta+
           \langle 21|21 \rangle p_2^\alpha p_1^\beta\right) \nonumber \\
  &&=  \langle 11|11 \rangle \left(p_1^\alpha p_1^\beta-C_{11}^2\right)
    +  \langle 12|12 \rangle p_1^\alpha p_2^\beta
    +  \langle 21|21 \rangle p_2^\alpha p_1^\beta
    +  \langle 22|22 \rangle \left(p_2^\alpha p_2^\beta-C_{22}^2\right)
    - 2 \langle 11|22 \rangle C_{11}C_{22} 
\end{eqnarray}
\begin{eqnarray}
  T &=& \frac{
             \langle 11|11 \rangle \left(p_1^\alpha p_1^\beta-C_{11}^2\right)
         +   \langle 12|12 \rangle p_1^\alpha p_2^\beta
         +   \langle 21|21 \rangle p_2^\alpha p_1^\beta
         +   \langle 22|22 \rangle \left(p_2^\alpha p_2^\beta-C_{22}^2\right)
         - 2 \langle 11|22 \rangle C_{11}C_{22}
        }{
         \langle 12|12 \rangle p_1^\alpha p_2^\beta+\langle 21|21 \rangle p_2^\alpha p_1^\beta
        }
\end{eqnarray}
To use this expression in real calculations some approximations are needed
(for one, because we do not have the Full-CI wavefunction). Also note
that the denominator contains factors $p_1^\sigma p_2^{\sigma'}$ which can go to zero.
These factors do not pose a problem to the overall model as they cancel the
same factors from the 2-electron density matrix. 

For \ce{H2} in a minimal basis we have that 
\begin{eqnarray}
C_{11}^2 &=& p_{1}^\sigma \\
         &=& \sqrt{p_1^\alpha p_1^\beta} \\
         &=& \frac{1}{2}\left(p_1^\alpha + p_1^\beta\right)
\end{eqnarray}
all three options given above are equally valid for this system.
$\langle 12|12 \rangle = \langle 21|21 \rangle$, and
$C_{11}C_{22} = \pm \sqrt{c_1^2c_2^2}$. Using these relationships
we have
\begin{eqnarray}
  T &\approx& \frac{
             \langle 11|11 \rangle \left(c_1^2c_1^2-c_1^2\right)
         + 2 \langle 12|12 \rangle c_1^2c_2^2
         +   \langle 22|22 \rangle \left(c_2^2c_2^2-c_2^2\right)
         \pm 2 \langle 11|22 \rangle \sqrt{c_1^2c_2^2}
        }{
         2 \langle 12|12 \rangle c_1^2c_2^2
       } \\
  T &\approx&
         \left(
           \frac{1}{2}\frac{\langle 11|11 \rangle}{\langle 12|12 \rangle} \left(c_1^2c_1^2-c_1^2\right)
         + \frac{\langle 12|12 \rangle}{\langle 12|12 \rangle} c_1^2c_2^2
         + \frac{1}{2}\frac{\langle 22|22 \rangle}{\langle 12|12 \rangle} \left(c_2^2c_2^2-c_2^2\right)
         \pm \frac{\langle 11|22 \rangle}{\langle 12|12 \rangle} \sqrt{c_1^2c_2^2}
         \right)\left(\frac{1}{c_1^2c_2^2}\right)
\end{eqnarray}
Of course we also have that the occupation numbers $p_1$ and $p_2$ can be expressed as
$p_1 = c_1^2$ and $p_2 = c_2^2$. Substituting these relations gives
\begin{eqnarray}
  T &\approx&
         \left(
           \frac{1}{2}\frac{\langle 11|11 \rangle}{\langle 12|12 \rangle} \left(p_1^2-p_1\right)
         + p_1 p_2
         + \frac{1}{2}\frac{\langle 22|22 \rangle}{\langle 12|12 \rangle} \left(p_2^2-p_2\right)
         \pm \frac{\langle 11|22 \rangle}{\langle 12|12 \rangle} \sqrt{p_1 p_2}
         \right)\left(\frac{1}{p_1 p_2}\right)
         \label{Eq:T_raw}
\end{eqnarray}
Because we need to maximize $T$ to maximize the electron correlation to minimize the total energy,
and assuming that all 2-electron integrals are non-negative, we have that we need to select
the $+$ from the $\pm$ sign.

Note that Eq.~\ref{Eq:T_raw} is only valid for 2-electron systems with 1 $\alpha$- and 1
$\beta$-electron, represented in 2 orbitals. This means that the normalization condition
$p_1=1-p_2$ prevents both $p_1$ and $p_2$ being large (e.g. 1) at the same time. Both $p_1$ and
$p_2$ being $1$ would maximize Eq.~\ref{Eq:T_raw} whereas two fully occupied orbitals are
both uncorrelated and certainly uncorrelated with each other. Hence we need to find a way to
bake the constraint $p_1=1-p_2$ into expression Eq.~\ref{Eq:T_raw} to ensure it remains correct
for 2-electron systems, but also can be applied to systems with more electrons without 
becoming unphysical.

One trick we can play is
\begin{eqnarray}
 p_1 &=& \sqrt{p_1^2} \\
     &=& \sqrt{p_1(1-p_2)} 
\end{eqnarray}
In a scenario where we are interested in products of $p_1$ and $p_2$ this leads to
\begin{eqnarray}
  p_1p_2 &=& \sqrt{p_1^2p_2^2} \\
         &=& \sqrt{p_1(1-p_2)p_2(1-p_1)} \\
         &=& \sqrt{[p_1(1-p_1)][p_2(1-p_2)]}
\end{eqnarray}
without introducing any approximations for 2-electron systems in 2 orbitals ($p_1=1-p_2$
is an approximation for systems with more than 2 electrons and more than 2 orbitals). 
Likewise
\begin{eqnarray}
  p_1^2-p_1 &=& -(p_1-p_1^2) \\
            &=& -\sqrt{(p_1-p_1^2)^2} \\
            &=& -\sqrt{(p_1-p_1^2)(1-p_2-[1-p_2]^2)} \\
            &=& -\sqrt{(p_1-p_1^2)(1-p_2-[1-2p_2+p_2^2])} \\
            &=& -\sqrt{(p_1-p_1^2)(p_2-p_2^2)} 
\end{eqnarray}

\subsubsection{Subtracting the 2-electron interaction}

A different approach is to compare the 2-electron interaction as
\begin{eqnarray}
   T &=& E_{FullCI}-E_{WFN1S} \\
   E_{FullCI} &=& E_{WFN1S}+T
\end{eqnarray}
Then we have
\begin{eqnarray}
   E_{FullCI} &=& \eria{1}{1}{1}{1} C_{11}^2 + \eria{1}{1}{2}{2} C_{11}C_{22}^*
               +  \eria{2}{2}{1}{1} C_{22}C_{11}^* + \eria{2}{2}{2}{2} C_{22}^2 \\
   E_{WFN1S}  &=& \eria{1}{1}{1}{1} p_1^\alpha p_1^\beta + \eria{1}{2}{1}{2} p_1^\alpha p_2^\beta
               +  \eria{2}{1}{2}{1} p_2^\alpha p_1^\beta + \eria{2}{2}{2}{2} p_2^\alpha p_2^\beta \\
   T
   &=& \eria{1}{1}{1}{1} (C_{11}^2-p_1^\alpha p_1^\beta)
    +  \eria{2}{2}{2}{2} (C_{22}^2-p_2^\alpha p_2^\beta) \nonumber \\
   &&+ \eria{1}{1}{2}{2} C_{11}C_{22}^*
    +  \eria{2}{2}{1}{1} C_{22}C_{11}^*       \nonumber \\
   &&- \eria{1}{2}{1}{2} p_1^\alpha p_2^\beta
    -  \eria{2}{1}{2}{1} p_2^\alpha p_1^\beta 
   \label{Eq:T_subtract}
\end{eqnarray}
As before we can equate the Full-CI coefficients to
\begin{eqnarray}
C_{11}^2 &=& p_{1}^\sigma \\
         &=& \sqrt{p_1^\alpha p_1^\beta} \\
         &=& \frac{p_1^\alpha + p_1^\beta}{2}
\end{eqnarray}
Based on this we also have that
\begin{eqnarray}
C_{11} &=& \pm\sqrt{p_{1}^\sigma} \\
       &=& \pm\sqrt[4]{p_1^\alpha p_1^\beta} \\
       &=& \pm\sqrt{\frac{p_1^\alpha + p_1^\beta}{2}}
\end{eqnarray}
Obviously in Eq.~\ref{Eq:T_subtract} we have to choose the sign of $C_{11}C_{22}$ so as to minimize
the Full-CI energy. If we now insert the geometric mean approach into Eq.~\ref{Eq:T_subtract} we have
\begin{eqnarray}
   T
   &=& \eria{1}{1}{1}{1} (\sqrt{p_1^\alpha p_1^\beta}-p_1^\alpha p_1^\beta)
    +  \eria{2}{2}{2}{2} (\sqrt{p_2^\alpha p_2^\beta}-p_2^\alpha p_2^\beta) \nonumber \\
   &&- \eria{1}{1}{2}{2} \sqrt[4]{p_1^\alpha p_1^\beta p_2^\alpha p_2^\beta}
    -  \eria{2}{2}{1}{1} \sqrt[4]{p_2^\alpha p_2^\beta p_1^\alpha p_1^\beta} \nonumber \\
   &&- \eria{1}{2}{1}{2} p_1^\alpha p_2^\beta
    -  \eria{2}{1}{2}{1} p_2^\alpha p_1^\beta 
   \label{Eq:T_subtract_2}
\end{eqnarray}
Next we need to test what happens if one of the orbitals is not correlated. I.e. $T$ should be $0$ for all
cases listed in Table~\ref{Table:T_subtract_occ}.
\begin{table}
\begin{tabular}{cccc|c}
\hline
$p_1^\alpha$ & $p_1^\beta$ & $p_2^\alpha$ & $p_2^\beta$ & $T$ \\
\hline
0            & 0           & 0            & 0           &  0  \\
0            & 0           & 0            & 1           &  0  \\
0            & 0           & 1            & 0           &  0  \\
0            & 1           & 0            & 0           &  0  \\
1            & 0           & 0            & 0           &  0  \\
0            & 0           & 1            & 1           &  0  \\
0            & 1           & 0            & 1           &  0  \\
1            & 0           & 0            & 1           &  $T_5$   \\
0            & 1           & 1            & 0           &  $T_6$   \\
1            & 0           & 1            & 0           &  0  \\
1            & 1           & 0            & 0           &  0  \\
0            & 1           & 1            & 1           &  $T_6$   \\
1            & 0           & 1            & 1           &  $T_5$   \\
1            & 1           & 0            & 1           &  $T_5$   \\
1            & 1           & 1            & 0           &  $T_6$   \\
1            & 1           & 1            & 1           &  $T_{3-6}$  \\
\hline
\end{tabular}
\caption{Occupation numbers for which $T$ must be zero. The column $T$ lists
         the terms of Eq.~\ref{Eq:T_subtract_2} that remain non-zero.}
\label{Table:T_subtract_occ}
\end{table}
Note that the terms $T_1$ and $T_2$ are not problematic. Both these terms are actually non-negative 
and therefore raise the energy instead of lowering it. Hence minimizing the total energy will tend
to miminize these terms. Therefore the important terms to deal with are the terms $T_3$ to $T_6$.
To address these terms there are two important relationships that hold for the closed shell 
2-electron molecules in a two orbital basis:
\begin{eqnarray}
  p_i^\sigma &=& 1-p_j^\sigma \\
  p_i^\sigma &=& p_i^{\sigma'}
\end{eqnarray}
Using these relationships one can replace the following quantity as
\begin{eqnarray}
  p_1^\alpha p_2^\beta 
  &=& \sqrt{p_1^\alpha p_1^\alpha p_2^\beta p_2^\beta} \\
  &=& \sqrt{p_1^\alpha(1-p_2^\alpha)p_2^\beta(1-p_1^\beta)} \\
  &=& \sqrt{p_1^\alpha(1-p_2^\beta)p_2^\beta(1-p_1^\alpha)} \\
  &=& \sqrt{p_1^\alpha(1-p_1^\alpha)p_2^\beta(1-p_2^\beta)}
\end{eqnarray}
likewise
\begin{eqnarray}
  p_1^\beta p_2^\alpha 
  &=& \sqrt{p_1^\beta(1-p_1^\beta)p_2^\alpha(1-p_2^\alpha)}
\end{eqnarray}
and
\begin{eqnarray}
  \sqrt[4]{p_1^\alpha p_1^\beta p_2^\alpha p_2^\beta}
  &=& \sqrt[4]{p_1^\alpha (1-p_2^\beta)(1-p_1^\alpha)p_2^\beta} \\
  &=& \sqrt[4]{p_1^\alpha (1-p_1^\alpha) p_2^\beta (1-p_2^\beta)} \\
  &=& \sqrt[4]{p_1^\beta (1-p_1^\beta) p_2^\alpha (1-p_2^\alpha)}
\end{eqnarray}
Using the relationships above in the expression for $T$ we may obtain
\begin{eqnarray}
   T
   &=& \eria{1}{1}{1}{1} \left(\sqrt{p_1^\alpha p_1^\beta}-p_1^\alpha p_1^\beta\right)
    +  \eria{2}{2}{2}{2} \left(\sqrt{p_2^\alpha p_2^\beta}-p_2^\alpha p_2^\beta\right) \nonumber \\
   &&- \eria{1}{1}{2}{2} \sqrt[4]{p_1^\alpha (1-p_1^\alpha) p_2^\beta (1-p_2^\beta)}
    -  \eria{2}{2}{1}{1} \sqrt[4]{p_2^\alpha (1-p_2^\alpha) p_1^\beta (1-p_1^\beta)} \nonumber \\
   &&- \eria{1}{2}{1}{2} \sqrt{p_1^\alpha (1-p_1^\alpha) p_2^\beta (1-p_2^\beta)}
    -  \eria{2}{1}{2}{1} \sqrt{p_2^\alpha (1-p_2^\alpha) p_1^\beta (1-p_1^\beta)}
   \label{Eq:T_subtract_3}
\end{eqnarray}

An important question related to extending this approximation to system with more
electrons or more basis functions is how to do this. In the system studied thus
far we have assumed only 2 spatial orbitals. In any realistic system there will likely
be more orbitals. The fact that thus far we have only considered 2 orbital systems
imposes a balance between the different terms in $T$. For example, in a 2 orbital system
there are equally many $ii$ as $ij$ terms. For a system with more than two orbitals the
number of $ij$ terms goes as $N^2$ whereas the number of $ii$ terms goes as $N$. 

To deal with the situation sketched above we break $T$ apart into different terms.
First of all there are the diagonal terms $ii$:
\begin{eqnarray}
   T_{ii} &=&  \eria{i}{i}{i}{i} \left(\sqrt{p_i^\alpha p_i^\beta}-p_i^\alpha p_i^\beta\right)
\end{eqnarray}
then there are the $ij$ terms where $i \ne j$:
\begin{eqnarray}
   T_{ij} &=&  -\eria{i}{i}{j}{j} \sqrt[4]{p_i^\alpha(1-p_i^\alpha) p_j^\beta(1-p_j^\beta)} \nonumber \\
          &-& \eria{i}{j}{i}{j} \sqrt{p_i^\alpha(1-p_i^\alpha) p_j^\beta(1-p_j^\beta)}
\end{eqnarray}

Next we need to consider the derivatives of the expressions for $T_{ii}$ and $T_{ij}$. 
The occupation numbers featuring in these expressions depend on the correlation functions only,
whereas the 2-electron integrals appearing in these expressions depend on the natural orbitals.
For $T_{ii}$ we need to consider 2 $\alpha$-electron derivative expressions:
\begin{eqnarray}
   \frac{\partial T_{ii}}{\partial \left.N_{ek}^\alpha\right.^*}
   &=& \left(\sqrt{p_i^\alpha p_i^\beta}-p_i^\alpha p_i^\beta\right)
       \frac{\partial \eria{i}{i}{i}{i}}{\partial \left.N_{ek}^\alpha\right.^*} \\
   &=& \left(\sqrt{p_i^\alpha p_i^\beta}-p_i^\alpha p_i^\beta\right)
       \sum_{a,b,c,d}\eria{a}{b}{c}{d}
       \frac{\partial N_{ai}^\alpha N_{ci}^{\alpha*}N_{bi}^\beta N_{di}^{\beta*}}
            {\partial \left.N_{ek}^\alpha\right.^*} \\
   &=& \left(\sqrt{p_i^\alpha p_i^\beta}-p_i^\alpha p_i^\beta\right)
       \sum_{a,b,c,d}\eria{a}{b}{c}{d}
       N_{ai}^\alpha N_{bi}^\beta N_{di}^{\beta*}\delta_{ce}\delta_{ik} \\
   &=& \left(\sqrt{p_k^\alpha p_k^\beta}-p_k^\alpha p_k^\beta\right)
       \sum_{a,b,d}\eria{a}{b}{e}{d}
       N_{ak}^\alpha N_{bk}^\beta N_{dk}^{\beta*}\delta_{ik} \\
   \frac{\partial T_{ii}}{\partial \left.C_{kr}^\alpha\right.^*}
   &=& \eria{i}{i}{i}{i}
       \frac{\partial\sqrt{p_i^\alpha p_i^\beta}-p_i^\alpha p_i^\beta}{\partial p_i^\alpha}
       \frac{\partial p_i^\alpha}{\partial\left.C_{kr}^\alpha\right.^*} \\
   &=& \eria{i}{i}{i}{i}
       \frac{\partial\sqrt{p_i^\alpha p_i^\beta}-p_i^\alpha p_i^\beta}{\partial p_i^\alpha}
       \frac{\partial \sum_s C_{is}^{\alpha}C_{is}^{\alpha*}}
            {\partial\left.C_{kr}^\alpha\right.^*} \\
   &=& \eria{i}{i}{i}{i}
       \frac{\partial\sqrt{p_i^\alpha p_i^\beta}-p_i^\alpha p_i^\beta}{\partial p_i^\alpha}
       \frac{\partial \sum_s C_{is}^{\alpha}C_{is}^{\alpha*}}
            {\partial\left.C_{kr}^\alpha\right.^*} \\
   &=& \eria{i}{i}{i}{i}
       \left(\frac{1}{2}\sqrt{\frac{p_i^\beta}{p_i^\alpha}}-p_i^\beta\right)
       C_{ir}^{\alpha}\delta_{ik}
\end{eqnarray}
and the 2 $\beta$-electron counter parts.
For $T_{ij}$ we get
\begin{eqnarray}
   \frac{\partial T_{ij} }{\partial \left.N_{ek}^\alpha\right.^*}
   &=&  -\frac{\partial\eria{i}{i}{j}{j}}{\partial \left.N_{ek}^\alpha\right.^*}
         \sqrt[4]{p_i^\alpha(1-p_i^\alpha) p_j^\beta(1-p_j^\beta)} \nonumber \\
   &&   -\frac{\partial\eria{i}{j}{i}{j}}{\partial \left.N_{ek}^\alpha\right.^*}
         \sqrt{p_i^\alpha(1-p_i^\alpha) p_j^\beta(1-p_j^\beta)} \\
   &=&  -\sum_{a,b,c,d}\eria{a}{b}{c}{d}
         \frac{\partial N_{ai}^\alpha N_{cj}^{\alpha*}N_{bi}^\beta N_{dj}^{\beta*}}
              {\partial \left.N_{ek}^\alpha\right.^*}
         \sqrt[4]{p_i^\alpha(1-p_i^\alpha) p_j^\beta(1-p_j^\beta)} \nonumber \\
   &&   -\sum_{a,b,c,d}\eria{a}{b}{c}{d}
         \frac{\partial N_{ai}^\alpha N_{ci}^{\alpha*}N_{bj}^\beta N_{dj}^{\beta*}}
              {\partial \left.N_{ek}^\alpha\right.^*}
         \sqrt{p_i^\alpha(1-p_i^\alpha) p_j^\beta(1-p_j^\beta)} \\
   &=&  -\sum_{a,b,c,d}\eria{a}{b}{c}{d}
         N_{ai}^\alpha N_{bi}^\beta N_{dj}^{\beta*}\delta_{ce}\delta_{jk}
         \sqrt[4]{p_i^\alpha(1-p_i^\alpha) p_j^\beta(1-p_j^\beta)} \nonumber \\
   &&   -\sum_{a,b,c,d}\eria{a}{b}{c}{d}
         N_{ai}^\alpha N_{bj}^\beta N_{dj}^{\beta*}\delta_{ce}\delta_{ik}
         \sqrt{p_i^\alpha(1-p_i^\alpha) p_j^\beta(1-p_j^\beta)} \\
   &=&  -\sum_{a,b,d}\eria{a}{b}{e}{d}
         N_{ai}^\alpha N_{bi}^\beta N_{dj}^{\beta*}\delta_{jk}
         \sqrt[4]{p_i^\alpha(1-p_i^\alpha) p_j^\beta(1-p_j^\beta)} \nonumber \\
   &&   -\sum_{a,b,d}\eria{a}{b}{e}{d}
         N_{ai}^\alpha N_{bj}^\beta N_{dj}^{\beta*}\delta_{ik}
         \sqrt{p_i^\alpha(1-p_i^\alpha) p_j^\beta(1-p_j^\beta)} \\
   \frac{\partial T_{ij}}{\partial \left.C_{kr}^\alpha\right.^*}
   &=&  -\eria{i}{i}{j}{j} 
         \frac{\partial\sqrt[4]{p_i^\alpha(1-p_i^\alpha) p_j^\beta(1-p_j^\beta)}}
              {\partial p_i^\alpha}
         \frac{\partial p_i^\alpha}
              {\partial \left.C_{kr}^\alpha\right.^*}
         \nonumber \\
   &&   -\eria{i}{j}{i}{j}
         \frac{\sqrt{p_i^\alpha(1-p_i^\alpha) p_j^\beta(1-p_j^\beta)}}
              {\partial p_i^\alpha}
         \frac{\partial p_i^\alpha}
              {\partial \left.C_{kr}^\alpha\right.^*} \\
   &=&  -\frac{1}{4}\eria{i}{i}{j}{j} 
         \left[
             \sqrt[4]{\frac{1-p_i^\alpha}{\left(p_i^\alpha\right)^3}p_j^\beta(1-p_j^\beta)}
            -\sqrt[4]{\frac{p_i^\alpha}{\left(1-p_i^\alpha\right)^3}p_j^\beta(1-p_j^\beta)}
         \right]
         C_{ir}^{\alpha}\delta_{ik}
         \nonumber \\
   &&   -\frac{1}{2}\eria{i}{j}{i}{j}
         \left[
             \sqrt{\frac{1-p_i^\alpha}{p_i^\alpha}p_j^\beta(1-p_j^\beta)}
            -\sqrt{\frac{p_i^\alpha}{1-p_i^\alpha}p_j^\beta(1-p_j^\beta)}
         \right]
         C_{ir}^{\alpha}\delta_{ik} \\
\end{eqnarray}

{\bf WRONG:}
A problem with the equations given above is the cost of evaluating them. The $T_{ij}$ expressions
could be expressed in terms of $\alpha$ and $\beta$ 1-electron density matrix functions if the
$i = j$ were included. Trying to skip the $i = j$ terms requires an explicit loop over
both $i$ and $j$ driving the complexity of the algorithm to $O(N^6)$. We can reduce this 
complexity by including $i = j$ terms in $T_{ij}$ but then subtracting them again in the
$T'_{ii}$ terms. Here we have renamed $T_{ii}$ to $T'_{ii}$ to reflect the fact the total 
correlation energy no longer is $E=\sum_{ij}T_{ij}$ with the old definition of $T$ but now
$E=\sum_{ij}T_{ij}+\sum_i T'_{ii}$.
Then we can express the $T_{ij}$ terms as products of 1-electron density 
matrix functions. The $T'_{ii}$ contributions do require an explicit loop over $i$ (but not $j$)
and therefore have a complexity of $O(N^5)$.

With the above in mind the $T_{ij}$ expression becomes:
\begin{eqnarray}
   \forall_{i,j}\;
   T_{ij} &=&  -\eria{i}{i}{j}{j} \sqrt[4]{p_i^\alpha(1-p_i^\alpha) p_j^\beta(1-p_j^\beta)} \nonumber \\
          &&   -\eria{i}{j}{i}{j} \sqrt{p_i^\alpha(1-p_i^\alpha) p_j^\beta(1-p_j^\beta)}
\end{eqnarray}
whereas 
\begin{eqnarray}
  T'_{ii} &=&  \eria{i}{i}{i}{i} \left(\sqrt{p_i^\alpha p_i^\beta}-p_i^\alpha p_i^\beta\right)
               \nonumber \\
          &&  +\eria{i}{i}{i}{i} \sqrt[4]{p_i^\alpha(1-p_i^\alpha) p_i^\beta(1-p_i^\beta)}
               \nonumber \\
          &&  +\eria{i}{i}{i}{i} \sqrt{p_i^\alpha(1-p_i^\alpha) p_i^\beta(1-p_i^\beta)}
\end{eqnarray}

{\bf EXPLANATION:}
The idea outlined above is wrong because the first term of $T_{ij}$ contains integrals
that involve the electron "density" $\phi_i^\alpha\phi_j^{\alpha*}$ and 
$\phi_i^\beta\phi_j^{\beta*}$. These "densities" couple $i$ and $j$ factors meaning that
$\sqrt[4]{p_i^\alpha(1-p_i^\alpha)p_j^\beta(1-p_j^\beta)}$ cannot be split into 
factors $\sqrt[4]{p_i^\alpha(1-p_i^\alpha)}$ and $\sqrt[4]{p_j^\beta(1-p_j^\beta)}$.
As a result we always have to have an $O(N^6)$ loop unless we are willing to drop
the first term in $T_{ij}$ altogether. Whether we can afford to do this accuracy wise, is 
a big question.

{\bf WRONG AGAIN:}
We can still formulate this model at an $O(N^5)$ cost. Consider that we have two
types of terms. First there are the $T_{ii}$ terms and second are the $T_{ij}, i \ne j$
terms.

The $T_{ii}$ terms are given by 
\begin{eqnarray}
  T_{ii} &=& \eria{i}{i}{i}{i}\left(\sqrt{p_i^\alpha p_i^\beta}-p_i^\alpha p_i^\beta\right) 
\end{eqnarray}
To evaluate $T_{ii}$ at a cost of $O(N^5)$ we need to approach this like a 4-index 
transformation
\begin{eqnarray}
  T_{abci}^\beta         &=& \sum_d \eria{a}{b}{c}{d}N_{di}^{\beta *} \\
  T_{aici}^\beta         &=& \sum_b T_{abci}^\beta N_{bi}^{\beta} \\
  T_{aiii}^{\alpha\beta} &=& \sum_c T_{aici}^\beta N_{ci}^{\alpha *} \\
  T_{iiii}^{\alpha\beta} &=& \sum_a T_{aiii}^{\alpha\beta} N_{ai}^{\alpha} \\
  T_{ii}                 &=& T_{iiii}^{\alpha\beta}
                             \left(\sqrt{p_i^\alpha p_i^\beta}-p_i^\alpha p_i^\beta\right) 
\end{eqnarray}
The first transformation step is clearly an $O(N^5)$ step. After that the order of the
complexity goes down as there are increasingly fewer different indeces left.

The $T_{ij}$ terms need to be approached in a similar manner. However, because the
transformed integrals in the first and second term are different in nature we have
to evaluate these terms separately. 
The $T_{ij}$ expression is given by
\begin{eqnarray}
   T_{ij} &=&  -\eria{i}{i}{j}{j} \sqrt[4]{p_i^\alpha(1-p_i^\alpha) p_j^\beta(1-p_j^\beta)} \nonumber \\
          &&   -\eria{i}{j}{i}{j} \sqrt{p_i^\alpha(1-p_i^\alpha) p_j^\beta(1-p_j^\beta)}
\end{eqnarray}
To separate the terms we rewrite this expression as
\begin{eqnarray}
   T_{ij}       &=& -T_{ij}^{(4)} - T_{ij}^{(2)} \\
   T_{ij}^{(4)} &=& \eria{i}{i}{j}{j} \sqrt[4]{p_i^\alpha(1-p_i^\alpha) p_j^\beta(1-p_j^\beta)} \\
   T_{ij}^{(2)} &=& \eria{i}{j}{i}{j} \sqrt{p_i^\alpha(1-p_i^\alpha) p_j^\beta(1-p_j^\beta)}
\end{eqnarray}
where we have labelled the terms with the order of the roots involved. 
Analogous to the $T_{ii}$ terms we have for the first term of $T_{ij}$
\begin{eqnarray}
  T_{abcj}^{\beta(4)}       &=& \sum_d \eria{a}{b}{c}{d}   N_{dj}^{\beta *} \\
  T_{aicj}^{\beta(4)}       &=& \sum_b T_{abcj}^{\beta(4)} N_{bi}^{\beta} \\
  T_{aijj}^{\alpha\beta(4)} &=& \sum_c T_{aicj}^{\beta(4)} N_{cj}^{\alpha *} \\
  T_{iijj}^{\alpha\beta(4)} &=& \sum_a T_{aijj}^{\alpha\beta(4)} N_{ai}^{\alpha} \\
  T_{ij}^{(4)}              &=& T_{iijj}^{\alpha\beta(4)}
                                \sqrt[4]{p_i^\alpha(1-p_i^\alpha) p_j^\beta(1-p_j^\beta)}
\end{eqnarray}
for the second terms we have
\begin{eqnarray}
  T_{abcj}^{\beta(2)}       &=& \sum_d \eria{a}{b}{c}{d}   N_{dj}^{\beta *} \\
  T_{ajcj}^{\beta(2)}       &=& \sum_b T_{abcj}^{\beta(2)} N_{bj}^{\beta} \\
  T_{ajij}^{\alpha\beta(2)} &=& \sum_c T_{ajcj}^{\beta(2)} N_{ci}^{\alpha *} \\
  T_{ijij}^{\alpha\beta(2)} &=& \sum_a T_{ajij}^{\alpha\beta(2)} N_{ai}^{\alpha} \\
  T_{ij}^{(2)}              &=& T_{ijij}^{\alpha\beta(2)}
                                \sqrt{p_i^\alpha(1-p_i^\alpha) p_j^\beta(1-p_j^\beta)}
\end{eqnarray}

To optimize the energy we need derivative of the energy expression with respect to the
natural orbital coefficients and with respect to the correlation function coefficients.
Starting with the occupation number derivatives with respect to the correlation 
function coefficients we can look at the various factors.
First of all the occupation number of a particular natural orbital is given by
\begin{eqnarray}
   p_i^\alpha &=& \sum_{s=1}^{n_e}C_{is}^\alpha C_{is}^{*\alpha}
\end{eqnarray}
Differentiating this with respect to $C_{kr}^{*\alpha}$ we get
\begin{eqnarray}
   \frac{\partial p_i^\alpha}{\partial C_{kr}^{*\alpha}}
   &=& \sum_{s=1}^{n_e}C_{is}^\alpha \delta_{ki}\delta_{rs} \\
   &=& \left\{
       \begin{array}{l}
         C_{kr}^\alpha, r \le n_e \\
         0, r > n_e
       \end{array}
       \right.
\end{eqnarray}
For the square root of the occupation number we have
\begin{eqnarray}
   \frac{\partial \sqrt{p_i^\alpha}}{\partial C_{kr}^{*\alpha}}
   &=& \frac{\partial \sqrt{p_i^\alpha}}{\partial p_i^\alpha}
       \frac{\partial p_i^\alpha}{\partial C_{kr}^{*\alpha}} \\
   &=& \frac{1}{2\sqrt{p_i^\alpha}}\frac{\partial p_i^\alpha}{\partial C_{kr}^{*\alpha}}
\end{eqnarray}
For the factors in the $T_{ij}^{(2)}$ terms we have
\begin{eqnarray}
   \frac{\partial \sqrt{p_i^\alpha(1-p_i^\alpha)}}{\partial C_{kr}^{*\alpha}}
   &=& \frac{\partial \sqrt{p_i^\alpha(1-p_i^\alpha)}}{\partial p_i^\alpha}
       \frac{\partial p_i^\alpha}{\partial C_{kr}^{*\alpha}} \\
   &=& \frac{(1-p_i^\alpha)-p_i^\alpha}{2\sqrt{p_i^\alpha(1-p_i^\alpha)}}
       \frac{\partial p_i^\alpha}{\partial C_{kr}^{*\alpha}} \\
   &=& \frac{1-2p_i^\alpha}{2\sqrt{p_i^\alpha(1-p_i^\alpha)}}
       \frac{\partial p_i^\alpha}{\partial C_{kr}^{*\alpha}}
\end{eqnarray}
For the factors in the $T_{ij}^{(4)}$ terms we have
\begin{eqnarray}
   \frac{\partial \sqrt[4]{p_i^\alpha(1-p_i^\alpha)}}{\partial C_{kr}^{*\alpha}}
   &=& \frac{\partial \sqrt[4]{p_i^\alpha(1-p_i^\alpha)}}{\partial p_i^\alpha}
       \frac{\partial p_i^\alpha}{\partial C_{kr}^{*\alpha}} \\
   &=& \frac{(1-p_i^\alpha)-p_i^\alpha}{4\sqrt[4]{p_i^\alpha(1-p_i^\alpha)}^3}
       \frac{\partial p_i^\alpha}{\partial C_{kr}^{*\alpha}} \\
   &=& \frac{1-2p_i^\alpha}{4\sqrt[4]{p_i^\alpha(1-p_i^\alpha)}^3}
       \frac{\partial p_i^\alpha}{\partial C_{kr}^{*\alpha}}
\end{eqnarray}

Next we need to consider the derivatives with respect to the natural orbital
coefficients. In these derivative expressions the factors depending on the occupation
numbers are constants. However, the indeces that feature in them are relevant
because they are affected by differentiation through the delta-functions that are
introduced. Hence, we first name these constants as
\begin{eqnarray}
   P_{ii}
   &=& P_{i^\alpha i^\beta} \\
   &=& \sqrt{p_i^\alpha p_i^\beta} - p_i^\alpha p_i^\beta \\
   P^{(2)}_{ij}
   &=& P^{(2)}_{i^\alpha j^\beta} \\
   &=& \sqrt{p_i^\alpha(1-p_i^\alpha)p_j^\beta(1-p_j^\beta)} \\
   P^{(4)}_{ij}
   &=& P^{(4)}_{i^\alpha j^\beta} \\
   &=& \sqrt[4]{p_i^\alpha(1-p_i^\alpha)p_j^\beta(1-p_j^\beta)} \\
\end{eqnarray}
With the expressions above we can rephrase the energy terms as
\begin{eqnarray}
  T_{ii} 
  &=& \eria{i}{i}{i}{i}P_{ii} \\
  T_{ij}
  &=& -\eria{i}{i}{j}{j}P^{(4)}_{ij} \nonumber \\
  &&  -\eria{i}{j}{i}{j}P^{(2)}_{ij} \\
  &=& -T^{(4)}_{ij}-T^{(2)}_{ij}
\end{eqnarray}
Next we differentiate the energy expressions with respect to the $\alpha$-electron
natural orbital coefficients. The derivatives with respect to the $\beta$-electron
natural orbital coefficients are the same just with $\alpha$ and $\beta$ interchanged.
Starting with $T_{ii}$ we have
\begin{eqnarray}
   \frac{\partial T_{ii}}{\partial N^{\alpha*}_{ek}}
   &=& \sum_c \eria{i}{i}{c}{i}P_{ii}
       \frac{\partial N^{\alpha*}_{ci}}{\partial N^{\alpha*}_{ek}} \\
   &=& \sum_c \eria{i}{i}{c}{i}P_{ii}\delta_{ce}\delta_{ik} \\
   &=& \eria{k}{k}{e}{k}P_{kk}
\end{eqnarray}
Likewise, differentiating $T^{(2)}_{ij}$ gives
\begin{eqnarray}
   \frac{\partial T^{(2)}_{ij}}{\partial N^{\alpha*}_{ek}}
   &=& \sum_c\eria{i}{j}{c}{j}P^{(2)}_{ij}
       \frac{\partial N^{\alpha*}_{ci}}{\partial N^{\alpha*}_{ek}} \\
   &=& \sum_c\eria{i}{j}{c}{j}P^{(2)}_{ij}\delta_{ce}\delta_{ik} \\
   &=& \eria{k}{j}{e}{j}P^{(2)}_{kj}
\end{eqnarray}
Finally, differentiating $T^{(4)}_{ij}$ gives
\begin{eqnarray}
   \frac{\partial T^{(4)}_{ij}}{\partial N^{\alpha*}_{ek}}
   &=& \sum_c\eria{i}{i}{c}{j}P^{(4)}_{ij}
       \frac{\partial N^{\alpha*}_{cj}}{\partial N^{\alpha*}_{ek}} \\
   &=& \sum_c\eria{i}{i}{c}{j}P^{(4)}_{ij}\delta_{ce}\delta_{jk} \\
   &=& \eria{i}{i}{e}{k}P^{(4)}_{ik}
\end{eqnarray}
Note that ultimately we want Fock matrices in the natural orbitals basis
for the natural orbital optimization. For this reason we transform the remaining
atomic orbital index to natural orbital index $l$ as in
\begin{eqnarray}
   F^{(ii)}_{kl}
   &=& \sum_e\eria{k}{k}{e}{k}P_{kk}N^{\alpha*}_{el} \\
   F^{(2,ij)}_{kl}
   &=& \sum_e\eria{k}{j}{e}{j}P^{(2)}_{kj}N^{\alpha*}_{el}
       \label{eq:F2ijkl} \\
   F^{(4,ij)}_{kl}
   &=& \sum_e\eria{i}{i}{e}{k}P^{(4)}_{ik}N^{\alpha*}_{el}
       \label{eq:F4ijkl} \\
\end{eqnarray}
Note that for the full Fock matrices of Eq.~\ref{eq:F2ijkl} and~\ref{eq:F4ijkl}
we still need to sum over $j \ne k$ and $i \ne k$ respectively.






\subsection{Hydrogen 4 molecule: comparison Full-CI and WFN1S}

If we place 4 hydrogen atoms represented with a minimal basis set in a square
we have another system with potentially strong correlation effects. In this case
we have 4 electrons, 2 $\alpha$-electrons and 2 $\beta$-electrons, and we have 4
orbitals. This makes for $4!/(2!2!)=6$ determinants per spin channel, and therefore
36 determinants in total. The orbitals can be depicted as show in Table~\ref{table:h4}.
\begin{table}
\begin{tabular}{cccc}
$\phi_1$ & $\phi_2$ & $\phi_3$ & $\phi_4$ \\
$\begin{array}{cc}
 + & + \\
 + & + \\
\end{array}$
&
$\begin{array}{cc}
 - & - \\
 + & + \\
\end{array}$
&
$\begin{array}{cc}
 - & + \\
 - & + \\
\end{array}$
&
$\begin{array}{cc}
 + & - \\
 - & + \\
\end{array}$
\end{tabular}
\label{table:h4}
\end{table}
The molecule has 4 mirror planes (2 running along the diagonal through 2 hydrogen atoms, and 2 
that run between the hydrogen atoms). The latter 2 mirror planes most clearly show that all
orbitals have a different symmetry. However, we can easily construct some kind of multiplication
table of the orbital symmetries.
\begin{table}
\begin{tabular}{cc|c}
\hline
$\phi_i$ & $\phi_j$ & $\phi_i*\phi_j=\phi_k$ \\
\hline
$\phi_1$ & $\phi_1$ & $\phi_1$ \\
$\phi_1$ & $\phi_2$ & $\phi_2$ \\
$\phi_1$ & $\phi_3$ & $\phi_3$ \\
$\phi_1$ & $\phi_4$ & $\phi_4$ \\
$\phi_2$ & $\phi_2$ & $\phi_1$ \\
$\phi_2$ & $\phi_3$ & $\phi_4$ \\
$\phi_2$ & $\phi_4$ & $\phi_3$ \\
$\phi_3$ & $\phi_3$ & $\phi_1$ \\
$\phi_3$ & $\phi_4$ & $\phi_2$ \\
$\phi_4$ & $\phi_4$ & $\phi_1$ \\
\hline
\end{tabular}
\end{table}
Hence we have the following Slater determinants 
contributing to the overall wavefunction:
$|12||12|$, $|13||13|$, $|14||14|$, $|23||23|$, $|24||24|$, $|34||34|$,
$|23||14|$, $|14||23|$, $|12||34|$, $|34||12|$, $|13||24|$, $|24||13|$
other determinants being of the wrong symmetry.


\bibliographystyle{unsrt}
\bibliography{WFN1,WFN1_alt}

\end{document}
